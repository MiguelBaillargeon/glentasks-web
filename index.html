<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GlenTasks | Gestion des Tâches</title>
  <meta name="description" content="GlenTasks - Gestion des tâches simple et efficace">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="GlenTasks">
  <meta name="theme-color" content="#3b82f6">
  
  <style>
    /* CSS Variables for consistent theming */
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      
      --radius-sm: 0.25rem;
      --radius: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: var(--gray-800);
      background: var(--gray-50);
      min-height: 100vh;
    }

    /* Password protection overlay */
    .password-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .password-container {
      background: white;
      padding: var(--space-8);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .password-header h1 {
      color: var(--primary);
      margin-bottom: var(--space-3);
      font-size: 2rem;
    }
    
    .password-header p {
      color: var(--gray-600);
      margin-bottom: var(--space-6);
    }
    
    .password-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .password-input {
      padding: var(--space-3);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      font-size: 1rem;
      text-align: center;
      transition: border-color 0.2s;
    }
    
    .password-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .password-submit {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .password-submit:hover {
      background: var(--primary-dark);
    }

    /* Main app container */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-4);
      display: none; /* Hidden until password is entered */
    }
    
    /* Header styles */
    header {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .app-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }
    
    .header-actions {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    
    /* Button styles */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    
    .btn-secondary:hover {
      background: var(--gray-200);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-sm {
      padding: var(--space-1) var(--space-3);
      font-size: 0.75rem;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Form styles */
    .form-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }
    
    .form-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-6);
      text-align: center;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-4);
    }
    
    .form-row {
      display: flex;
      flex-direction: column;
    }
    
    .form-row.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      font-size: 0.875rem;
    }
    
    .form-label.required::after {
      content: " *";
      color: var(--danger);
    }
    
    .form-input,
    .form-textarea {
      padding: var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Chip styles */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }
    
    .chip {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chip:hover {
      background: var(--gray-200);
    }

    .chip input[type="checkbox"],
    .chip input[type="radio"] {
      margin: 0;
    }

    .chip input[type="checkbox"]:checked + span,
    .chip input[type="radio"]:checked + span {
      color: var(--primary);
      font-weight: 500;
    }

    /* Submit button container */
    .submit-container {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: var(--space-4);
    }

    .submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--space-4) var(--space-8);
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 200px;
    }

    .submit-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .submit-btn:disabled {
      background: var(--gray-400);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }

    .submit-btn:disabled:hover {
      background: var(--gray-400);
      transform: none;
      box-shadow: none;
    }

    /* Controls and sorting */
    .controls-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    .control-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      font-size: 0.875rem;
    }

    .control-select {
      padding: var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
    }
    
    .control-input {
      padding: var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      background: white;
      transition: border-color 0.2s;
    }
    
    .control-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .control-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Task list */
    .tasks-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
    }

    .tasks-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
      margin: 0;
    }

    .tasks-stats {
      display: flex;
      gap: var(--space-4);
      align-items: center;
    }

    .tasks-count {
      background: var(--gray-100);
      color: var(--gray-600);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .unassigned-count {
      background: var(--warning);
      color: white;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 600;
      display: none;
    }

    /* Task card */
    .task-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      transition: all 0.2s ease-in-out;
      position: relative;
    }
    
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .task-card.completed {
      opacity: 0.7;
      background: var(--gray-50);
    }
    
    /* Unassigned task styling - simplified */
    .task-card.unassigned {
      border-left: 4px solid var(--warning);
      background: #fef3c7;
    }
    
    .task-card.unassigned:hover {
      background: linear-gradient(to right, #fde68a, white);
    }
    
    .unassigned-badge {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: var(--warning);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      z-index: 1;
      box-shadow: var(--shadow-sm);
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
      gap: var(--space-3);
    }
    
    .task-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-800);
      margin: 0;
      flex: 1;
      line-height: 1.4;
    }
    
    .task-actions {
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
    }
    
    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
      font-size: 0.875rem;
    }

    .task-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--gray-600);
    }

    .task-meta-item strong {
      color: var(--gray-700);
    }
    
    .text-muted {
      color: var(--gray-500);
      font-style: italic;
    }
    
    .text-warning {
      color: var(--warning);
      font-weight: 600;
    }
    
    .text-danger {
      color: var(--danger);
    }

    .task-description {
      color: var(--gray-600);
      margin-bottom: var(--space-3);
      line-height: 1.5;
    }

    .task-location {
      color: var(--gray-500);
      font-size: 0.875rem;
      margin-bottom: var(--space-3);
      font-style: italic;
    }

    /* Priority indicators */
    .priority-urgent {
      background: var(--danger);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-normal {
      background: var(--gray-500);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-critical {
      background: var(--warning);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Status indicators */
    .status-en-cours {
      background: var(--primary);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-termine {
      background: var(--success);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .app-container {
        padding: var(--space-3);
      }
      
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .app-title {
        font-size: 2rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .task-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .task-actions {
        align-self: flex-end;
      }
      
      .submit-container {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }
      
      .submit-container .btn {
        width: 100%;
        justify-content: center;
      }
      
      .password-container {
        margin: var(--space-4);
        padding: var(--space-6);
      }
      
      .password-header h1 {
        font-size: 1.75rem;
      }
    }

    /* Accessibility improvements */
    .btn:focus,
    .form-input:focus,
    .form-textarea:focus,
    .control-select:focus,
    .password-input:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    .chip input[type="checkbox"]:focus + span,
    .chip input[type="radio"]:focus + span {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Better touch targets for mobile */
    @media (max-width: 768px) {
      .btn {
        min-height: 44px;
        padding: var(--space-3) var(--space-4);
      }
      
      .chip {
        min-height: 44px;
        padding: var(--space-3) var(--space-4);
      }
      
      .task-actions .btn {
        min-width: 44px;
        min-height: 44px;
        justify-content: center;
      }
    }

    /* Loading and error states */
    .loading {
      text-align: center;
      padding: var(--space-8);
      color: var(--gray-600);
    }

    .loading-container {
      text-align: center;
      background: white;
      padding: var(--space-8);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: var(--space-4);
      border-radius: var(--radius);
      border: 1px solid #fecaca;
      margin: var(--space-4) 0;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--gray-500);
    }

    .empty-state h3 {
      color: var(--gray-600);
      margin-bottom: var(--space-2);
    }

    /* Animation for new tasks */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .task-card.new {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Smooth transitions for all interactive elements */
    .task-card,
    .btn,
    .form-input,
    .form-textarea,
    .control-select,
    .control-input,
    .chip {
      transition: all 0.2s ease-in-out;
    }
    
    /* Hover effects for better interactivity */
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Smooth filter transitions */
    .task-card {
      transition: opacity 0.3s ease, transform 0.3s ease, filter 0.3s ease;
    }
    
    .task-card.filtered-out {
      opacity: 0;
      transform: scale(0.95);
      filter: blur(1px);
    }
    
    /* Loading skeleton animation */
    @keyframes shimmer {
      0% {
        background-position: -200px 0;
      }
      100% {
        background-position: calc(200px + 100%) 0;
      }
    }
    
    .skeleton {
      background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
      background-size: 200px 100%;
      animation: shimmer 1.5s infinite;
    }
    
    .skeleton-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .skeleton-title {
      height: 24px;
      width: 80%;
      margin-bottom: var(--space-3);
      border-radius: var(--radius-sm);
    }
    
    .skeleton-description {
      height: 16px;
      width: 60%;
      margin-bottom: var(--space-3);
      border-radius: var(--radius-sm);
    }
    
    .skeleton-meta {
      height: 14px;
      width: 40%;
      border-radius: var(--radius-sm);
    }
    
    /* Animation for notifications */
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Search results styling */
    .search-info {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .search-results {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--gray-700);
      font-size: 0.875rem;
    }
    
    .search-results .btn {
      margin-left: var(--space-3);
    }
  </style>
</head>
<body>
  <!-- Password Protection Overlay -->
  <div id="passwordOverlay" class="password-overlay">
    <div class="password-container">
      <div class="password-header">
        <h1>🔐 GlenTasks</h1>
        <p>Entrez le mot de passe pour accéder à l'application</p>
      </div>
      <form class="password-form" id="passwordForm">
        <input 
          type="password" 
          id="passwordInput" 
          class="password-input" 
          placeholder="Mot de passe" 
          required
          autocomplete="current-password"
        >
        <button type="submit" class="password-submit">Accéder</button>
      </form>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="appContainer" class="app-container">
    <!-- Header -->
    <header>
      <div class="header-content">
        <h1 class="app-title">GlenTasks</h1>
        <div class="header-actions">
          <button id="exportCSV" class="btn btn-secondary">
            📊 Exporter CSV
          </button>
          <button id="addMockData" class="btn btn-secondary">
            🧪 Ajouter données test
          </button>
          <button id="clearMockData" class="btn btn-danger hidden">
            🗑️ Effacer données test
          </button>
          <button id="shareApp" class="btn btn-success">
            🔗 Partager
          </button>
        </div>
      </div>
    </header>

    <!-- Task Form -->
    <div class="form-card">
      <h2 class="form-title">Nouvelle Tâche</h2>
      <form id="cmvForm" novalidate>
        <input type="hidden" id="editId" value="">
        
        <div class="form-grid">
          <div class="form-row full-width">
            <label for="title" class="form-label required">Titre de la tâche</label>
            <input id="title" name="title" type="text" class="form-input" required placeholder="Que faut-il faire ?">
          </div>
          
          <div class="form-row full-width">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" name="description" class="form-input form-textarea" placeholder="Détails, instructions, contexte..."></textarea>
          </div>
          
          <div class="form-row">
            <label for="location" class="form-label">📍 Localisation</label>
            <textarea id="location" name="location" class="form-input" placeholder="Où se trouve la tâche ?"></textarea>
          </div>
          
          <div class="form-row">
            <label class="form-label">👥 Assignation</label>
            <div class="chip-group">
              <label class="chip"><input type="checkbox" name="who" value="Éric"> Éric</label>
              <label class="chip"><input type="checkbox" name="who" value="Fred"> Fred</label>
              <label class="chip"><input type="checkbox" name="who" value="Audrey"> Audrey</label>
              <label class="chip"><input type="checkbox" name="who" value="Lucas"> Lucas</label>
              <label class="chip"><input type="checkbox" name="who" value="Miguel"> Miguel</label>
              <label class="chip"><input type="checkbox" name="who" value="Autre"> Autre</label>
            </div>
          </div>
          
          <div class="form-row">
            <label class="form-label">🚨 Priorité</label>
            <div class="chip-group">
              <label class="chip"><input type="radio" name="urgent" value="Non" checked> Normal</label>
              <label class="chip"><input type="radio" name="urgent" value="Oui"> Urgent</label>
              <label class="chip"><input type="radio" name="urgent" value="Au PC !"> Critique</label>
            </div>
          </div>
          
          <div class="form-row">
            <label for="deadline" class="form-label">⏰ Échéance</label>
            <input id="deadline" name="deadline" type="date" class="form-input">
          </div>
          
          <div class="form-row full-width">
            <label for="files" class="form-label">📎 Fichiers</label>
            <input id="files" name="files" type="file" multiple class="form-input">
          </div>
        </div>
        
        <div class="submit-container">
          <button type="submit" class="submit-btn" id="submitBtn">
            💾 Enregistrer la tâche
          </button>
          <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none; margin-left: var(--space-3);">
            ❌ Annuler
          </button>
            </div>
      </form>
          </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="controls-grid">
        <div class="control-group">
          <label for="searchInput" class="control-label">🔍 Rechercher</label>
          <input 
            type="text" 
            id="searchInput" 
            class="control-input" 
            placeholder="Rechercher dans les tâches..."
          >
        </div>
        
        <div class="control-group">
          <label for="filterSelect" class="control-label">Filtrer par statut</label>
          <select id="filterSelect" class="control-select">
            <option value="all">Toutes les tâches</option>
            <option value="pending">En cours</option>
            <option value="done">Terminées</option>
            <option value="unassigned">Non assignées</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="sortSelect" class="control-label">Trier par</label>
          <select id="sortSelect" class="control-select">
            <option value="status">Statut</option>
            <option value="urgency">Priorité</option>
            <option value="deadline">Échéance</option>
            <option value="created">Date de création</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="employeeSelect" class="control-label">Filtrer par employé</label>
          <select id="employeeSelect" class="control-select">
            <option value="">Tous les employés</option>
            <option value="Éric">Éric</option>
            <option value="Fred">Fred</option>
            <option value="Audrey">Audrey</option>
            <option value="Lucas">Lucas</option>
            <option value="Miguel">Miguel</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        
        <div class="control-group">
          <button id="generateReport" class="btn btn-primary">
            📋 Générer Rapport
          </button>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="tasks-section">
      <div class="tasks-header">
        <h2 class="tasks-title">Liste des Tâches</h2>
        <div class="tasks-count" id="tasksCount">0 tâches</div>
      </div>
      
      <div id="taskList" class="task-list">
        <!-- Tasks will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <!-- JavaScript Section -->
  <script>
    // ============================================================================
    // GLOBAL VARIABLES AND CONSTANTS
    // ============================================================================
    
    // Password for app access (change this to your desired password)
    const APP_PASSWORD = "glen";
    
    // DOM elements - will be initialized after DOM loads
    let $passwordOverlay, $passwordForm, $passwordInput, $appContainer, $cmvForm, $taskList, $tasksCount;
    let $filterSelect, $sortSelect, $employeeSelect, $exportCSV, $addMockData, $clearMockData, $shareApp, $generateReport;
    
    // App state
    let currentFilter = 'all';
    let currentSort = 'status';
    let selectedEmployee = '';
    let isEditing = false;
    let editId = null;
    
    // Status weights for sorting
    const STATUS_WEIGHT = {
      "En cours": 1,
      "Terminé": 2
    };
    
    // ============================================================================
    // PASSWORD PROTECTION SYSTEM
    // ============================================================================
    
    // Check if user is already authenticated
    function checkAuthentication() {
      const isAuthenticated = sessionStorage.getItem('glentasks_authenticated');
      if (isAuthenticated === 'true') {
        showApp();
      }
    }
    
    // Handle password form submission
    function setupPasswordForm() {
      $passwordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const password = $passwordInput.value.trim();
        
        if (password === APP_PASSWORD) {
          sessionStorage.setItem('glentasks_authenticated', 'true');
          showApp();
          $passwordInput.value = '';
        } else {
          alert('Mot de passe incorrect. Veuillez réessayer.');
          $passwordInput.focus();
        }
      });
    }
    
    // Show the main app
    function showApp() {
      $passwordOverlay.style.display = 'none';
      $appContainer.style.display = 'block';
      initializeApp();
    }
    
    // ============================================================================
    // APP INITIALIZATION
    // ============================================================================
    
    // Initialize the app
    async function initializeApp() {
      try {
        console.log('Initializing GlenTasks app...');
        
        // Initialize database
        await initializeDatabase();
        
        // Set up event listeners
        setupEventListeners();
        
        // Load and display tasks
        await loadTasks();
        
        // Hide splash screen if in Capacitor
        if (window.Capacitor && window.Capacitor.Plugins.SplashScreen) {
          try {
            console.log('Attempting to hide splash screen...');
            await window.Capacitor.Plugins.SplashScreen.hide();
            console.log('Splash screen hidden successfully');
          } catch (error) {
            console.warn('Could not hide splash screen:', error);
            // Try alternative method
            try {
              await window.Capacitor.Plugins.SplashScreen.hide({ fadeOutDuration: 0 });
              console.log('Splash screen hidden with alternative method');
            } catch (altError) {
              console.warn('Alternative splash screen hide failed:', altError);
            }
          }
        }
        
        console.log('App initialization completed successfully');
        
      } catch (error) {
        console.error('App initialization failed:', error);
        alert('Failed to initialize app: ' + error.message);
        
        // Try to show some content even if database fails
        $taskList.innerHTML = '<div class="error">Erreur d\'initialisation: ' + error.message + '</div>';
        
        // Still try to hide splash screen even if app failed
        if (window.Capacitor && window.Capacitor.Plugins.SplashScreen) {
          try {
            await window.Capacitor.Plugins.SplashScreen.hide();
          } catch (splashError) {
            console.warn('Could not hide splash screen after error:', splashError);
          }
        }
      }
    }
    
    // ============================================================================
    // DATABASE INITIALIZATION
    // ============================================================================
    
    // Initialize the database
    async function initializeDatabase() {
      try {
        // Check if database exists, if not create it
        const existingData = localStorage.getItem('cmvDB');
        if (!existingData) {
          console.log('No existing database found, creating new one...');
          localStorage.setItem('cmvDB', JSON.stringify([]));
        }
        
        console.log('Database initialized successfully');
      } catch (error) {
        console.error('Database initialization failed:', error);
        throw new Error('Failed to initialize database: ' + error.message);
      }
    }
    
    // ============================================================================
    // DATA NORMALIZATION AND VALIDATION
    // ============================================================================
    
    // Normalize task data structure for consistency
    function normalizeTaskData(item) {
      return {
        id: item.id || Date.now() + Math.random(),
        title: item.title || item.task || 'Tâche sans titre',
        description: item.description || '',
        location: item.location || '',
        who: Array.isArray(item.who) ? item.who : (item.who ? [item.who] : []),
        urgent: item.urgent || 'Non',
        deadline: item.deadline || null,
        status: item.status || 'En cours',
        createdAt: item.createdAt || new Date().toISOString()
      };
    }
    
    // Validate task data before saving
    function validateTaskData(taskData) {
      const errors = [];
      
      if (!taskData.title || taskData.title.trim().length === 0) {
        errors.push('Le titre de la tâche est requis');
      }
      
      if (taskData.title && taskData.title.trim().length > 200) {
        errors.push('Le titre ne peut pas dépasser 200 caractères');
      }
      
      if (taskData.description && taskData.description.length > 1000) {
        errors.push('La description ne peut pas dépasser 1000 caractères');
      }
      
      if (taskData.deadline) {
        const deadlineDate = new Date(taskData.deadline);
        if (isNaN(deadlineDate.getTime())) {
          errors.push('Date d\'échéance invalide');
        }
      }
      
      return errors;
    }
    
    // ============================================================================
    // EVENT LISTENERS SETUP
    // ============================================================================
    
    // Set up all event listeners
    function setupEventListeners() {
      // Form submission
      $cmvForm.addEventListener('submit', handleFormSubmit);
      
      // Cancel edit button
      document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
      
      // Filter and sort changes
      $filterSelect.addEventListener('change', handleFilterChange);
      $sortSelect.addEventListener('change', handleSortChange);
      $employeeSelect.addEventListener('change', handleEmployeeChange);
      
      // Search input with debouncing
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          debouncedSearch(e.target.value);
        });
      }
      
      // Action buttons
      $exportCSV.addEventListener('click', exportToCSV);
      $addMockData.addEventListener('click', addMockData);
      $clearMockData.addEventListener('click', clearMockData);
      $shareApp.addEventListener('click', shareApp);
      $generateReport.addEventListener('click', generateReport);
      
      console.log('Event listeners set up successfully');
    }
    
    // ============================================================================
    // FORM HANDLING
    // ============================================================================
    
    // Reset form to initial state
    function resetForm() {
      $cmvForm.reset();
      document.getElementById('editId').value = '';
      isEditing = false;
      editId = null;
      document.getElementById('submitBtn').textContent = '💾 Enregistrer la tâche';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }
    
    // Handle form submission
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      try {
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '⏳ Enregistrement...';
        submitBtn.disabled = true;
        
        const formData = new FormData($cmvForm);
        const taskData = {
          title: formData.get('title').trim(),
          description: formData.get('description').trim(),
          location: formData.get('location').trim(),
          who: Array.from(formData.getAll('who')),
          urgent: formData.get('urgent'),
          deadline: formData.get('deadline'),
          status: 'En cours',
          createdAt: new Date().toISOString()
        };
        
        // Validation is now handled in addTask/updateTask functions
        
        // Save task using safe execution
        if (isEditing && editId) {
          await safeExecute(async () => {
            await updateTask(editId, taskData);
            return 'modifiée';
          }, 'task update');
          
          const action = 'modifiée';
          isEditing = false;
          editId = null;
          
          // Reset form and reload tasks
          resetForm();
          await safeExecute(loadTasks, 'task reload after update');
          
          // Show success message
          showSuccess(`Tâche ${action} avec succès !`);
        } else {
          await safeExecute(async () => {
            await addTask(taskData);
            return 'ajoutée';
          }, 'task creation');
          
          // Reset form and reload tasks
          resetForm();
          await safeExecute(loadTasks, 'task reload after creation');
          
          // Show success message
          const action = 'ajoutée';
          showSuccess(`Tâche ${action} avec succès !`);
        }
        
      } catch (error) {
        console.error('Form submission failed:', error);
        // Error is already handled by safeExecute
      } finally {
        // Restore button state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.textContent = isEditing ? '💾 Modifier la tâche' : '💾 Enregistrer la tâche';
        submitBtn.disabled = false;
      }
    }
    
    // ============================================================================
    // TASK MANAGEMENT FUNCTIONS
    // ============================================================================
    
    // Add a new task
    async function addTask(taskData) {
      try {
        // Sanitize input data
        const sanitizedData = sanitizeTaskData(taskData);
        
        // Validate data before saving
        const validationErrors = validateTaskData(sanitizedData);
        if (validationErrors.length > 0) {
          throw new Error('Données invalides: ' + validationErrors.join(', '));
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const normalizedTask = normalizeTaskData(sanitizedData);
        
        items.push(normalizedTask);
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        console.log('Task added successfully:', normalizedTask);
        return normalizedTask;
      } catch (error) {
        console.error('Failed to add task:', error);
        throw new Error('Failed to add task: ' + error.message);
      }
    }
    
    // Update an existing task
    async function updateTask(taskId, taskData) {
      try {
        // Sanitize input data
        const sanitizedData = sanitizeTaskData(taskData);
        
        // Validate data before saving
        const validationErrors = validateTaskData(sanitizedData);
        if (validationErrors.length > 0) {
          throw new Error('Données invalides: ' + validationErrors.join(', '));
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const taskIndex = items.findIndex(item => item.id == taskId);
        
        if (taskIndex === -1) {
          throw new Error('Task not found');
        }
        
        const updatedTask = {
          ...items[taskIndex],
          ...normalizeTaskData(sanitizedData),
          id: parseInt(taskId) // Preserve original ID
        };
        
        items[taskIndex] = updatedTask;
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        console.log('Task updated successfully:', updatedTask);
        return updatedTask;
      } catch (error) {
        console.error('Failed to update task:', error);
        throw new Error('Failed to update task: ' + error.message);
      }
    }
    
    // Delete a task
    async function deleteTask(taskId) {
      try {
        if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')) {
          return;
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const filteredItems = items.filter(item => item.id != taskId);
        
        localStorage.setItem('cmvDB', JSON.stringify(filteredItems));
        
        console.log('Task deleted successfully');
        await loadTasks();
        showSuccess('Tâche supprimée avec succès !');
      } catch (error) {
        console.error('Failed to delete task:', error);
        showError('Erreur lors de la suppression: ' + error.message);
      }
    }
    
    // Toggle task status
    async function toggleTaskStatus(taskId) {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const taskIndex = items.findIndex(item => item.id == taskId);
        
        if (taskIndex === -1) {
          throw new Error('Task not found');
        }
        
        const currentStatus = items[taskIndex].status;
        items[taskIndex].status = currentStatus === 'En cours' ? 'Terminé' : 'En cours';
        
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        console.log('Task status toggled successfully');
        await loadTasks();
        showSuccess('Statut de la tâche modifié avec succès !');
      } catch (error) {
        console.error('Failed to toggle task status:', error);
        showError('Erreur lors du changement de statut: ' + error.message);
      }
    }
    
    // Edit a task
    function editTask(taskId) {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const task = items.find(item => item.id == taskId);
        
        if (!task) {
          throw new Error('Task not found');
        }
        
        // Populate form with task data
        document.getElementById('editId').value = task.id;
        document.getElementById('title').value = task.title || '';
        document.getElementById('description').value = task.description || '';
        document.getElementById('location').value = task.location || '';
        document.getElementById('deadline').value = task.deadline || '';
        
        // Set assignees
        const whoInputs = document.querySelectorAll('input[name="who"]');
        whoInputs.forEach(input => {
          input.checked = task.who && task.who.includes(input.value);
        });
        
        // Set priority
        const urgentInputs = document.querySelectorAll('input[name="urgent"]');
        urgentInputs.forEach(input => {
          input.checked = input.value === task.urgent;
        });
        
        // Update form state
        isEditing = true;
        editId = task.id;
        document.getElementById('submitBtn').textContent = '💾 Modifier la tâche';
        document.getElementById('cancelEditBtn').style.display = 'inline-block'; // Show cancel button
        
        // Scroll to form
        document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
        
        console.log('Task loaded for editing:', task);
      } catch (error) {
        console.error('Failed to load task for editing:', error);
        alert('Erreur lors du chargement de la tâche: ' + error.message);
      }
    }
    
    // ============================================================================
    // TASK DISPLAY AND RENDERING
    // ============================================================================
    
    // Load and display tasks
    async function loadTasks() {
      try {
        // Show skeleton loading for better perceived performance
        showSkeletonLoading();
        
        // Small delay to show skeleton (improves UX)
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const items = await listSubmissions();
        renderList(items);
        updateTasksCount(items.length);
      } catch (error) {
        console.error('Failed to load tasks:', error);
        $taskList.innerHTML = '<div class="error">Erreur lors du chargement des tâches: ' + error.message + '</div>';
      }
    }
    
    // Get all submissions from database
    async function listSubmissions() {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        
        // Normalize all items for consistency
        const normalizedItems = items.map(item => normalizeTaskData(item));
        
        return normalizedItems;
      } catch (error) {
        console.error('Failed to list submissions:', error);
        throw new Error('Failed to list submissions: ' + error.message);
      }
    }
    
    // Render the task list
    function renderList(items) {
      try {
        if (!items || items.length === 0) {
          $taskList.innerHTML = `
            <div class="empty-state">
              <h3>📝 Aucune tâche trouvée</h3>
              <p>Commencez par ajouter votre première tâche ci-dessus !</p>
            </div>
          `;
          return;
        }
        
        // Apply optimized filtering and sorting
        const filteredItems = filterTasks(items);
        const sortedItems = sortTasks(filteredItems);
        
        // Show search results info if searching
        if (searchQuery.trim()) {
          const searchInfo = document.createElement('div');
          searchInfo.className = 'search-info';
          searchInfo.innerHTML = `
            <div class="search-results">
              🔍 Recherche: "${escapeHtml(searchQuery)}" - ${filteredItems.length} résultat${filteredItems.length !== 1 ? 's' : ''}
              <button class="btn btn-sm btn-secondary" onclick="clearSearch()">Effacer</button>
            </div>
          `;
          
          // Insert search info before task list
          if ($taskList.previousElementSibling && $taskList.previousElementSibling.className === 'search-info') {
            $taskList.previousElementSibling.remove();
          }
          $taskList.parentNode.insertBefore(searchInfo, $taskList);
        } else {
          // Remove search info if no search
          const existingSearchInfo = $taskList.previousElementSibling;
          if (existingSearchInfo && existingSearchInfo.className === 'search-info') {
            existingSearchInfo.remove();
          }
        }
        
        // Render tasks
        const tasksHTML = sortedItems.map(item => renderTaskCard(item)).join('');
        $taskList.innerHTML = tasksHTML;
        
        // Add event listeners to action buttons
        addTaskActionListeners();
        
        console.log(`Rendered ${sortedItems.length} tasks`);
      } catch (error) {
        console.error('Failed to render list:', error);
        $taskList.innerHTML = '<div class="error">Erreur lors de l\'affichage des tâches: ' + error.message + '</div>';
      }
    }
    
    // Render a single task card
    function renderTaskCard(item) {
      const priorityClass = getPriorityClass(item.urgent);
      const statusClass = getStatusClass(item.status);
      const isOverdue = isTaskOverdue(item);
      const isUnassigned = !item.who || item.who.length === 0;
      const assignees = isUnassigned ? 'Non assignée' : item.who.join(', ');
      
      return `
        <div class="task-card ${item.status === 'Terminé' ? 'completed' : ''} ${isUnassigned ? 'unassigned' : ''}" data-id="${item.id}">
          <div class="task-header">
            <h3 class="task-title">${escapeHtml(item.title)}</h3>
            <div class="task-actions">
              <button class="btn btn-sm btn-primary" onclick="editTask(${item.id})" title="Modifier">
                ✏️
              </button>
              <button class="btn btn-sm btn-warning" onclick="toggleTaskStatus(${item.id})" title="${item.status === 'En cours' ? 'Marquer comme terminée' : 'Marquer comme en cours'}">
                ${item.status === 'En cours' ? '✅' : '🔄'}
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteTask(${item.id})" title="Supprimer">
                🗑️
              </button>
            </div>
          </div>
          
          ${item.description ? `<div class="task-description">${escapeHtml(item.description)}</div>` : ''}
          ${item.location ? `<div class="task-location">📍 ${escapeHtml(item.location)}</div>` : ''}
          
          <div class="task-meta">
            <div class="task-meta-item">
              <strong>Assigné à:</strong> <span class="${isUnassigned ? 'text-warning' : ''}">${escapeHtml(assignees)}</span>
            </div>
            <div class="task-meta-item">
              <strong>Priorité:</strong> <span class="${priorityClass}">${getPriorityText(item.urgent)}</span>
            </div>
            <div class="task-meta-item">
              <strong>Statut:</strong> <span class="${statusClass}">${item.status}</span>
            </div>
            ${item.deadline ? `
              <div class="task-meta-item ${isOverdue ? 'text-danger' : ''}">
                <strong>Échéance:</strong> ${formatDate(item.deadline)} ${isOverdue ? '⚠️ En retard' : ''}
              </div>
            ` : ''}
            <div class="task-meta-item">
              <strong>Créée:</strong> ${formatDate(item.createdAt)}
            </div>
          </div>
        </div>
      `;
    }
    
    // Add event listeners to task action buttons
    function addTaskActionListeners() {
      // Event listeners are added via onclick attributes in the HTML
      // This function can be used for more complex event handling if needed
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    // Show success notification
    function showSuccess(message) {
      // Create a temporary success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: var(--space-4);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        max-width: 300px;
        animation: slideInRight 0.3s ease-out;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
    
    // Show error message
    function showError(message) {
      alert(message); // Keep simple for now, can be enhanced later
    }
    
    // Get priority CSS class
    function getPriorityClass(priority) {
      switch (priority) {
        case 'Oui': return 'priority-urgent';
        case 'Au PC !': return 'priority-critical';
        default: return 'priority-normal';
      }
    }
    
    // Get priority display text
    function getPriorityText(priority) {
      switch (priority) {
        case 'Oui': return 'Urgent';
        case 'Au PC !': return 'Critique';
        default: return 'Normal';
      }
    }
    
    // Get status CSS class
    function getStatusClass(status) {
      switch (status) {
        case 'Terminé': return 'status-termine';
        default: return 'status-en-cours';
      }
    }
    
    // Check if task is overdue
    function isTaskOverdue(item) {
      if (!item.deadline || item.status === 'Terminé') return false;
      const deadline = new Date(item.deadline);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return deadline < today;
    }
    
    // Format date for display
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        return 'Date invalide';
      }
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Update tasks count display
    function updateTasksCount(count) {
      $tasksCount.textContent = `${count} tâche${count !== 1 ? 's' : ''}`;
    }
    
    // Update unassigned count display
    function updateUnassignedCount(count) {
      document.getElementById('unassignedCount').textContent = `${count} tâche${count !== 1 ? 's' : ''} non assignée`;
      document.getElementById('unassignedCount').style.display = count > 0 ? 'block' : 'none';
    }
    
    // ============================================================================
    // FILTER AND SORT HANDLERS
    // ============================================================================
    
    // Handle filter change
    async function handleFilterChange(e) {
      currentFilter = e.target.value;
      await loadTasks();
    }
    
    // Handle sort change
    async function handleSortChange(e) {
      currentSort = e.target.value;
      await loadTasks();
    }
    
    // Handle employee filter change
    async function handleEmployeeChange(e) {
      selectedEmployee = e.target.value;
      await loadTasks();
    }
    
    // ============================================================================
    // EXPORT AND SHARING FUNCTIONS
    // ============================================================================
    
    // Export tasks to CSV
    async function exportToCSV() {
      try {
        const items = await listSubmissions();
        
        if (items.length === 0) {
          alert('Aucune tâche à exporter.');
          return;
        }
        
        // Create CSV content
        const headers = ['Titre', 'Description', 'Localisation', 'Assigné à', 'Priorité', 'Statut', 'Échéance', 'Date de création'];
        const csvContent = [
          headers.join(','),
          ...items.map(item => [
            `"${(item.title || '').replace(/"/g, '""')}"`,
            `"${(item.description || '').replace(/"/g, '""')}"`,
            `"${(item.location || '').replace(/"/g, '""')}"`,
            `"${(item.who ? item.who.join('; ') : '').replace(/"/g, '""')}"`,
            `"${item.urgent || ''}"`,
            `"${item.status || ''}"`,
            `"${item.deadline || ''}"`,
            `"${item.createdAt ? formatDate(item.createdAt) : ''}"`
          ].join(','))
        ].join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
        link.setAttribute('download', `glentasks_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
        
        console.log('CSV exported successfully');
        alert('Export CSV réussi !');
      } catch (error) {
        console.error('CSV export failed:', error);
        alert('Erreur lors de l\'export CSV: ' + error.message);
      }
    }
    
    // Share app URL
    function shareApp() {
      const githubUrl = 'https://miguelbaillargeon.github.io/glentasks-web/';
      
      if (navigator.share) {
        navigator.share({
          title: 'GlenTasks - Gestion des Tâches',
          text: 'Application de gestion des tâches simple et efficace',
          url: githubUrl
        });
        } else {
        // Fallback for browsers that don't support Web Share API
        navigator.clipboard.writeText(githubUrl).then(() => {
          showSuccess('Lien GitHub copié dans le presse-papiers !');
        }).catch(() => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = githubUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showSuccess('Lien GitHub copié dans le presse-papiers !');
        });
      }
    }
    
    // ============================================================================
    // MOCK DATA FUNCTIONS
    // ============================================================================
    
    // Add mock data for testing
    async function addMockData() {
      try {
        const mockTasks = [
          {
            title: "Réparer la machine à café",
            description: "La machine ne fonctionne plus depuis ce matin",
            location: "Salle de pause",
            who: ["Éric"],
            urgent: "Oui",
            deadline: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            status: "En cours",
            createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
          },
          {
            title: "Mettre à jour la documentation",
            description: "Compléter la documentation du projet en cours",
            location: "Bureau",
            who: ["Miguel"],
            urgent: "Non",
            deadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            status: "En cours",
            createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
          },
          {
            title: "Réunion équipe",
            description: "Planifier la réunion hebdomadaire de l'équipe",
            location: "Salle de conférence",
            who: ["Audrey", "Lucas"],
            urgent: "Au PC !",
            deadline: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            status: "En cours",
            createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
          }
        ];
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        mockTasks.forEach(task => {
          task.id = Date.now() + Math.random();
          items.push(task);
        });
        
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        await loadTasks();
        $addMockData.classList.add('hidden');
        $clearMockData.classList.remove('hidden');
        
        console.log('Mock data added successfully');
        alert('Données de test ajoutées avec succès !');
          } catch (error) {
        console.error('Failed to add mock data:', error);
        alert('Erreur lors de l\'ajout des données de test: ' + error.message);
      }
    }
    
    // Clear mock data
    async function clearMockData() {
      try {
        if (!confirm('Êtes-vous sûr de vouloir effacer toutes les données de test ?')) {
          return;
        }
        
        localStorage.removeItem('cmvDB');
        await initializeDatabase();
        await loadTasks();
        
        $addMockData.classList.remove('hidden');
        $clearMockData.classList.add('hidden');
        
        console.log('Mock data cleared successfully');
        alert('Données de test effacées avec succès !');
      } catch (error) {
        console.error('Failed to clear mock data:', error);
        alert('Erreur lors de l\'effacement des données de test: ' + error.message);
      }
    }
    
    // ============================================================================
    // REPORT GENERATION
    // ============================================================================
    
    // Generate and download report
    async function generateReport() {
      try {
        console.log('Report generation started...');
            
            // Get current filtered and sorted items
            let items = await listSubmissions();
            
            // Apply the same filtering logic as renderList
            items.forEach(it => {
              if (!it.status) it.status = "En cours";
              if (!it.title && it.task) it.title = it.task;
              if (!it.description) it.description = "";
            });
            
            // Apply current filters
            items = items.filter(it => {
              if (selectedEmployee && (!it.who || !it.who.includes(selectedEmployee))) {
                return false;
              }
              
              switch (currentFilter) {
                case 'done':
                  return it.status === "Terminé";
                case 'pending':
                  return it.status === "En cours";
                case 'unassigned':
                  return !it.who || it.who.length === 0;
                default:
                  return true;
              }
            });
            
            // Apply current sorting
            items.sort((a, b) => {
              const wa = STATUS_WEIGHT[a.status] ?? 0;
              const wb = STATUS_WEIGHT[b.status] ?? 0;
              if (wa !== wb) return wa - wb;
              
              let sortResult = 0;
              switch (currentSort) {
                case 'urgency':
                  const urgencyOrder = { "Au PC !": 3, "Oui": 2, "Non": 1 };
                  const urgencyA = urgencyOrder[a.urgent] || 0;
                  const urgencyB = urgencyOrder[b.urgent] || 0;
                  sortResult = urgencyB - urgencyA;
                  break;
                case 'deadline':
                  const today = new Date().setHours(0,0,0,0);
                  const deadlineA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
                  const deadlineB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
                  
                  // Overdue tasks first (but only among non-done tasks)
                  const overdueA = deadlineA < today && a.status !== "Terminé";
                  const overdueB = deadlineB < today && b.status !== "Terminé";
                  if (overdueA !== overdueB) {
                    sortResult = overdueB - overdueA;
                  } else {
                    sortResult = deadlineA - deadlineB;
                  }
                  break;
                default:
              sortResult = STATUS_WEIGHT[a.status] - STATUS_WEIGHT[b.status];
          }
          
          return sortResult;
        });
        
        console.log('Items after filtering:', items.length);
        
        // Generate report HTML
        const reportHTML = generateReportHTML(items);
        
        // Try to use Capacitor File API first
        if (window.Capacitor && window.Capacitor.Plugins.Filesystem) {
          try {
            const filename = `rapport_glentasks_${new Date().toISOString().split('T')[0]}.html`;
            const result = await window.Capacitor.Plugins.Filesystem.writeFile({
              path: filename,
              data: reportHTML,
              directory: 'DOCUMENTS',
              encoding: 'utf8'
            });
            
            console.log('Report saved successfully:', result);
            alert(`Rapport généré avec succès: ${filename}.`);
          } catch (error) {
            console.warn('Capacitor Filesystem failed, trying fallback:', error);
            fallbackReportGeneration(reportHTML);
          }
      } else {
          fallbackReportGeneration(reportHTML);
        }
        
      } catch (error) {
        console.error('Report generation failed:', error);
        alert('Erreur lors de la génération du rapport: ' + error.message);
      }
    }
    
    // Fallback report generation for browser (blob method)
    function fallbackReportGeneration(htmlContent) {
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `rapport_glentasks_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      console.log('Report generated using fallback method');
      alert('Rapport généré avec succès !');
    }
    
    // Generate report HTML content
    function generateReportHTML(items) {
      const now = new Date();
      const totalTasks = items.length;
      const completedTasks = items.filter(item => item.status === 'Terminé').length;
      const pendingTasks = items.filter(item => item.status === 'En cours').length;
      const urgentTasks = items.filter(item => item.urgent === 'Oui' || item.urgent === 'Au PC !').length;
      
      return `
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>Rapport GlenTasks - ${now.toLocaleDateString('fr-FR')}</title>
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              line-height: 1.6; 
              color: #333;
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
              background: #f8fafc;
            }
            .header { 
              text-align: center; 
              margin-bottom: 40px;
              padding: 30px;
              background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
              color: white;
              border-radius: 12px;
            }
            .header h1 { 
              margin: 0; 
              font-size: 2.5rem;
              font-weight: 700;
            }
            .header p {
              margin: 10px 0 0 0;
              font-size: 1.1rem;
              opacity: 0.9;
            }
            .summary {
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
              gap: 20px;
              margin-bottom: 40px;
            }
            .summary-card {
              background: white;
              padding: 25px;
              border-radius: 12px;
              text-align: center;
              box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
              border: 1px solid #e2e8f0;
            }
            .summary-number {
              font-size: 2.5rem;
              font-weight: 700;
              color: #3b82f6;
              margin-bottom: 10px;
            }
            .summary-label {
              color: #64748b;
              font-size: 0.9rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            .tasks-section {
              background: white;
              border-radius: 12px;
              padding: 30px;
              box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
              border: 1px solid #e2e8f0;
            }
            .tasks-title {
              font-size: 1.5rem;
              font-weight: 600;
              color: #1e293b;
              margin-bottom: 25px;
              padding-bottom: 15px;
              border-bottom: 2px solid #e2e8f0;
            }
            .task-item { 
              padding: 20px;
              border: 1px solid #e2e8f0; 
              border-radius: 8px; 
              margin-bottom: 15px; 
              background: #f8fafc;
            }
            .task-header { 
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 15px;
            }
            .task-title { 
              font-size: 1.1rem;
              font-weight: 600; 
              color: #1e293b; 
              margin: 0;
              flex: 1;
            }
            .task-meta { 
              display: flex;
              flex-wrap: wrap;
              gap: 15px;
              margin-bottom: 15px;
              font-size: 0.9rem;
            }
            .task-meta-item {
              display: flex; 
              align-items: center; 
              gap: 5px;
            }
            .task-meta-item strong {
              color: #475569; 
            }
            .priority-urgent { background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .priority-normal { background: #64748b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .priority-critical { background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .status-en-cours { background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .status-termine { background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
            .footer { 
              text-align: center; 
              margin-top: 40px;
              padding: 20px;
              color: #64748b;
              font-size: 0.9rem;
            }
            @media print {
              body { background: white; }
              .header { background: #3b82f6 !important; -webkit-print-color-adjust: exact; }
            }
          </style>
        </head>
        <body>
            <div class="header">
            <h1>📋 Rapport GlenTasks</h1>
            <p>Généré le ${now.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            
          <div class="summary">
            <div class="summary-card">
              <div class="summary-number">${totalTasks}</div>
              <div class="summary-label">Total des tâches</div>
              </div>
            <div class="summary-card">
              <div class="summary-number">${pendingTasks}</div>
              <div class="summary-label">En cours</div>
              </div>
            <div class="summary-card">
              <div class="summary-number">${completedTasks}</div>
              <div class="summary-label">Terminées</div>
              </div>
            <div class="summary-card">
              <div class="summary-number">${urgentTasks}</div>
              <div class="summary-label">Urgentes</div>
              </div>
            </div>
            
          <div class="tasks-section">
            <h2 class="tasks-title">Détail des Tâches</h2>
            ${items.map(item => `
            <div class="task-item">
              <div class="task-header">
                  <h3 class="task-title">${escapeHtml(item.title)}</h3>
                  <span class="${getPriorityClass(item.urgent)}">${getPriorityText(item.urgent)}</span>
              </div>
                ${item.description ? `<p style="margin-bottom: 15px; color: #475569;">${escapeHtml(item.description)}</p>` : ''}
                <div class="task-meta">
                  <div class="task-meta-item">
                    <strong>Assigné à:</strong> ${item.who && item.who.length > 0 ? escapeHtml(item.who.join(', ')) : 'Non assignée'}
                  </div>
                  <div class="task-meta-item">
                    <strong>Statut:</strong> <span class="${getStatusClass(item.status)}">${item.status}</span>
                  </div>
                  ${item.deadline ? `
                    <div class="task-meta-item">
                      <strong>Échéance:</strong> ${formatDate(item.deadline)}
                  </div>
                  ` : ''}
                  ${item.location ? `
                    <div class="task-meta-item">
                      <strong>Localisation:</strong> ${escapeHtml(item.location)}
                  </div>
                  ` : ''}
                  <div class="task-meta-item">
                    <strong>Créée:</strong> ${formatDate(item.createdAt)}
                </div>
                  </div>
              </div>
            `).join('')}
            </div>
            
            <div class="footer">
            <p>Rapport généré automatiquement par GlenTasks</p>
            <p>© ${now.getFullYear()} - Application de gestion des tâches</p>
          </div>
        </body>
        </html>
      `;
    }
    
    // ============================================================================
    // APP STARTUP
    // ============================================================================
    
    // Initialize DOM elements
    function initializeDOMElements() {
      $passwordOverlay = document.getElementById('passwordOverlay');
      $passwordForm = document.getElementById('passwordForm');
      $passwordInput = document.getElementById('passwordInput');
      $appContainer = document.getElementById('appContainer');
      $cmvForm = document.getElementById('cmvForm');
      $taskList = document.getElementById('taskList');
      $tasksCount = document.getElementById('tasksCount');
      $filterSelect = document.getElementById('filterSelect');
      $sortSelect = document.getElementById('sortSelect');
      $employeeSelect = document.getElementById('employeeSelect');
      $exportCSV = document.getElementById('exportCSV');
      $addMockData = document.getElementById('addMockData');
      $clearMockData = document.getElementById('clearMockData');
      $shareApp = document.getElementById('shareApp');
      $generateReport = document.getElementById('generateReport');
      
      // Setup password form after DOM elements are available
      setupPasswordForm();
    }
    
    // Check authentication when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('GlenTasks app loaded');
      initializeDOMElements();
      checkAuthentication();
    });
    
    // Handle page visibility changes (for mobile apps)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        console.log('App became visible, refreshing data...');
        if (sessionStorage.getItem('glentasks_authenticated') === 'true') {
          loadTasks();
        }
      }
    });
    
    console.log('GlenTasks JavaScript loaded successfully');

    // ============================================================================
    // ERROR HANDLING AND BOUNDARIES
    // ============================================================================
    
    // Global error handler with user-friendly messages
    function handleGlobalError(error, context = '') {
      console.error(`Error in ${context}:`, error);
      
      // Don't show technical errors to users, show friendly messages
      let userMessage = 'Une erreur inattendue s\'est produite.';
      
      if (error.message.includes('localStorage')) {
        userMessage = 'Erreur de stockage. Vérifiez que votre navigateur supporte le stockage local.';
      } else if (error.message.includes('validation')) {
        userMessage = 'Données invalides. Vérifiez les informations saisies.';
      } else if (error.message.includes('network')) {
        userMessage = 'Erreur de connexion. Vérifiez votre connexion internet.';
      }
      
      showError(userMessage);
    }
    
    // Safe execution wrapper for async operations
    async function safeExecute(operation, context = '') {
      try {
        return await operation();
      } catch (error) {
        handleGlobalError(error, context);
        throw error;
      }
    }
    
    // Safe DOM manipulation
    function safeDOMUpdate(element, updateFunction) {
      try {
        if (element && element.parentNode) {
          updateFunction();
        } else {
          console.warn('Element not found for DOM update');
        }
      } catch (error) {
        handleGlobalError(error, 'DOM update');
      }
    }

    // ============================================================================
    // SECURITY AND INPUT SANITIZATION
    // ============================================================================
    
    // Sanitize HTML input to prevent XSS
    function sanitizeInput(input) {
      if (typeof input !== 'string') return input;
      
      return input
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;')
        .replace(/\//g, '&#x2F;');
    }
    
    // Sanitize task data before processing
    function sanitizeTaskData(taskData) {
      return {
        ...taskData,
        title: sanitizeInput(taskData.title),
        description: sanitizeInput(taskData.description),
        location: sanitizeInput(taskData.location),
        who: Array.isArray(taskData.who) ? taskData.who.map(w => sanitizeInput(w)) : []
      };
    }
    
    // Escape HTML for safe display (already exists, but improved)
    function escapeHtml(text) {
      if (typeof text !== 'string') return text;
      
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================================================
    // LOADING STATES AND USER FEEDBACK
    // ============================================================================
    
    // Show loading state
    function showLoading(message = 'Chargement...') {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loadingOverlay';
      loadingDiv.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>${message}</p>
        </div>
      `;
      loadingDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      document.body.appendChild(loadingDiv);
    }
    
    // Hide loading state
    function hideLoading() {
      const loadingDiv = document.getElementById('loadingOverlay');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }
    
    // Show loading for specific operations
    async function withLoading(operation, loadingMessage = 'Chargement...') {
      showLoading(loadingMessage);
      try {
        const result = await operation();
        return result;
      } finally {
        hideLoading();
      }
    }

    // ============================================================================
    // PERFORMANCE OPTIMIZATIONS AND SEARCH
    // ============================================================================
    
    // Debounce function for search input
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Search functionality
    let searchQuery = '';
    let debouncedSearch = debounce(async (query) => {
      searchQuery = query;
      await loadTasks();
    }, 300);
    
    // Optimized task filtering with search
    function filterTasks(items) {
      if (!items || items.length === 0) return [];
      
      let filteredItems = items;
      
      // Apply search filter first (most restrictive)
      if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase().trim();
        filteredItems = items.filter(item => {
          return (
            (item.title && item.title.toLowerCase().includes(query)) ||
            (item.description && item.description.toLowerCase().includes(query)) ||
            (item.location && item.location.toLowerCase().includes(query)) ||
            (item.who && item.who.some(w => w.toLowerCase().includes(query)))
          );
        });
      }
      
      // Apply employee filter
      if (selectedEmployee) {
        filteredItems = filteredItems.filter(item => 
          item.who && item.who.includes(selectedEmployee)
        );
      }
      
      // Apply status filter
      switch (currentFilter) {
        case 'done':
          filteredItems = filteredItems.filter(item => item.status === "Terminé");
          break;
        case 'pending':
          filteredItems = filteredItems.filter(item => item.status === "En cours");
          break;
        case 'unassigned':
          filteredItems = filteredItems.filter(item => !item.who || item.who.length === 0);
          break;
        default:
          // 'all' case - no additional filtering
          break;
      }
      
      return filteredItems;
    }
    
    // Optimized task sorting
    function sortTasks(items) {
      if (!items || items.length === 0) return items;
      
      return items.sort((a, b) => {
        // First priority: Done tasks always go to bottom
        const wa = STATUS_WEIGHT[a.status] ?? 0;
        const wb = STATUS_WEIGHT[b.status] ?? 0;
        if (wa !== wb) return wa - wb;
        
        // Second priority: Apply the selected sorting method
        let sortResult = 0;
        
        switch (currentSort) {
          case 'urgency':
            const urgencyOrder = { "Au PC !": 3, "Oui": 2, "Non": 1 };
            const urgencyA = urgencyOrder[a.urgent] || 0;
            const urgencyB = urgencyOrder[b.urgent] || 0;
            sortResult = urgencyB - urgencyA;
            break;
            
          case 'deadline':
            const today = new Date().setHours(0,0,0,0);
            const deadlineA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
            const deadlineB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
            
            // Overdue tasks first (but only among non-done tasks)
            const overdueA = deadlineA < today && a.status !== "Terminé";
            const overdueB = deadlineB < today && b.status !== "Terminé";
            if (overdueA !== overdueB) {
              sortResult = overdueB - overdueA;
            } else {
              sortResult = deadlineA - deadlineB;
            }
            break;
            
          case 'created':
            sortResult = new Date(b.createdAt) - new Date(a.createdAt);
            break;
            
          default: // status
            sortResult = STATUS_WEIGHT[a.status] - STATUS_WEIGHT[b.status];
        }
        
        return sortResult;
      });
    }

    // ============================================================================
    // SEARCH UTILITIES
    // ============================================================================
    
    // Clear search and reset to show all tasks
    function clearSearch() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.value = '';
        searchQuery = '';
        loadTasks();
      }
    }

    // ============================================================================
    // SKELETON LOADING STATES
    // ============================================================================
    
    // Show skeleton loading state
    function showSkeletonLoading() {
      const skeletonHTML = Array(3).fill(0).map(() => `
        <div class="task-card skeleton-card">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-description"></div>
          <div class="skeleton skeleton-meta"></div>
        </div>
      `).join('');
      
      $taskList.innerHTML = skeletonHTML;
    }
    
    // Hide skeleton loading
    function hideSkeletonLoading() {
      // Skeleton will be replaced when actual content loads
    }

    // ============================================================================
    // STATE MANAGEMENT SYSTEM
    // ============================================================================
    
    // Centralized app state
    const AppState = {
      // UI State
      ui: {
        isEditing: false,
        editId: null,
        isLoading: false,
        searchQuery: '',
        currentFilter: 'all',
        currentSort: 'status',
        selectedEmployee: '',
        showPasswordOverlay: true
      },
      
      // Data State
      data: {
        tasks: [],
        filteredTasks: [],
        sortedTasks: [],
        taskCount: 0,
        unassignedCount: 0
      },
      
      // Configuration
      config: {
        debounceDelay: 300,
        maxTitleLength: 200,
        maxDescriptionLength: 1000,
        itemsPerPage: 50
      },
      
      // Methods
      updateUI(updates) {
        Object.assign(this.ui, updates);
        this.notifyStateChange('ui', updates);
      },
      
      updateData(updates) {
        Object.assign(this.data, updates);
        this.notifyStateChange('data', updates);
      },
      
      // State change notifications
      listeners: new Map(),
      
      subscribe(event, callback) {
        if (!this.listeners.has(event)) {
          this.listeners.set(event, []);
        }
        this.listeners.get(event).push(callback);
      },
      
      notifyStateChange(type, changes) {
        const event = `${type}Changed`;
        if (this.listeners.has(event)) {
          this.listeners.get(event).forEach(callback => callback(changes));
        }
      }
    };
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    // Deep clone objects for immutable updates
    function deepClone(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (obj instanceof Date) return new Date(obj.getTime());
      if (obj instanceof Array) return obj.map(item => deepClone(item));
      if (typeof obj === 'object') {
        const clonedObj = {};
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            clonedObj[key] = deepClone(obj[key]);
          }
        }
        return clonedObj;
      }
    }
    
    // Safe JSON operations with error handling
    const SafeJSON = {
      parse: (str, fallback = []) => {
        try {
          return JSON.parse(str);
        } catch (error) {
          console.warn('JSON parse failed, using fallback:', error);
          return fallback;
        }
      },
      
      stringify: (obj, fallback = '[]') => {
        try {
          return JSON.stringify(obj);
        } catch (error) {
          console.warn('JSON stringify failed, using fallback:', error);
          return fallback;
        }
      }
    };

    // ============================================================================
    // ERROR LOGGING AND MONITORING
    // ============================================================================
    
    // Enhanced error logging system
    const ErrorLogger = {
      logs: [],
      maxLogs: 100,
      
      // Log levels
      levels: {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3,
        CRITICAL: 4
      },
      
      // Current log level
      currentLevel: 1, // INFO and above
      
      log(level, message, context = {}, error = null) {
        if (level < this.currentLevel) return;
        
        const logEntry = {
          timestamp: new Date().toISOString(),
          level: Object.keys(this.levels)[level],
          message,
          context,
          error: error ? {
            name: error.name,
            message: error.message,
            stack: error.stack
          } : null,
          userAgent: navigator.userAgent,
          url: window.location.href
        };
        
        this.logs.push(logEntry);
        
        // Keep only the last maxLogs entries
        if (this.logs.length > this.maxLogs) {
          this.logs.shift();
        }
        
        // Console output
        const consoleMethod = level === 0 ? 'debug' : 
                             level === 1 ? 'info' : 
                             level === 2 ? 'warn' : 
                             level === 3 ? 'error' : 'error';
        
        console[consoleMethod](`[${logEntry.level}] ${message}`, context, error);
        
        // Store in localStorage for persistence
        this.persistLogs();
      },
      
      debug(message, context = {}) {
        this.log(this.levels.DEBUG, message, context);
      },
      
      info(message, context = {}) {
        this.log(this.levels.INFO, message, context);
      },
      
      warn(message, context = {}, error = null) {
        this.log(this.levels.WARN, message, context, error);
      },
      
      error(message, context = {}, error = null) {
        this.log(this.levels.ERROR, message, context, error);
      },
      
      critical(message, context = {}, error = null) {
        this.log(this.levels.CRITICAL, message, context, error);
      },
      
      // Get logs for debugging
      getLogs(level = null) {
        if (level !== null) {
          return this.logs.filter(log => log.level === Object.keys(this.levels)[level]);
        }
        return this.logs;
      },
      
      // Clear logs
      clearLogs() {
        this.logs = [];
        this.persistLogs();
      },
      
      // Export logs
      exportLogs() {
        return JSON.stringify(this.logs, null, 2);
      },
      
      // Persist logs to localStorage
      persistLogs() {
        try {
          localStorage.setItem('glentasks_error_logs', this.exportLogs());
        } catch (error) {
          console.warn('Failed to persist error logs:', error);
        }
      },
      
      // Load logs from localStorage
      loadLogs() {
        try {
          const savedLogs = localStorage.getItem('glentasks_error_logs');
          if (savedLogs) {
            this.logs = SafeJSON.parse(savedLogs, []);
          }
        } catch (error) {
          console.warn('Failed to load error logs:', error);
        }
      }
    };
    
    // Initialize error logger
    ErrorLogger.loadLogs();
    
    // ============================================================================
    // PERFORMANCE MONITORING
    // ============================================================================
    
    // Performance monitoring system
    const PerformanceMonitor = {
      metrics: {
        renderTimes: [],
        filterTimes: [],
        sortTimes: [],
        storageTimes: [],
        apiCalls: []
      },
      
      maxMetrics: 50,
      
      // Start timing an operation
      startTimer(operation) {
        return {
          operation,
          startTime: performance.now()
        };
      },
      
      // End timing and record metric
      endTimer(timer) {
        const duration = performance.now() - timer.startTime;
        this.recordMetric(timer.operation, duration);
        return duration;
      },
      
      // Record a performance metric
      recordMetric(operation, duration) {
        if (!this.metrics[operation]) {
          this.metrics[operation] = [];
        }
        
        this.metrics[operation].push({
          timestamp: Date.now(),
          duration,
          operation
        });
        
        // Keep only the last maxMetrics entries
        if (this.metrics[operation].length > this.maxMetrics) {
          this.metrics[operation].shift();
        }
        
        // Log slow operations
        if (duration > 100) { // 100ms threshold
          ErrorLogger.warn(`Slow operation detected: ${operation} took ${duration.toFixed(2)}ms`);
        }
      },
      
      // Get performance statistics
      getStats(operation = null) {
        if (operation) {
          const times = this.metrics[operation];
          if (!times || times.length === 0) return null;
          
          const durations = times.map(t => t.duration);
          return {
            count: times.length,
            average: durations.reduce((a, b) => a + b, 0) / durations.length,
            min: Math.min(...durations),
            max: Math.max(...durations),
            recent: times.slice(-10).map(t => ({ timestamp: t.timestamp, duration: t.duration }))
          };
        }
        
        // Return all stats
        const allStats = {};
        for (const [key, times] of Object.entries(this.metrics)) {
          if (times.length > 0) {
            const durations = times.map(t => t.duration);
            allStats[key] = {
              count: times.length,
              average: durations.reduce((a, b) => a + b, 0) / durations.length,
              min: Math.min(...durations),
              max: Math.max(...durations)
            };
          }
        }
        return allStats;
      },
      
      // Clear performance metrics
      clearMetrics() {
        for (const key in this.metrics) {
          this.metrics[key] = [];
        }
      },
      
      // Export performance data
      exportMetrics() {
        return JSON.stringify(this.metrics, null, 2);
      }
    };
    
    // Performance wrapper for functions
    function withPerformanceMonitoring(fn, operationName) {
      return async function(...args) {
        const timer = PerformanceMonitor.startTimer(operationName);
        try {
          const result = await fn.apply(this, args);
          return result;
        } finally {
          PerformanceMonitor.endTimer(timer);
        }
      };
    }
    
    // Global error handler with logging
    function handleGlobalError(error, context = '') {
      ErrorLogger.error(`Global error in ${context}`, { context }, error);
      
      // Don't show technical errors to users, show friendly messages
      let userMessage = 'Une erreur inattendue s\'est produite.';
      
      if (error.message.includes('localStorage')) {
        userMessage = 'Erreur de stockage. Vérifiez que votre navigateur supporte le stockage local.';
      } else if (error.message.includes('validation')) {
        userMessage = 'Données invalides. Vérifiez les informations saisies.';
      } else if (error.message.includes('network')) {
        userMessage = 'Erreur de connexion. Vérifiez votre connexion internet.';
      }
      
      showError(userMessage);
    }

    // ============================================================================
    // DEBUGGING AND DEVELOPMENT TOOLS
    // ============================================================================
    
    // Debug panel for developers
    const DebugPanel = {
      isVisible: false,
      
      // Initialize debug panel
      init() {
        this.createDebugButton();
        this.createDebugPanel();
        this.bindEvents();
      },
      
      // Create debug button
      createDebugButton() {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debugBtn';
        debugBtn.innerHTML = '🐛 Debug';
        debugBtn.className = 'btn btn-secondary';
        debugBtn.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 10001;
          opacity: 0.7;
        `;
        
        document.body.appendChild(debugBtn);
      },
      
      // Create debug panel
      createDebugPanel() {
        const panel = document.createElement('div');
        panel.id = 'debugPanel';
        panel.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80%;
          max-width: 800px;
          max-height: 80vh;
          background: white;
          border: 2px solid var(--primary);
          border-radius: var(--radius-lg);
          padding: var(--space-6);
          z-index: 10002;
          display: none;
          overflow-y: auto;
          box-shadow: var(--shadow-xl);
        `;
        
        panel.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
            <h3>🐛 Debug Panel</h3>
            <button id="closeDebugPanel" class="btn btn-danger btn-sm">❌ Fermer</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
            <div>
              <h4>📊 Performance</h4>
              <div id="performanceStats"></div>
              <button id="clearMetrics" class="btn btn-secondary btn-sm" style="margin-top: var(--space-2);">
                Effacer métriques
              </button>
            </div>
            
            <div>
              <h4>🚨 Erreurs</h4>
              <div id="errorLogs"></div>
              <button id="clearLogs" class="btn btn-secondary btn-sm" style="margin-top: var(--space-2);">
                Effacer logs
              </button>
            </div>
          </div>
          
          <div style="margin-top: var(--space-4);">
            <h4>🔧 Actions</h4>
            <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
              <button id="exportLogs" class="btn btn-primary btn-sm">📥 Exporter Logs</button>
              <button id="exportMetrics" class="btn btn-primary btn-sm">📊 Exporter Métriques</button>
              <button id="testError" class="btn btn-warning btn-sm">🧪 Tester Erreur</button>
              <button id="clearStorage" class="btn btn-danger btn-sm">🗑️ Effacer Stockage</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(panel);
      },
      
      // Bind debug panel events
      bindEvents() {
        const debugBtn = document.getElementById('debugBtn');
        const debugPanel = document.getElementById('debugPanel');
        const closeBtn = document.getElementById('closeDebugPanel');
        
        debugBtn.addEventListener('click', () => this.toggle());
        closeBtn.addEventListener('click', () => this.hide());
        
        // Performance metrics
        document.getElementById('clearMetrics').addEventListener('click', () => {
          PerformanceMonitor.clearMetrics();
          this.updatePerformanceStats();
        });
        
        // Error logs
        document.getElementById('clearLogs').addEventListener('click', () => {
          ErrorLogger.clearLogs();
          this.updateErrorLogs();
        });
        
        // Export functions
        document.getElementById('exportLogs').addEventListener('click', () => {
          this.exportData('logs', ErrorLogger.exportLogs());
        });
        
        document.getElementById('exportMetrics').addEventListener('click', () => {
          this.exportData('metrics', PerformanceMonitor.exportMetrics());
        });
        
        // Test functions
        document.getElementById('testError').addEventListener('click', () => {
          ErrorLogger.warn('Test warning message', { test: true });
          this.updateErrorLogs();
        });
        
        document.getElementById('clearStorage').addEventListener('click', () => {
          if (confirm('Êtes-vous sûr de vouloir effacer tout le stockage ?')) {
            localStorage.clear();
            location.reload();
          }
        });
      },
      
      // Toggle debug panel
      toggle() {
        if (this.isVisible) {
          this.hide();
        } else {
          this.show();
        }
      },
      
      // Show debug panel
      show() {
        const panel = document.getElementById('debugPanel');
        panel.style.display = 'block';
        this.isVisible = true;
        this.updatePerformanceStats();
        this.updateErrorLogs();
      },
      
      // Hide debug panel
      hide() {
        const panel = document.getElementById('debugPanel');
        panel.style.display = 'none';
        this.isVisible = false;
      },
      
      // Update performance statistics
      updatePerformanceStats() {
        const stats = PerformanceMonitor.getStats();
        const container = document.getElementById('performanceStats');
        
        if (!stats || Object.keys(stats).length === 0) {
          container.innerHTML = '<p>Aucune métrique disponible</p>';
          return;
        }
        
        const html = Object.entries(stats).map(([operation, data]) => `
          <div style="margin-bottom: var(--space-2); padding: var(--space-2); background: var(--gray-100); border-radius: var(--radius);">
            <strong>${operation}:</strong><br>
            Moyenne: ${data.average.toFixed(2)}ms<br>
            Min: ${data.min.toFixed(2)}ms, Max: ${data.max.toFixed(2)}ms<br>
            Total: ${data.count} opérations
          </div>
        `).join('');
        
        container.innerHTML = html;
      },
      
      // Update error logs
      updateErrorLogs() {
        const logs = ErrorLogger.getLogs();
        const container = document.getElementById('errorLogs');
        
        if (!logs || logs.length === 0) {
          container.innerHTML = '<p>Aucune erreur enregistrée</p>';
          return;
        }
        
        const html = logs.slice(-10).reverse().map(log => `
          <div style="margin-bottom: var(--space-2); padding: var(--space-2); background: var(--gray-100); border-radius: var(--radius); font-size: 0.8rem;">
            <strong>[${log.level}]</strong> ${log.message}<br>
            <small>${new Date(log.timestamp).toLocaleString()}</small>
          </div>
        `).join('');
        
        container.innerHTML = html;
      },
      
      // Export data
      exportData(type, data) {
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `glentasks_${type}_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
      }
    };
    
    // Initialize debug panel in development mode
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      document.addEventListener('DOMContentLoaded', () => {
        DebugPanel.init();
      });
    }

    // ============================================================================
    // UNIT TESTING FRAMEWORK
    // ============================================================================
    
    // Simple unit testing framework
    const TestRunner = {
      tests: [],
      passed: 0,
      failed: 0,
      
      // Add a test
      test(name, testFunction) {
        this.tests.push({ name, testFunction });
      },
      
      // Assertion functions
      assert(condition, message) {
        if (!condition) {
          throw new Error(`Assertion failed: ${message}`);
        }
      },
      
      assertEquals(expected, actual, message = '') {
        if (expected !== actual) {
          throw new Error(`Expected ${expected}, but got ${actual}. ${message}`);
        }
      },
      
      assertArrayEquals(expected, actual, message = '') {
        if (expected.length !== actual.length) {
          throw new Error(`Expected array length ${expected.length}, but got ${actual.length}. ${message}`);
        }
        for (let i = 0; i < expected.length; i++) {
          if (expected[i] !== actual[i]) {
            throw new Error(`Expected ${expected[i]} at index ${i}, but got ${actual[i]}. ${message}`);
          }
        }
      },
      
      // Run all tests
      async runAll() {
        console.log('🧪 Running unit tests...');
        this.passed = 0;
        this.failed = 0;
        
        for (const test of this.tests) {
          try {
            await test.testFunction();
            console.log(`✅ PASS: ${test.name}`);
            this.passed++;
          } catch (error) {
            console.error(`❌ FAIL: ${test.name} - ${error.message}`);
            this.failed++;
          }
        }
        
        console.log(`\n📊 Test Results: ${this.passed} passed, ${this.failed} failed`);
        return { passed: this.passed, failed: this.failed };
      },
      
      // Run specific test
      async runTest(testName) {
        const test = this.tests.find(t => t.name === testName);
        if (!test) {
          throw new Error(`Test "${testName}" not found`);
        }
        
        try {
          await test.testFunction();
          console.log(`✅ PASS: ${test.name}`);
          return true;
        } catch (error) {
          console.error(`❌ FAIL: ${test.name} - ${error.message}`);
          return false;
        }
      }
    };
    
    // Add tests for critical functions
    TestRunner.test('Data Validation', async () => {
      // Test title validation
      const validTitle = 'Valid task title';
      const invalidTitle = '';
      
      TestRunner.assertEquals(0, validateTaskData({ title: validTitle }).length, 'Valid title should pass validation');
      TestRunner.assert(validateTaskData({ title: invalidTitle }).length > 0, 'Invalid title should fail validation');
      
      // Test description length validation
      const longDescription = 'a'.repeat(1001);
      TestRunner.assert(validateTaskData({ title: 'Test', description: longDescription }).length > 0, 'Long description should fail validation');
    });
    
    TestRunner.test('Data Normalization', async () => {
      const rawData = {
        title: 'Test Task',
        description: 'Test Description'
      };
      
      const normalized = normalizeTaskData(rawData);
      
      TestRunner.assert(normalized.id, 'Normalized data should have an ID');
      TestRunner.assertEquals('Test Task', normalized.title, 'Title should be preserved');
      TestRunner.assertEquals('Test Description', normalized.description, 'Description should be preserved');
      TestRunner.assertEquals('En cours', normalized.status, 'Default status should be set');
      TestRunner.assertEquals('Non', normalized.urgent, 'Default priority should be set');
      TestRunner.assert(Array.isArray(normalized.who), 'Who should be an array');
    });
    
    TestRunner.test('Task Filtering', async () => {
      const testTasks = [
        { title: 'Task 1', status: 'En cours', who: ['Éric'] },
        { title: 'Task 2', status: 'Terminé', who: ['Fred'] },
        { title: 'Task 3', status: 'En cours', who: [] }
      ];
      
      // Test status filtering
      const pendingTasks = filterTasks(testTasks);
      TestRunner.assertEquals(2, pendingTasks.length, 'Should filter to pending tasks only');
      
      // Test employee filtering
      const ericTasks = filterTasks(testTasks.filter(t => t.who.includes('Éric')));
      TestRunner.assertEquals(1, ericTasks.length, 'Should filter to Éric tasks only');
    });
    
    TestRunner.test('Task Sorting', async () => {
      const testTasks = [
        { title: 'Task 1', status: 'Terminé', urgent: 'Non' },
        { title: 'Task 2', status: 'En cours', urgent: 'Oui' },
        { title: 'Task 3', status: 'En cours', urgent: 'Non' }
      ];
      
      const sorted = sortTasks(testTasks);
      
      // Completed tasks should be at the bottom
      TestRunner.assertEquals('En cours', sorted[0].status, 'First task should be pending');
      TestRunner.assertEquals('Terminé', sorted[sorted.length - 1].status, 'Last task should be completed');
    });
    
    TestRunner.test('Input Sanitization', async () => {
      const maliciousInput = 'test script tag';
      const sanitized = sanitizeInput(maliciousInput);
      
      TestRunner.assert(!sanitized.includes('script'), 'Script tags should be sanitized');
      TestRunner.assert(sanitized.includes('script'), 'Text should be preserved');
    });
    
    // Run tests automatically in development mode
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      document.addEventListener('DOMContentLoaded', async () => {
        // Wait a bit for app to initialize
        setTimeout(async () => {
          console.log('🧪 Running automated tests...');
          await TestRunner.runAll();
        }, 2000);
      });
    }
  </script>
</body>
</html>