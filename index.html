<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GlenTasks | Gestion des T√¢ches</title>
  <!-- Add these lines right after line 6 (after <title>) -->
  <meta name="description" content="GlenTasks - Gestion des t√¢ches simple et efficace">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="GlenTasks">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
  <style>
    /* ===== CSS RESET & BASE ===== */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    :root {
      /* Softer, Eye-Friendly Color Palette */
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --primary-bg: #f5f7ff;
      --primary-border: #c7d2fe;
      
      --secondary: #6b7280;
      --secondary-light: #9ca3af;
      --secondary-bg: #f9fafb;
      --secondary-border: #e5e7eb;
      
      --success: #10b981;
      --success-bg: #f0fdf4;
      --success-border: #bbf7d0;
      
      --warning: #f59e0b;
      --warning-bg: #fffbeb;
      --warning-border: #fde68a;
      
      --danger: #ef4444;
      --danger-bg: #fef2f2;
      --danger-border: #fecaca;
      
      --info: #06b6d4;
      --info-bg: #ecfeff;
      --info-border: #a5f3fc;
      
      /* Softer Neutral Colors */
      --gray-50: #fafafa;
      --gray-100: #f4f4f5;
      --gray-200: #e4e4e7;
      --gray-300: #d4d4d8;
      --gray-400: #a1a1aa;
      --gray-500: #71717a;
      --gray-600: #52525b;
      --gray-700: #3f3f46;
      --gray-800: #27272a;
      --gray-900: #18181b;
      
      /* More Compact Spacing System */
      --space-1: 0.2rem;
      --space-2: 0.4rem;
      --space-3: 0.6rem;
      --space-4: 0.8rem;
      --space-5: 1rem;
      --space-6: 1.2rem;
      --space-8: 1.6rem;
      --space-10: 2rem;
      --space-12: 2.4rem;
      
      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
      
      /* Softer Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.03);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.06), 0 1px 2px -1px rgb(0 0 0 / 0.06);
      --shadow-md: 0 3px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.08);
      --shadow-lg: 0 8px 12px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08);
      
      /* Border Radius */
      --radius-sm: 0.3rem;
      --radius: 0.4rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.6rem;
      --radius-xl: 0.8rem;
      
      /* Transitions */
      --transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--gray-50);
      color: var(--gray-800);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* ===== LAYOUT & CONTAINERS ===== */
    .app-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: var(--space-3);
      min-height: 100vh;
    }
    
    .main-header {
      background: white;
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
    }
    
    .app-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .app-title::before {
      content: "üìã";
      font-size: 1.3rem;
    }
    
    .header-actions {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }
    
    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid transparent;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      white-space: nowrap;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    
    .btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 1px;
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .btn-secondary {
      background: white;
      color: var(--gray-600);
      border-color: var(--gray-300);
    }
    
    .btn-secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    
    .btn-success:hover {
      background: #059669;
      border-color: #059669;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }
    
    .btn-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
    }
    
    .btn-lg {
      padding: var(--space-3) var(--space-4);
      font-size: 0.9rem;
    }
    
    /* ===== FORMS ===== */
    .form-card {
      background: white;
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }
    
    .form-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--gray-100);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }
    
    .form-row {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    
    .form-row.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      font-weight: 500;
      color: var(--gray-600);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .form-label.required::after {
      content: "*";
      color: var(--danger);
      font-weight: 700;
    }
    
    .form-input {
      padding: var(--space-2);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.8rem;
      transition: var(--transition);
      background: white;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgb(99 102 241 / 0.1);
    }
    
    .form-input:hover {
      border-color: var(--gray-400);
    }
    
    .form-textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
    
    .form-hint {
      font-size: 0.7rem;
      color: var(--gray-500);
      margin-top: var(--space-1);
    }
    
    /* ===== CHIP SELECTORS ===== */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    
    .chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      background: white;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--gray-600);
      user-select: none;
    }
    
    .chip:hover {
      border-color: var(--primary);
      background: var(--primary-bg);
      color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .chip input[type="radio"],
    .chip input[type="checkbox"] {
      margin: 0;
      width: auto;
      accent-color: var(--primary);
    }
    
    .chip.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* ===== FILTERS & CONTROLS ===== */
    .controls-section {
      background: white;
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }
    
    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
      flex-wrap: wrap;
      gap: var(--space-2);
    }
    
    .controls-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .filter-tabs {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
    }
    
    .filter-tab {
      padding: var(--space-1) var(--space-2);
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: var(--radius-lg);
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      color: var(--gray-600);
    }
    
    .filter-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: var(--shadow-sm);
    }
    
    .filter-tab:hover:not(.active) {
      background: var(--gray-50);
      border-color: var(--gray-400);
      transform: translateY(-1px);
    }
    
    .employee-select {
      padding: var(--space-1) var(--space-2);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.8rem;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      min-width: 130px;
    }
    
    .employee-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgb(99 102 241 / 0.1);
    }
    
    .report-section {
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--gray-200);
    }
    
    .report-hint {
      font-size: 0.7rem;
      color: var(--gray-500);
      text-align: center;
      margin-top: var(--space-1);
    }
    
    /* ===== TASK LIST ===== */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .task-item {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .task-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
      border-color: var(--gray-300);
    }
    
    .task-item.done {
      opacity: 0.7;
      background: var(--gray-50);
    }
    
    .task-item.urgent-high {
      border-left: 3px solid var(--danger);
    }
    
    .task-item.urgent-medium {
      border-left: 3px solid var(--warning);
    }
    
    .task-item.unassigned {
      border-left: 3px solid var(--info);
      background: var(--info-bg);
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
    }
    
    .task-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin: 0;
      flex: 1;
      min-width: 0;
      line-height: 1.4;
    }
    
    .task-status {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-lg);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }
    
    .status-pending {
      background: var(--warning-bg);
      color: var(--warning);
      border: 1px solid var(--warning-border);
    }
    
    .status-done {
      background: var(--success-bg);
      color: var(--success);
      border: 1px solid var(--success-border);
    }
    
    .task-description {
      color: var(--gray-600);
      margin-bottom: var(--space-2);
      line-height: 1.4;
      font-size: 0.8rem;
    }
    
    .task-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }
    
    .meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    
    .meta-item strong {
      color: var(--gray-600);
      font-weight: 500;
      min-width: 50px;
    }
    
    .meta-item.location {
      grid-column: 1 / -1;
      margin-top: var(--space-1);
    }
    
    .urgency-high {
      color: var(--danger);
      font-weight: 500;
    }
    
    .urgency-medium {
      color: var(--warning);
      font-weight: 500;
    }
    
    .urgency-low {
      color: var(--success);
      font-weight: 500;
    }
    
    .unassigned-warning {
      color: var(--info);
      font-weight: 500;
    }
    
    .task-location {
      background: var(--info-bg);
      border: 1px solid var(--info-border);
      border-radius: var(--radius);
      padding: var(--space-2);
      margin-top: var(--space-2);
      font-size: 0.75rem;
    }
    
    .task-location strong {
      color: var(--info);
      display: block;
      margin-bottom: var(--space-1);
      font-weight: 500;
    }
    
    .task-files {
      margin-top: var(--space-2);
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
    }
    
    .file-pill {
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-1) var(--space-2);
      font-size: 0.7rem;
      background: white;
      color: var(--gray-500);
      text-decoration: none;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }
    
    .file-pill:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .task-controls {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      margin-top: var(--space-3);
      padding-top: var(--space-2);
      border-top: 1px solid var(--gray-100);
      justify-content: flex-start;
    }
    
    .task-controls .btn {
      flex: 0 0 auto;
      min-width: auto;
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
      border-radius: var(--radius);
      transition: var(--transition);
    }
    
    .task-controls .btn.toggle-done {
      background: var(--gray-100);
      color: var(--gray-600);
      border-color: var(--gray-300);
    }
    
    .task-controls .btn.toggle-done:hover {
      background: var(--gray-200);
      border-color: var(--gray-400);
      color: var(--gray-700);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .task-controls .btn.edit-btn {
      background: var(--primary-bg);
      color: var(--primary-dark);
      border-color: var(--primary-border);
    }
    
    .task-controls .btn.edit-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .task-controls .btn.delete-btn {
      background: var(--danger-bg);
      color: var(--danger);
      border-color: var(--danger-border);
    }
    
    .task-controls .btn.delete-btn:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* ===== UTILITY CLASSES ===== */
    .text-center { text-align: center; }
    .text-sm { font-size: 0.8rem; }
    .text-xs { font-size: 0.75rem; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }
    
    .hidden { display: none; }
    .block { display: block; }
    .flex { display: flex; }
    .inline-flex { display: inline-flex; }
    
    .gap-2 { gap: var(--space-2); }
    .gap-3 { gap: var(--space-3); }
    .gap-4 { gap: var(--space-4); }
    
    .mb-4 { margin-bottom: var(--space-4); }
    .mb-6 { margin-bottom: var(--space-6); }
    
    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
      .app-container {
        padding: var(--space-2);
      }
      
      .main-header {
        padding: var(--space-3);
        margin-bottom: var(--space-3);
      }
      
      .header-content {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      
      .header-actions {
        justify-content: center;
      }
      
      .form-card {
        padding: var(--space-3);
        margin-bottom: var(--space-3);
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }
      
      .controls-section {
        padding: var(--space-3);
        margin-bottom: var(--space-3);
      }
      
      .controls-header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }
      
      .filter-tabs {
        justify-content: center;
      }
      
      .task-item {
        padding: var(--space-3);
      }
      
      .task-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-2);
      }
      
      .task-meta {
        grid-template-columns: 1fr;
        gap: var(--space-1);
      }
      
      .task-controls {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .app-container {
        padding: var(--space-2);
      }
      
      .main-header {
        padding: var(--space-2);
        border-radius: var(--radius);
      }
      
      .form-card {
        padding: var(--space-2);
        border-radius: var(--radius);
      }
      
      .controls-section {
        padding: var(--space-2);
        border-radius: var(--radius);
      }
      
      .task-item {
        padding: var(--space-2);
        border-radius: var(--radius);
      }
    }
    
    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-15px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .task-item {
      animation: fadeIn 0.25s ease-out;
    }
    
    .form-card,
    .controls-section {
      animation: slideIn 0.3s ease-out;
    }
    
    /* ===== LOADING STATES ===== */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid var(--gray-300);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ===== EMPTY STATES ===== */
    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--gray-500);
    }
    
    .empty-state-icon {
      font-size: 2.5rem;
      margin-bottom: var(--space-3);
      opacity: 0.4;
    }
    
    .empty-state-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: var(--space-1);
    }
    
    .empty-state-description {
      font-size: 0.8rem;
      color: var(--gray-500);
    }
    
    /* ===== SUCCESS/ERROR MESSAGES ===== */
    .message {
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius);
      margin-bottom: var(--space-3);
      font-size: 0.8rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .message-success {
      background: var(--success-bg);
      color: var(--success);
      border: 1px solid var(--success-border);
    }
    
    .message-error {
      background: var(--danger-bg);
      color: var(--danger);
      border: 1px solid var(--danger-border);
    }
    
    .message-info {
      background: var(--info-bg);
      color: var(--info);
      border: 1px solid var(--info-border);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Main Header -->
    <header class="main-header">
      <div class="header-content">
        <h1 class="app-title">GlenTasks</h1>
        <div class="header-actions">
          <button id="exportCSV" class="btn btn-secondary">
            üìä Exporter CSV
          </button>
          <button id="addMockData" class="btn btn-secondary">
            üß™ Ajouter donn√©es test
          </button>
          <button id="clearMockData" class="btn btn-danger hidden">
            üóëÔ∏è Effacer donn√©es test
          </button>
          <button id="shareApp" class="btn btn-success">
            üîó Partager
          </button>
        </div>
      </div>
    </header>

    <!-- Task Form -->
    <div class="form-card">
      <h2 class="form-title">Nouvelle T√¢che</h2>
      <form id="cmvForm" novalidate>
        <input type="hidden" id="editId" value="">
        
        <div class="form-grid">
          <div class="form-row full-width">
            <label for="title" class="form-label required">Titre de la t√¢che</label>
            <input id="title" name="title" type="text" class="form-input" required placeholder="Que faut-il faire ?">
          </div>
          
          <div class="form-row full-width">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" name="description" class="form-input form-textarea" placeholder="D√©tails, instructions, contexte..."></textarea>
          </div>
          
          <div class="form-row">
            <label for="location" class="form-label">üìç Localisation</label>
            <textarea id="location" name="location" class="form-input" placeholder="O√π se trouve la t√¢che ?"></textarea>
          </div>
          
          <div class="form-row">
            <label class="form-label">üë• Assignation</label>
            <div class="chip-group">
              <label class="chip"><input type="checkbox" name="who" value="√âric"> √âric</label>
              <label class="chip"><input type="checkbox" name="who" value="Fred"> Fred</label>
              <label class="chip"><input type="checkbox" name="who" value="Audrey"> Audrey</label>
              <label class="chip"><input type="checkbox" name="who" value="Lucas"> Lucas</label>
              <label class="chip"><input type="checkbox" name="who" value="Miguel"> Miguel</label>
              <label class="chip"><input type="checkbox" name="who" value="Autre"> Autre</label>
            </div>
          </div>
          
          <div class="form-row">
            <label class="form-label">üö® Priorit√©</label>
            <div class="chip-group">
              <label class="chip"><input type="radio" name="urgent" value="Non" checked> Normal</label>
              <label class="chip"><input type="radio" name="urgent" value="Oui"> Urgent</label>
              <label class="chip"><input type="radio" name="urgent" value="Au PC !"> Critique</label>
            </div>
          </div>
          
          <div class="form-row">
            <label for="deadline" class="form-label">‚è∞ √âch√©ance</label>
            <input id="deadline" name="deadline" type="date" class="form-input">
          </div>
          
          <div class="form-row full-width">
            <label for="files" class="form-label">üìé Fichiers</label>
            <input id="files" name="files" type="file" multiple class="form-input">
            <div class="form-hint">Ajoutez jusqu'√† 5 fichiers (stockage local uniquement)</div>
          </div>
        </div>
        
        <div class="flex gap-3">
          <button type="submit" class="btn btn-primary" id="saveBtn">
            üíæ Enregistrer
          </button>
          <button type="button" class="btn btn-secondary hidden" id="cancelEditBtn">
            ‚ùå Annuler
          </button>
        </div>
        
        <div class="form-hint text-center mt-4">
          üîí Aucune donn√©e n'est envoy√©e sur Internet. Tout est stock√© localement sur cet appareil.
        </div>
      </form>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="controls-header">
        <h3 class="controls-title">Filtres & Tri</h3>
        <div class="flex gap-3 items-center">
          <select id="employeeSelect" class="employee-select">
            <option value="">üë• Tous les employ√©s</option>
            <option value="√âric">√âric</option>
            <option value="Fred">Fred</option>
            <option value="Audrey">Audrey</option>
            <option value="Lucas">Lucas</option>
            <option value="Miguel">Miguel</option>
            <option value="Autre">Autre</option>
          </select>
          
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">üìã Toutes</button>
            <button class="filter-tab" data-filter="pending">‚è≥ En cours</button>
            <button class="filter-tab" data-filter="done">‚úÖ Termin√©es</button>
            <button class="filter-tab" data-filter="unassigned">‚ùì Non assign√©es</button>
          </div>
          
          <div class="filter-tabs">
            <button class="filter-tab active" data-sort="urgency">üö® Par urgence</button>
            <button class="filter-tab" data-sort="deadline">‚è∞ Par √©ch√©ance</button>
          </div>
        </div>
      </div>
      
      <div class="report-section">
        <button id="generateReport" class="btn btn-primary btn-lg">
          üìä G√©n√©rer le rapport
        </button>
        <div class="report-hint">Ouvrir dans le navigateur et imprimer en PDF</div>
      </div>
    </div>

    <!-- Task List -->
    <div class="task-list" id="list">
      <!-- Tasks will be rendered here -->
    </div>
  </div>

  <script>
    // Add comprehensive error handling and debugging
    console.log('App initialization started...');
    
    // iOS-specific debugging
    if (window.Capacitor) {
      console.log('Capacitor detected, platform:', window.Capacitor.getPlatform());
      // Remove getVersion call as it doesn't exist in this version
      console.log('Capacitor available');
    } else {
      console.log('Running in browser mode');
    }
    
    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      alert('App error: ' + event.error.message);
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      alert('App promise error: ' + event.reason);
    });

    // localStorage-based storage system (iOS compatible)
    let nextId = 1;

    // Initialize localStorage
    const initStorage = () => {
      console.log('Initializing localStorage...');
      try {
        // Get the next available ID
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        if (items.length > 0) {
          nextId = Math.max(...items.map(item => item.id)) + 1;
        }
        console.log('localStorage initialized successfully');
        return true;
      } catch (error) {
        console.error('localStorage initialization error:', error);
        return false;
      }
    };

    const addSubmission = (data) => new Promise((resolve, reject) => {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const newItem = { ...data, id: nextId++ };
        items.push(newItem);
        localStorage.setItem('cmvDB', JSON.stringify(items));
        resolve(newItem.id);
      } catch (error) {
        reject(error);
      }
    });

    const putSubmission = (data) => new Promise((resolve, reject) => {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const index = items.findIndex(item => item.id === data.id);
        if (index !== -1) {
          items[index] = data;
          localStorage.setItem('cmvDB', JSON.stringify(items));
          resolve(data.id);
        } else {
          reject(new Error('Item not found'));
        }
      } catch (error) {
        reject(error);
      }
    });

    const getSubmission = (id) => new Promise((resolve, reject) => {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const item = items.find(item => item.id === id);
        resolve(item || null);
      } catch (error) {
        reject(error);
      }
    });

    const listSubmissions = () => new Promise((resolve, reject) => {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        resolve(items);
      } catch (error) {
        reject(error);
      }
    });

    const deleteSubmission = (id) => new Promise((resolve, reject) => {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const filteredItems = items.filter(item => item.id !== id);
        localStorage.setItem('cmvDB', JSON.stringify(filteredItems));
        resolve();
      } catch (error) {
        reject(error);
      }
    });

    const clearAll = () => new Promise((resolve, reject) => {
      try {
        localStorage.removeItem('cmvDB');
        nextId = 1;
        resolve();
      } catch (error) {
        reject(error);
      }
    });

    // Simplified status system - just Done or Not Done
    const STATUS_WEIGHT = { "En cours": 0, "Termin√©": 1 };

    const $list = document.getElementById('list');
    
    // Separate filtering and sorting system
    let currentFilter = 'all';
    let selectedEmployee = '';
    let currentSort = 'urgency';
    let sortDirection = 'desc'; // 'asc' or 'desc'

    const renderList = async () => {
      let items = await listSubmissions();
      // Default missing fields for backward compatibility
      items.forEach(it => {
        if (!it.status) it.status = "En cours";
        if (!it.title && it.task) it.title = it.task;
        if (!it.description) it.description = "";
      });
      
      // Apply filters (hide/show tasks)
      items = items.filter(it => {
        // Employee filter
        if (selectedEmployee && (!it.who || !it.who.includes(selectedEmployee))) {
          return false;
        }
        
        // Status filters
        switch (currentFilter) {
          case 'done':
            return it.status === "Termin√©";
          case 'pending':
            return it.status === "En cours";
          case 'unassigned':
            return !it.who || it.who.length === 0;
          default:
            return true; // 'all' case
        }
      });
      
      // Apply sorting (reorganize display) - Done tasks ALWAYS at bottom
      items.sort((a, b) => {
        // First priority: Done tasks always go to bottom
        const wa = STATUS_WEIGHT[a.status] ?? 0;
        const wb = STATUS_WEIGHT[b.status] ?? 0;
        if (wa !== wb) return wa - wb; // En cours (0) before Termin√© (1)
        
        // Second priority: Apply the selected sorting method
        let sortResult = 0;
        
        switch (currentSort) {
          case 'urgency':
            // Sort by urgency (high urgency first)
            const urgencyOrder = { "Au PC !": 3, "Oui": 2, "Non": 1 };
            const urgencyA = urgencyOrder[a.urgent] || 0;
            const urgencyB = urgencyOrder[b.urgent] || 0;
            sortResult = urgencyB - urgencyA; // High urgency first by default
            break;
            
          case 'deadline':
            // Sort by deadline (overdue first, then by date)
            const today = new Date().setHours(0,0,0,0);
            const deadlineA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
            const deadlineB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
            
            // Overdue tasks first (but only among non-done tasks)
            const overdueA = deadlineA < today && a.status !== "Termin√©";
            const overdueB = deadlineB < today && b.status !== "Termin√©";
            if (overdueA !== overdueB) {
              sortResult = overdueB - overdueA;
            } else {
              // Then by deadline date
              sortResult = deadlineA - deadlineB;
            }
            break;
            
          default:
            // Default fallback: sort by creation date (newest first)
            sortResult = (b.createdAt || 0) - (a.createdAt || 0);
        }
        
        // Apply sort direction
        return sortDirection === 'desc' ? sortResult : -sortResult;
      });

      if (items.length === 0) {
        $list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <div class="empty-state-title">Aucune t√¢che trouv√©e</div>
            <div class="empty-state-description">Commencez par cr√©er votre premi√®re t√¢che ci-dessus</div>
          </div>
        `;
        return;
      }

      $list.innerHTML = items.map(it => {
        const files = (it.files || []).map(f => `<a class="file-pill" href="${URL.createObjectURL(f.blob)}" download="${f.name}">üìé ${f.name}</a>`).join(' ');
        const who = (it.who || []).join(', ') || 'Non assign√©';
        const urgent = it.urgent || 'Non';
        const deadline = it.deadline || 'Aucune √©ch√©ance';
        const date = new Date(it.createdAt).toLocaleDateString('fr-FR');
        const doneClass = it.status === "Termin√©" ? "done" : "";
        const urgentClass = it.urgent === "Au PC !" ? "urgent-high" : it.urgent === "Oui" ? "urgent-medium" : "";
        const unassignedClass = (!it.who || it.who.length === 0) ? "unassigned" : "";
        
        return `<div class="task-item ${doneClass} ${urgentClass} ${unassignedClass}" data-id="${it.id}">
          <div class="task-header">
            <h3 class="task-title">${escapeHtml(it.title || "")}</h3>
            <div class="task-status ${it.status === 'Termin√©' ? 'status-done' : 'status-pending'}">
              ${it.status === 'Termin√©' ? '‚úÖ Termin√©' : '‚è≥ En cours'}
            </div>
          </div>
          
          ${it.description ? `<div class="task-description">${escapeHtml(it.description)}</div>` : ''}
          
          <div class="task-meta">
            <div class="meta-item">
              <strong>üö® Urgence:</strong>
              <span class="${it.urgent === 'Au PC !' ? 'urgency-high' : it.urgent === 'Oui' ? 'urgency-medium' : 'urgency-low'}">${urgent}</span>
            </div>
            <div class="meta-item ${(!it.who || it.who.length === 0) ? 'unassigned-warning' : ''}">
              <strong>üë• Assign√©:</strong>
              <span>${escapeHtml(who)}</span>
            </div>
            <div class="meta-item">
              <strong>‚è∞ √âch√©ance:</strong>
              <span>${deadline}</span>
            </div>
            <div class="meta-item">
              <strong>üìÖ Cr√©√©:</strong>
              <span>${date}</span>
            </div>
          </div>
          
          ${it.location ? `
            <div class="task-location">
              <strong>üìç Localisation:</strong>
              ${escapeHtml(it.location)}
            </div>
          ` : ''}
          
          ${files ? `<div class="task-files">${files}</div>` : ''}
          
          <div class="task-controls">
            <button class="btn toggle-done" data-id="${it.id}">
              ${it.status === 'Termin√©' ? 'üîÑ Remettre en cours' : '‚úÖ Marquer termin√©'}
            </button>
            <button class="btn edit-btn" data-id="${it.id}">
              ‚úèÔ∏è Modifier
            </button>
            <button class="btn delete-btn" data-id="${it.id}">
              üóëÔ∏è Supprimer
            </button>
          </div>
        </div>`;
      }).join('');
    };

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[s]));
    }

    const form = document.getElementById('cmvForm');
    const titleInput = document.getElementById('title');
    const descInput = document.getElementById('description');
    const filesInput = document.getElementById('files');
    const editIdEl = document.getElementById('editId');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const saveBtn = document.getElementById('saveBtn');

    filesInput.addEventListener('change', () => {
      if (filesInput.files.length > 5) {
        alert('Vous pouvez ajouter jusqu\'√† 5 fichiers.');
        filesInput.value = '';
      }
    });

    // Save / Update
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!titleInput.value.trim()) {
        alert('Veuillez saisir le titre de la t√¢che.');
        return;
      }
      const who = Array.from(form.querySelectorAll('input[name="who"]:checked')).map(i => i.value);
      const urgent = form.querySelector('input[name="urgent"]:checked')?.value || 'Non';

      const fileEntries = [];
      for (const f of filesInput.files) fileEntries.push({ name: f.name, type: f.type, size: f.size, blob: f });

      const editId = editIdEl.value ? Number(editIdEl.value) : null;

      if (editId) {
        const existing = await getSubmission(editId);
        if (!existing) { alert('√âl√©ment introuvable.'); return; }
        const updated = {
          ...existing,
          title: titleInput.value.trim(),
          description: descInput.value.trim(),
          location: form.location.value.trim(),
          urgent, who,
          deadline: form.deadline.value,
          files: fileEntries.length ? fileEntries : existing.files,
        };
        await putSubmission(updated);
      } else {
        await addSubmission({
          title: titleInput.value.trim(),
          description: descInput.value.trim(),
          location: form.location.value.trim(),
          urgent, who,
          status: "En cours", // Default to "En cours" instead of "Assign√©"
          deadline: form.deadline.value,
          files: fileEntries,
          createdAt: Date.now()
        });
      }

      form.reset();
      editIdEl.value = '';
      cancelEditBtn.classList.add('hidden');
      saveBtn.textContent = 'üíæ Enregistrer';
      await renderList();
      alert('T√¢che enregistr√©e avec succ√®s !');
    });

    // Cancel edit
    cancelEditBtn && cancelEditBtn.addEventListener('click', () => {
      form.reset();
      editIdEl.value = '';
      cancelEditBtn.classList.add('hidden');
      saveBtn.textContent = 'üíæ Enregistrer';
    });

    // Event delegation for toggle/edit/delete
    $list.addEventListener('click', async (e) => {
      const getId = (btn) => Number(btn?.dataset?.id);

      const delBtn = e.target.closest('.delete-btn');
      if (delBtn) {
        const id = getId(delBtn);
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?')) {
          await deleteSubmission(id);
          await renderList();
        }
        return;
      }

      const editBtn = e.target.closest('.edit-btn');
      if (editBtn) {
        const id = getId(editBtn);
        const item = await getSubmission(id);
        if (!item) return;
        titleInput.value = item.title || item.task || '';
        descInput.value = item.description || '';
        form.location.value = item.location || '';
        form.deadline.value = item.deadline || '';
        form.querySelectorAll('input[name="urgent"]').forEach(r => r.checked = (r.value === (item.urgent || 'Non')));
        form.querySelectorAll('input[name="who"]').forEach(c => c.checked = (item.who || []).includes(c.value));
        editIdEl.value = String(id);
        cancelEditBtn.classList.remove('hidden');
        saveBtn.textContent = 'üíæ Mettre √† jour';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      }

      const toggleDoneBtn = e.target.closest('.toggle-done');
      if (toggleDoneBtn) {
        const id = getId(toggleDoneBtn);
        const item = await getSubmission(id);
        if (!item) return;
        item.status = item.status === "Termin√©" ? "En cours" : "Termin√©";
        await putSubmission(item);
        await renderList();
        return;
      }
    });

    // Export CSV (iOS compatible using Capacitor File System)
    document.getElementById('exportCSV').addEventListener('click', async () => {
      try {
        const items = await listSubmissions();
        const header = ["Titre","Description","Localisation","Urgent","Qui","√âch√©ance","Ajout√©","Statut","Fichiers"];
        const rows = items.map(it => {
          const title = it.title || it.task || "";
          const desc = it.description || "";
          const fileNames = (it.files || []).map(f => f.name).join('; ');
          const esc = s => (`${s??""}`).replace(/"/g,'""');
          return [
            `"${esc(title)}"`,
            `"${esc(desc)}"`,
            `"${esc(it.location)}"`,
            `"${esc(it.urgent)}"`,
            `"${esc((it.who||[]).join(', '))}"`,
            `"${esc(it.deadline)}"`,
            `"${new Date(it.createdAt || Date.now()).toLocaleDateString()}"`,
            `"${esc(it.status || 'En cours')}"`,
            `"${esc(fileNames)}"`
          ];
        });
        const csv = [header.join(","), ...rows.map(r => r.join(","))].join("\n");
        
        // Use Capacitor File System for iOS compatibility
        if (window.Capacitor && window.Capacitor.Plugins.Filesystem) {
          try {
            const filename = `cmv_export_${new Date().toISOString().split('T')[0]}.csv`;
            
            // Save to temporary directory and share
            const result = await window.Capacitor.Plugins.Filesystem.writeFile({
              path: filename,
              data: csv,
              directory: 'CACHE',
              encoding: 'utf8'
            });
            
            // Share the file using iOS share sheet
            if (window.Capacitor.Plugins.Share) {
              await window.Capacitor.Plugins.Share.share({
                title: 'Export CSV GlenTasks',
                text: 'Voici votre export CSV',
                files: [result.uri],
                dialogTitle: 'Partager le fichier CSV'
              });
              alert('CSV export√© et partag√© avec succ√®s!');
            } else {
              alert(`CSV export√© avec succ√®s: ${filename}`);
            }
            
            console.log('CSV exported successfully using Capacitor File System');
          } catch (error) {
            console.error('Capacitor File System error:', error);
            // Fallback to blob method for browser
            fallbackCSVExport(csv);
          }
        } else {
          // Fallback for browser
          fallbackCSVExport(csv);
        }
      } catch (error) {
        console.error('CSV export error:', error);
        alert('Erreur lors de l\'export CSV: ' + error.message);
      }
    });

    // Fallback CSV export for browser (blob method)
    function fallbackCSVExport(csv) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `cmv_export_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // Separate filter and sort event handlers
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        renderList();
      });
    });

    document.querySelectorAll('.sort-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const clickedSort = tab.dataset.sort;
        
        // If clicking the same sort option, toggle direction
        if (clickedSort === currentSort) {
          sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
        } else {
          // If clicking a different sort option, reset to default direction
          sortDirection = 'desc';
          document.querySelectorAll('.sort-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentSort = clickedSort;
        }
        
        renderList();
      });
    });

    document.getElementById('employeeSelect').addEventListener('change', (e) => {
      selectedEmployee = e.target.value;
      renderList();
    });

    // Move the report generator event listener to after DOM initialization
    (async () => { 
      try {
        console.log('Starting app initialization...');
        
        // Wait a bit for iOS WebView to fully initialize
        if (window.Capacitor && window.Capacitor.getPlatform() === 'ios') {
          console.log('iOS detected, waiting for WebView initialization...');
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Initialize database
        initStorage();
        console.log('localStorage initialized successfully');
        
        // Render the list
        await renderList(); 
        console.log('List rendered successfully');
        
        // Initialize report generator
        initializeReportGenerator();
        console.log('Report generator initialized');
        
        // Hide splash screen manually if needed
        if (window.Capacitor && window.Capacitor.Plugins.SplashScreen) {
          try {
            console.log('Attempting to hide splash screen...');
            await window.Capacitor.Plugins.SplashScreen.hide();
            console.log('Splash screen hidden successfully');
          } catch (error) {
            console.warn('Could not hide splash screen:', error);
            // Try alternative method
            try {
              await window.Capacitor.Plugins.SplashScreen.hide({ fadeOutDuration: 0 });
              console.log('Splash screen hidden with alternative method');
            } catch (altError) {
              console.warn('Alternative splash screen hide failed:', altError);
            }
          }
        }
        
        console.log('App initialization completed successfully');
        
      } catch (error) {
        console.error('App initialization failed:', error);
        alert('Failed to initialize app: ' + error.message);
        
        // Try to show some content even if database fails
        $list.innerHTML = '<div class="error">Erreur d\'initialisation: ' + error.message + '</div>';
        
        // Still try to hide splash screen even if app failed
        if (window.Capacitor && window.Capacitor.Plugins.SplashScreen) {
          try {
            await window.Capacitor.Plugins.SplashScreen.hide();
          } catch (splashError) {
            console.warn('Could not hide splash screen after error:', splashError);
          }
        }
      }
    })();
    
    // Separate function to initialize report generator
    function initializeReportGenerator() {
      const reportBtn = document.getElementById('generateReport');
      if (reportBtn) {
        reportBtn.addEventListener('click', async () => {
          try {
            console.log('Report generation started...'); // Debug log
            
            // Get current filtered and sorted items
            let items = await listSubmissions();
            console.log('Total items found:', items.length); // Debug log
            
            // Apply the same filtering logic as renderList
            items.forEach(it => {
              if (!it.status) it.status = "En cours";
              if (!it.title && it.task) it.title = it.task;
              if (!it.description) it.description = "";
            });
            
            // Apply current filters
            items = items.filter(it => {
              if (selectedEmployee && (!it.who || !it.who.includes(selectedEmployee))) {
                return false;
              }
              
              switch (currentFilter) {
                case 'done':
                  return it.status === "Termin√©";
                case 'pending':
                  return it.status === "En cours";
                case 'unassigned':
                  return !it.who || it.who.length === 0;
                default:
                  return true;
              }
            });
            
            console.log('Items after filtering:', items.length); // Debug log
            
            // Apply current sorting
            items.sort((a, b) => {
              const wa = STATUS_WEIGHT[a.status] ?? 0;
              const wb = STATUS_WEIGHT[b.status] ?? 0;
              if (wa !== wb) return wa - wb;
              
              let sortResult = 0;
              switch (currentSort) {
                case 'urgency':
                  const urgencyOrder = { "Au PC !": 3, "Oui": 2, "Non": 1 };
                  const urgencyA = urgencyOrder[a.urgent] || 0;
                  const urgencyB = urgencyOrder[b.urgent] || 0;
                  sortResult = urgencyB - urgencyA;
                  break;
                case 'deadline':
                  const today = new Date().setHours(0,0,0,0);
                  const deadlineA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
                  const deadlineB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
                  const overdueA = deadlineA < today && a.status !== "Termin√©";
                  const overdueB = deadlineB < today && b.status !== "Termin√©";
                  if (overdueA !== overdueB) {
                    sortResult = overdueB - overdueA;
                  } else {
                    sortResult = deadlineA - deadlineB;
                  }
                  break;
                default:
                  sortResult = (b.createdAt || 0) - (a.createdAt || 0);
              }
              return sortDirection === 'desc' ? sortResult : -sortResult;
            });
            
            // Generate report content
            const reportContent = generateReportHTML(items);
            console.log('Report HTML generated, length:', reportContent.length); // Debug log
            
            // Create and download PDF
            await generatePDF(reportContent);
            console.log('PDF generation completed'); // Debug log
            
          } catch (error) {
            console.error('Error generating report:', error);
            alert('Erreur lors de la g√©n√©ration du rapport: ' + error.message);
          }
        });
        console.log('Report generator initialized successfully'); // Debug log
      } else {
        console.error('Report button not found in DOM'); // Debug log
      }
    }

    // Add mock data for testing
    document.getElementById('addMockData').addEventListener('click', async () => {
      const mockTasks = [
        {
          title: "R√©parer irrigation",
          description: "Syst√®me d'arrosage en panne zone nord. V√©rifier et r√©parer.",
          location: "Zone nord, versant est",
          urgent: "Oui",
          who: ["√âric", "Fred"],
          status: "En cours",
          deadline: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 2 * 60 * 60 * 1000
        },
        {
          title: "Tailler haies",
          description: "Tailler haies sentier principal. Maintenir 1.2m hauteur.",
          location: "Sentier principal, entr√©e au parking",
          urgent: "Au PC !",
          who: ["Audrey"],
          status: "En cours",
          deadline: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 6 * 60 * 60 * 1000
        },
        {
          title: "V√©rifier escaliers",
          description: "Inspecter escaliers en pierre. Marquer zones dangereuses.",
          location: "Escaliers versant ouest, zones 1-4",
          urgent: "Non",
          who: ["Lucas", "Miguel"],
          status: "Termin√©",
          deadline: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 24 * 60 * 60 * 1000
        },
        {
          title: "Planter arbustes",
          description: "Planter 25 arbustes indig√®nes. Espacer 2m, tuteurs, arrosage.",
          location: "Zone reboisement, versant sud",
          urgent: "Non",
          who: ["Fred"],
          status: "En cours",
          deadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 12 * 60 * 60 * 1000
        },
        {
          title: "Nettoyer drains",
          description: "D√©boucher drains de ruissellement. Enlever feuilles et d√©bris.",
          location: "R√©seau drainage, versants est et ouest",
          urgent: "Oui",
          who: ["Audrey", "Lucas"],
          status: "En cours",
          deadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 18 * 60 * 60 * 1000
        },
        {
          title: "R√©parer cl√¥ture",
          description: "Cl√¥ture de s√©curit√© endommag√©e. Remplacer poteaux cass√©s.",
          location: "Zone stationnement, c√¥t√© est",
          urgent: "Au PC !",
          who: [],
          status: "En cours",
          deadline: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 4 * 60 * 60 * 1000
        },
        {
          title: "Nettoyer panneaux",
          description: "Nettoyer panneaux d'information. Remplacer endommag√©s.",
          location: "Tous sentiers principaux",
          urgent: "Non",
          who: ["Miguel"],
          status: "Termin√©",
          deadline: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 48 * 60 * 60 * 1000
        },
        {
          title: "V√©rifier √©clairage",
          description: "Tester lampadaires parking. Remplacer ampoules d√©fectueuses.",
          location: "Parking principal",
          urgent: "Oui",
          who: ["√âric"],
          status: "En cours",
          deadline: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 8 * 60 * 60 * 1000
        },
        {
          title: "Maintenir bancs",
          description: "Inspecter bancs de repos. Poncer et revernir bois.",
          location: "Sentiers randonn√©e, zones 1-6",
          urgent: "Non",
          who: ["Lucas"],
          status: "En cours",
          deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 24 * 60 * 60 * 1000
        },
        {
          title: "Contr√¥ler eau",
          description: "Tests qualit√© sources d'eau. V√©rifier potabilit√©.",
          location: "Sources d'eau, versants nord et sud",
          urgent: "Au PC !",
          who: ["Audrey", "Fred"],
          status: "En cours",
          deadline: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          files: [],
          createdAt: Date.now() - 12 * 60 * 60 * 1000
        }
      ];

      // Check if we already have mock data
      const existingItems = await listSubmissions();
      const hasMockData = existingItems.some(item => 
        mockTasks.some(mock => mock.title === item.title)
      );

      if (hasMockData) {
        alert('Des donn√©es de test existent d√©j√†. Utilisez "Effacer donn√©es test" pour les supprimer d\'abord.');
        return;
      }

      // Add mock tasks
      for (const mockTask of mockTasks) {
        await addSubmission(mockTask);
      }

      await renderList();
      
      // Show/hide buttons
      document.getElementById('addMockData').classList.add('hidden');
      document.getElementById('clearMockData').classList.remove('hidden');
      
      alert('10 t√¢ches de test ajout√©es ! Vous pouvez maintenant tester l\'interface.');
    });

    // Clear mock data
    document.getElementById('clearMockData').addEventListener('click', async () => {
      if (confirm('Supprimer toutes les donn√©es de test ?')) {
        const existingItems = await listSubmissions();
        const mockTitles = [
          "R√©parer irrigation",
          "Tailler haies", 
          "V√©rifier escaliers",
          "Planter arbustes",
          "Nettoyer drains",
          "R√©parer cl√¥ture",
          "Nettoyer panneaux",
          "V√©rifier √©clairage",
          "Maintenir bancs",
          "Contr√¥ler eau"
        ];
        
        for (const item of existingItems) {
          if (mockTitles.includes(item.title)) {
            await deleteSubmission(item.id);
          }
        }
        
        await renderList();
        
        // Show/hide buttons
        document.getElementById('addMockData').classList.remove('hidden');
        document.getElementById('clearMockData').classList.add('hidden');
        
        alert('Donn√©es de test supprim√©es !');
      }
    });

    // Generate beautiful HTML for the report - Professional modern design
    function generateReportHTML(items) {
      const currentDate = new Date().toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const filterInfo = getFilterDescription();
      const sortInfo = getSortDescription();
      
      let html = `
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <title>Rapport des T√¢ches - GlenTasks</title>
          <style>
            @page { 
              margin: 1.5cm; 
              size: A4;
            }
            
            * {
              box-sizing: border-box;
              margin: 0;
              padding: 0;
            }
            
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
              line-height: 1.6; 
              color: #1f2937; 
              margin: 0; 
              padding: 0;
              font-size: 11px;
              background: #ffffff;
            }
            
            .container {
              max-width: 100%;
              margin: 0 auto;
              padding: 0;
            }
            
            .header { 
              text-align: center; 
              border-bottom: 3px solid #6366f1; 
              padding-bottom: 20px; 
              margin-bottom: 25px;
              background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
              padding: 25px 20px;
              border-radius: 8px;
            }
            
            .header h1 { 
              color: #1e293b; 
              margin: 0; 
              font-size: 28px; 
              font-weight: 700;
              letter-spacing: -0.5px;
            }
            
            .header .subtitle { 
              color: #64748b; 
              font-size: 14px; 
              margin-top: 8px;
              font-weight: 500;
            }
            
            .report-info { 
              background: #f1f5f9; 
              border: 1px solid #cbd5e1; 
              border-radius: 8px; 
              padding: 20px; 
              margin-bottom: 25px;
              font-size: 10px;
              box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            
            .report-info h3 { 
              margin: 0 0 15px 0; 
              color: #334155; 
              font-size: 16px;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            
            .info-grid { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
              gap: 15px;
            }
            
            .info-item { 
              display: flex; 
              align-items: center; 
              gap: 8px;
              padding: 8px 12px;
              background: white;
              border-radius: 6px;
              border: 1px solid #e2e8f0;
            }
            
            .info-item strong { 
              color: #475569; 
              min-width: 70px;
              font-weight: 600;
            }
            
            .task-list { 
              margin-top: 20px;
            }
            
            .task-item { 
              border: 1px solid #e2e8f0; 
              border-radius: 8px; 
              margin-bottom: 15px; 
              overflow: hidden;
              page-break-inside: avoid;
              background: white;
              box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            
            .task-header { 
              background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
              padding: 12px 16px; 
              border-bottom: 1px solid #e2e8f0;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            
            .task-title { 
              font-size: 14px; 
              font-weight: 600; 
              color: #1e293b; 
              margin: 0;
              flex: 1;
            }
            
            .task-status { 
              padding: 4px 10px; 
              border-radius: 20px; 
              font-size: 9px; 
              font-weight: 600; 
              text-transform: uppercase;
              letter-spacing: 0.5px;
              white-space: nowrap;
            }
            
            .status-pending { 
              background: #fef3c7; 
              color: #92400e; 
              border: 1px solid #fbbf24;
            }
            
            .status-done { 
              background: #d1fae5; 
              color: #065f46; 
              border: 1px solid #10b981;
            }
            
            .task-body { 
              padding: 16px;
            }
            
            .task-description { 
              margin-bottom: 15px; 
              color: #475569; 
              font-size: 10px;
              line-height: 1.5;
              padding: 10px;
              background: #f8fafc;
              border-radius: 6px;
              border-left: 3px solid #6366f1;
            }
            
            .task-meta { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
              gap: 10px; 
              margin-bottom: 15px;
              font-size: 9px;
            }
            
            .meta-item { 
              display: flex; 
              align-items: center; 
              gap: 6px;
              padding: 6px 10px;
              background: #f8fafc;
              border-radius: 4px;
              border: 1px solid #e2e8f0;
            }
            
            .meta-item strong { 
              color: #475569; 
              min-width: 55px;
              font-weight: 600;
            }
            
            .urgency-high { 
              color: #dc2626; 
              font-weight: 600;
            }
            
            .urgency-medium { 
              color: #ea580c; 
              font-weight: 600;
            }
            
            .urgency-low { 
              color: #16a34a; 
              font-weight: 600;
            }
            
            .unassigned { 
              color: #0891b2; 
              font-weight: 600;
            }
            
            .task-location { 
              background: #eff6ff; 
              border: 1px solid #bfdbfe; 
              border-radius: 6px; 
              padding: 10px; 
              margin-top: 10px;
              font-size: 9px;
            }
            
            .task-location strong { 
              color: #1d4ed8; 
              display: block; 
              margin-bottom: 4px;
              font-weight: 600;
            }
            
            .footer { 
              margin-top: 30px; 
              text-align: center; 
              color: #64748b; 
              font-size: 9px; 
              border-top: 2px solid #e2e8f0; 
              padding-top: 20px;
              background: #f8fafc;
              padding: 20px;
              border-radius: 8px;
            }
            
            .footer p {
              margin: 0;
              font-weight: 500;
            }
            
            .page-break { 
              page-break-before: always; 
            }
            
            .summary-stats {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
              gap: 15px;
              margin-bottom: 25px;
            }
            
            .stat-card {
              background: white;
              border: 1px solid #e2e8f0;
              border-radius: 8px;
              padding: 15px;
              text-align: center;
              box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            
            .stat-number {
              font-size: 24px;
              font-weight: 700;
              color: #6366f1;
              margin-bottom: 5px;
            }
            
            .stat-label {
              font-size: 10px;
              color: #64748b;
              font-weight: 500;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            
            .priority-indicator {
              display: inline-block;
              width: 8px;
              height: 8px;
              border-radius: 50%;
              margin-right: 6px;
            }
            
            .priority-critical { background: #dc2626; }
            .priority-high { background: #ea580c; }
            .priority-normal { background: #16a34a; }
            
            @media print {
              .task-item { 
                page-break-inside: avoid; 
              }
              
              body {
                font-size: 10px;
              }
              
              .header {
                background: #f8fafc !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
              }
              
              .report-info {
                background: #f1f5f9 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
              }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>üìã Rapport des T√¢ches GlenTasks</h1>
              <div class="subtitle">G√©n√©r√© le ${currentDate}</div>
            </div>
            
            <div class="summary-stats">
              <div class="stat-card">
                <div class="stat-number">${items.length}</div>
                <div class="stat-label">Total T√¢ches</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${items.filter(t => t.status === 'Termin√©').length}</div>
                <div class="stat-label">Termin√©es</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${items.filter(t => t.status === 'En cours').length}</div>
                <div class="stat-label">En Cours</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${items.filter(t => t.urgent === 'Au PC !').length}</div>
                <div class="stat-label">Critiques</div>
              </div>
            </div>
            
            <div class="report-info">
              <h3>üìä Informations du Rapport</h3>
              <div class="info-grid">
                <div class="info-item">
                  <strong>Total:</strong> ${items.length} t√¢che(s)
                </div>
                <div class="info-item">
                  <strong>Filtre:</strong> ${filterInfo}
                </div>
                <div class="info-item">
                  <strong>Tri:</strong> ${sortInfo}
                </div>
                <div class="info-item">
                  <strong>Employ√©:</strong> ${selectedEmployee || 'Tous'}
                </div>
              </div>
            </div>
            
            <div class="task-list">
      `;
      
      if (items.length === 0) {
        html += `
          <div style="text-align: center; padding: 40px; color: #64748b; font-style: italic; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
            <div style="font-size: 24px; margin-bottom: 10px;">üìù</div>
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 5px;">Aucune t√¢che trouv√©e</div>
            <div style="font-size: 11px;">Aucune t√¢che ne correspond aux filtres actuels</div>
          </div>
        `;
      } else {
        items.forEach((task, index) => {
          const urgencyClass = task.urgent === "Au PC !" ? "urgency-high" : 
                              task.urgent === "Oui" ? "urgency-medium" : "urgency-low";
          const statusClass = task.status === "Termin√©" ? "status-done" : "status-pending";
          const statusText = task.status === "Termin√©" ? "Termin√©" : "En cours";
          const whoText = (task.who && task.who.length > 0) ? task.who.join(', ') : 'Non assign√©';
          const whoClass = (!task.who || task.who.length === 0) ? "unassigned" : "";
          const deadlineText = task.deadline || 'Aucune √©ch√©ance';
          const createdDate = new Date(task.createdAt).toLocaleDateString('fr-FR');
          
          const priorityClass = task.urgent === "Au PC !" ? "priority-critical" : 
                               task.urgent === "Oui" ? "priority-high" : "priority-normal";
          
          html += `
            <div class="task-item">
              <div class="task-header">
                <h3 class="task-title">
                  <span class="priority-indicator ${priorityClass}"></span>
                  ${index + 1}. ${escapeHtml(task.title)}
                </h3>
                <span class="task-status ${statusClass}">${statusText}</span>
              </div>
              <div class="task-body">
                ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                
                <div class="task-meta">
                  <div class="meta-item">
                    <strong>üö® Urgence:</strong>
                    <span class="${urgencyClass}">${task.urgent}</span>
                  </div>
                  <div class="meta-item">
                    <strong>üë• Assign√©:</strong>
                    <span class="${whoClass}">${escapeHtml(whoText)}</span>
                  </div>
                  <div class="meta-item">
                    <strong>‚è∞ √âch√©ance:</strong>
                    <span>${deadlineText}</span>
                  </div>
                  <div class="meta-item">
                    <strong>üìÖ Cr√©√©:</strong>
                    <span>${createdDate}</span>
                  </div>
                </div>
                
                ${task.location ? `
                  <div class="task-location">
                    <strong>üìç Localisation:</strong>
                    ${escapeHtml(task.location)}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
      }
      
      html += `
            </div>
            
            <div class="footer">
              <p>üìä Rapport g√©n√©r√© par GlenTasks | ${currentDate} | Total: ${items.length} t√¢che(s)</p>
              <p style="margin-top: 8px; font-size: 8px; color: #94a3b8;">Pour cr√©er un PDF, utilisez "Imprimer > Sauvegarder en PDF" dans votre navigateur</p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      return html;
    }
    
    // Helper functions for report generation
    function getFilterDescription() {
      switch (currentFilter) {
        case 'done': return 'T√¢ches termin√©es uniquement';
        case 'pending': return 'T√¢ches en cours uniquement';
        case 'unassigned': return 'T√¢ches non assign√©es uniquement';
        default: return 'Toutes les t√¢ches';
      }
    }
    
    function getSortDescription() {
      const direction = sortDirection === 'desc' ? 'd√©croissant' : 'croissant';
      switch (currentSort) {
        case 'urgency': return `Par urgence (${direction})`;
        case 'deadline': return `Par √©ch√©ance (${direction})`;
        default: return `Par date de cr√©ation (${direction})`;
      }
    }
    
    // Generate and download PDF using Capacitor File System (iOS compatible)
    async function generatePDF(htmlContent) {
      try {
        console.log('Starting report generation...'); // Debug log
        
        // Use Capacitor File System for iOS compatibility
        if (window.Capacitor && window.Capacitor.Plugins.Filesystem) {
          try {
            const filename = `rapport_taches_${new Date().toISOString().split('T')[0]}.html`;
            
            // Save to temporary directory and share
            const result = await window.Capacitor.Plugins.Filesystem.writeFile({
              path: filename,
              data: htmlContent,
              directory: 'CACHE',
              encoding: 'utf8'
            });
            
            // Share the file using iOS share sheet
            if (window.Capacitor.Plugins.Share) {
              await window.Capacitor.Plugins.Share.share({
                title: 'Rapport des T√¢ches GlenTasks',
                text: 'Voici votre rapport des t√¢ches',
                files: [result.uri],
                dialogTitle: 'Partager le rapport'
              });
              alert('Rapport g√©n√©r√© et partag√© avec succ√®s!');
            } else {
              alert(`Rapport g√©n√©r√© avec succ√®s: ${filename}.`);
            }
            
            console.log('Report generated successfully using Capacitor File System');
          } catch (error) {
            console.error('Capacitor File System error:', error);
            // Fallback to blob method for browser
            fallbackReportGeneration(htmlContent);
          }
        } else {
          // Fallback for browser
          fallbackReportGeneration(htmlContent);
        }
        
      } catch (error) {
        console.error('Report generation failed:', error);
        alert('Erreur lors de la g√©n√©ration du rapport: ' + error.message);
      }
    }

    // Fallback report generation for browser (blob method)
    function fallbackReportGeneration(htmlContent) {
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        // Create download link and trigger download
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `rapport_taches_${new Date().toISOString().split('T')[0]}.html`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up URL object
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
      console.log('HTML report downloaded successfully');
        alert('Rapport HTML t√©l√©charg√© ! Ouvrez le fichier dans votre navigateur et utilisez "Imprimer > Sauvegarder en PDF" pour cr√©er un PDF.');
    }

    // Add share functionality for the share button
    document.getElementById('shareApp').addEventListener('click', async () => {
      try {
        if (navigator.share) {
          await navigator.share({
            title: 'GlenTasks - Gestion des T√¢ches',
            text: 'Une app simple et efficace pour g√©rer vos t√¢ches. Essayez-la !',
            url: window.location.href
          });
        } else {
          await navigator.clipboard.writeText(window.location.href);
          alert('‚úÖ Lien copi√© ! Partagez-le avec vos coll√®gues.');
        }
      } catch (error) {
        console.error('Share error:', error);
        // Fallback: copy to clipboard manually
        const textArea = document.createElement('textarea');
        textArea.value = window.location.href;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('‚úÖ Lien copi√© ! Partagez-le avec vos coll√®gues.');
      }
    });
  </script>
</body>
</html>
