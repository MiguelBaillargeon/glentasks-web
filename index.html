<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>GlenTasks | Gestion des Tâches</title>
  <meta name="description" content="GlenTasks - Gestion des tâches simple et efficace">
  <meta name="theme-color" content="#3b82f6">
  <meta name="format-detection" content="telephone=no">
  
  <style>
    /* CSS Variables for consistent theming */
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      
      --radius-sm: 0.25rem;
      --radius: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.3;
      color: var(--gray-800);
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-2);
      background: var(--gray-50);
      font-size: 0.75rem;
    }

    /* Password protection overlay */
    .password-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .password-container {
      background: white;
      padding: var(--space-8);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    .password-header h1 {
      color: var(--primary);
      margin-bottom: var(--space-3);
      font-size: 2rem;
    }
    
    .password-header p {
      color: var(--gray-600);
      margin-bottom: var(--space-6);
    }
    
    .password-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .password-input {
      padding: var(--space-2);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      font-size: 1rem;
      text-align: center;
      transition: border-color 0.2s;
    }
    
    .password-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .password-submit {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--space-2) var(--space-5);
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .password-submit:hover {
      background: var(--primary-dark);
    }

    /* Main app container */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-4);
      display: none; /* Hidden until password is entered */
    }
    
    /* Header styles */
    header {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      max-width: 1000px; /* Match tasks section width */
      margin-left: auto;
      margin-right: auto;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-3);
      max-width: 900px; /* Constrain header content width */
      margin: 0 auto;
    }
    
    .app-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--gray-700);
      margin: 0;
      line-height: 1.2;
    }
    
    .header-actions {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
      align-items: center;
    }
    
    /* Button styles */
    .btn {
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: normal;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    
    .btn-secondary:hover {
      background: var(--gray-200);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-sm {
      padding: var(--space-1) var(--space-3);
      font-size: 0.75rem;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Form styles - Improved for large screens */
    .form-card {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      max-width: 900px; /* Limit max width for better readability */
      margin-left: auto;
      margin-right: auto;
    }
    
    .form-title {
      font-size: 1.375rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-5);
      text-align: center;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Increased min width for better proportions */
      gap: var(--space-4);
      max-width: 800px; /* Limit grid width for better form layout */
      margin: 0 auto;
    }
    
    .form-row {
      display: flex;
      flex-direction: column;
    }
    
    .form-row.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .form-label.required::after {
      content: " *";
      color: var(--danger);
    }
    
    .field-icon {
      font-size: 1.1rem;
      opacity: 0.8;
    }
    
    .form-input,
    .form-textarea {
      padding: var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.775rem;
      transition: border-color 0.2s;
    }
    
    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-textarea-enhanced {
      min-height: 100px;
      line-height: 1.5;
    }
    
    .form-input-title {
      font-size: 0.775rem;
      font-weight: 500;
    }
    
    .field-hint {
      font-size: 0.7rem;
      color: var(--gray-500);
      margin-top: var(--space-1);
      font-style: italic;
    }
    
    /* Form sections */
    .form-section {
      grid-column: 1 / -1;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-2);
      margin: var(--space-2) 0;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-2);
      border-bottom: 2px solid var(--gray-200);
    }
    
    .form-section .form-grid {
      gap: var(--space-3);
    }
    
    .form-section .form-row {
      margin-bottom: var(--space-3);
    }

    /* Compact styling for task characteristics subsections */
    .form-section .form-row .chip-group {
      margin-top: var(--space-1);
    }
    
    .form-section .form-row .field-hint {
      margin-top: var(--space-1);
      font-size: 0.65rem;
    }
    
    .form-section .form-row .form-label {
      margin-bottom: var(--space-1);
      font-size: 0.95rem;
    }

    /* Chip styles */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }
    
    .chip {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chip:hover {
      background: var(--gray-200);
    }

    .chip input[type="checkbox"],
    .chip input[type="radio"] {
      margin: 0;
    }

    .chip input[type="checkbox"]:checked + span,
    .chip input[type="radio"]:checked + span {
      color: var(--primary);
      font-weight: 500;
    }
    
    /* Enhanced chips */
    .chip-enhanced {
      background: white;
      border: 2px solid var(--gray-200);
      padding: var(--space-3) var(--space-4);
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .chip-enhanced:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
      transform: translateY(-1px);
    }
    
    .chip-enhanced input[type="checkbox"]:checked + .chip-text,
    .chip-enhanced input[type="radio"]:checked + .chip-text {
      color: var(--primary);
      font-weight: 600;
    }
    
    .chip-enhanced input[type="checkbox"]:checked,
    .chip-enhanced input[type="radio"]:checked {
      accent-color: var(--primary);
    }
    
    .chip-priority {
      position: relative;
      overflow: visible;
    }
    
    .chip-priority::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gray-300);
      transition: background-color 0.2s;
    }
    
    .chip-priority input[type="radio"]:checked + .chip-text {
      color: var(--primary);
    }
    
    .chip-priority input[type="radio"][value="Oui"]:checked + .chip-text {
      color: var(--warning);
    }
    
    .chip-priority input[type="radio"][value="Au PC !"]:checked + .chip-text {
      color: var(--danger);
    }
    
    .chip-text {
      pointer-events: none;
    }
    
    /* File upload styles */
    .file-upload-container {
      position: relative;
    }
    
    .file-input {
      padding: var(--space-3);
      border: 2px dashed var(--gray-300);
      background: var(--gray-50);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-input:hover {
      border-color: var(--primary);
      background: var(--gray-100);
    }
    
    .file-input:focus {
      border-color: var(--primary);
      background: white;
    }
    
    .file-hint {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: var(--space-2);
      text-align: left;
      display: block;
      width: 100%;
    }
    
    /* Button icon styles */
    .btn-icon {
      margin-right: var(--space-2);
    }

    /* Submit button container */
    .submit-container {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: var(--space-3);
    }

    .submit-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 160px;
    }

    .submit-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .submit-btn:disabled {
      background: var(--gray-400);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }

    .submit-btn:disabled:hover {
      background: var(--gray-400);
      transform: none;
      box-shadow: none;
    }

    /* Controls and sorting - Improved layout for large screens */
    .controls-section {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      max-width: 900px; /* Match form card width */
      margin-left: auto;
      margin-right: auto;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      align-items: end;
      max-width: 800px; /* Limit grid width for better proportions */
      margin: 0 auto;
    }

    .control-group {
      display: flex;
      flex-direction: column;
    }

    .control-label {
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      font-size: 0.85rem;
    }

    .control-select {
      padding: var(--space-2);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
    }
    
    .control-input {
      padding: var(--space-2);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.875rem;
      background: white;
      transition: border-color 0.2s;
    }
    
    .control-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
    }
    
    .control-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Task list - Improved layout for large screens */
    .tasks-section {
      background: white;
      border-radius: var(--radius-md);
      padding: var(--space-3);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      max-width: 1000px; /* Slightly wider than form for task display */
      margin-left: auto;
      margin-right: auto;
    }
    
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      gap: var(--space-4);
      max-width: 900px; /* Match task list width for visual consistency */
      margin-left: auto;
      margin-right: auto;
    }
    
    .tasks-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--space-2);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--gray-200);
    }
    
    .tasks-stats {
      display: flex;
      gap: var(--space-4);
      align-items: center;
    }
    
    .tasks-count {
      background: var(--gray-100);
      color: var(--gray-600);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .unassigned-count {
      background: var(--warning);
      color: white;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 600;
      display: none;
    }
    
    /* Task card container constraints */
    .task-list {
      max-width: 900px; /* Constrain task list width for better readability */
      margin: 0 auto;
    }
    
    /* Task card - Add positioning context for absolute menu button */
    .task-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; /* This creates the positioning context for the menu button */
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      max-width: 100%; /* Ensure cards don't exceed container width */
      overflow: hidden;
    }
    
    .task-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      border-color: var(--gray-300);
    }
    
    .task-card:hover::before {
      opacity: 1;
    }
    
    .task-card.completed {
      opacity: 0.7;
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
    }
    
    .task-card.completed .task-title {
      text-decoration: line-through;
      color: var(--gray-600);
    }
    
    /* Unassigned task styling - subtle */
    .task-card.unassigned {
      border-left: 3px solid var(--warning);
      background: white;
    }
    
    .task-card.unassigned:hover {
      background: linear-gradient(135deg, #fefbf5 0%, #fef7ed 100%);
    }
    
    .unassigned-badge {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: var(--warning);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      z-index: 1;
      box-shadow: var(--shadow-sm);
    }
    
    /* Task header - Simplified layout */
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
      gap: var(--space-3);
      width: 100%;
    }
    
    .task-main-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      min-width: 0;
    }
    
    .task-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-800);
      margin: 0;
      flex: 1;
      line-height: 1.4;
      padding-right: 50px; /* Make space for the menu button */
    }
    
    /* Task actions - Positioned relative to the task card, not the header */
    .task-actions {
      display: flex;
      gap: var(--space-2);
      flex-shrink: 0;
      flex-wrap: wrap;
      position: absolute; /* Position absolutely relative to .task-card */
      top: var(--space-4); /* Same as task-card padding */
      right: var(--space-4); /* Same as task-card padding */
      z-index: 2;
    }
    
    /* Mark as done button - subtle and compact */
    .mark-done-btn {
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    
    .mark-done-btn:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .mark-done-btn:focus {
      outline: 2px solid var(--success);
      outline-offset: 2px;
    }
    
    /* 3 dots menu button */
    .menu-btn {
      position: relative;
      cursor: pointer;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: var(--gray-600);
      flex-shrink: 0;
    }
    
    .menu-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .menu-btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Dropdown menu - Fixed positioning and z-index */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      min-width: 120px;
      z-index: 10001; /* Higher than task-actions */
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      margin-top: var(--space-1);
    }
    
    .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      color: var(--gray-700);
      text-decoration: none;
      transition: background-color 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 0.8rem;
    }
    
    .dropdown-item:hover {
      background: var(--gray-50);
      color: var(--gray-900);
    }
    
    .dropdown-item:first-child {
      border-radius: var(--radius) var(--radius) 0 0;
    }
    
    .dropdown-item:last-child {
      border-radius: 0 0 var(--radius) var(--radius);
    }
    
    .dropdown-item.danger:hover {
      background: #fef2f2;
      color: #dc2626;
    }
    
    .dropdown-item.danger:hover .dropdown-icon {
      color: #dc2626;
    }
    
    .dropdown-icon {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .task-card {
        padding: var(--space-3); /* Reduce padding on mobile */
      }
      
      .task-actions {
        top: var(--space-3); /* Match the reduced padding */
        right: var(--space-3);
        z-index: 2;
      }
      
      .task-title {
        padding-right: 50px; /* Keep space for menu button */
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-size: 1rem;
        line-height: 1.3;
      }
      
      .menu-btn {
        width: 36px;
        height: 36px;
        background: white;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
      }
      
      /* Mobile mark as done button adjustments */
      .mark-done-btn {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
      
      /* Mobile dropdown adjustments */
      .dropdown-menu {
        min-width: 100px;
        right: 0;
        z-index: 10001;
      }
      
      .dropdown-item {
        padding: var(--space-2) var(--space-3);
        font-size: 0.85rem;
      }
    }
    
    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .task-card {
        padding: var(--space-2); /* Even less padding on very small screens */
      }
      
      .task-actions {
        top: var(--space-2); /* Match the reduced padding */
        right: var(--space-2);
        z-index: 2;
      }
      
      .task-title {
        padding-right: 45px;
        font-size: 0.9rem;
        line-height: 1.2;
      }
      
      .menu-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
      }
      
      /* Extra small mobile dropdown adjustments */
      .dropdown-menu {
        min-width: 90px;
        right: 0;
        z-index: 10001;
      }
      
      .dropdown-item {
        padding: var(--space-1) var(--space-2);
        font-size: 0.8rem;
      }
      
      .dropdown-icon {
        font-size: 0.8rem;
      }
    }
    
    .task-quick-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      align-items: center;
      font-size: 0.7rem;
    }
    
    .task-assignee,
    .task-priority,
    .task-status,
    .task-date {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1);
      background: #f8fafc;
      border-radius: var(--radius-sm);
      border: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    
    .task-assignee {
      background: #f1f5f9;
      color: #475569;
      font-weight: 500;
    }
    
    .task-date {
      background: #f8fafc;
      color: #64748b;
      font-size: 0.65rem;
    }
    
    .task-content {
      margin-bottom: var(--space-3);
    }
    
    .task-description {
      color: var(--gray-600);
      margin-bottom: var(--space-2);
      line-height: 1.2;
      font-size: 0.75rem;
      padding: var(--space-2);
      background: #f8fafc;
      border-radius: var(--radius-sm);
      border-left: 2px solid var(--primary);
    }
    
    .task-location {
      color: var(--gray-500);
      font-size: 0.7rem;
      margin-bottom: var(--space-2);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2);
      background: #f8fafc;
      border-radius: var(--radius-sm);
      border-left: 2px solid var(--secondary);
    }
    
    /* Clickable link styling */
    .clickable-link {
      color: var(--primary);
      text-decoration: underline;
      cursor: pointer;
      transition: all 0.2s ease;
      word-break: break-all;
    }
    
    .clickable-link:hover {
      color: var(--primary-dark);
      text-decoration: none;
    }
    
    .clickable-link:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
      border-radius: var(--radius-sm);
    }
    
    .task-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-2);
      padding: var(--space-3);
    }

    .task-meta-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--gray-600);
      font-size: 0.85rem;
      padding: var(--space-2);
      background: white;
      border-radius: var(--radius-sm);
      border: 1px solid var(--gray-200);
    }

    .task-meta-item strong {
      color: var(--gray-700);
      font-weight: 600;
      min-width: 70px;
      font-size: 0.8rem;
    }
    
    .text-muted {
      color: var(--gray-500);
      font-style: italic;
    }
    
    .text-warning {
      color: var(--warning);
      font-weight: 600;
    }
    
    .text-danger {
      color: var(--danger);
    }

    /* Priority indicators - compact */
    .priority-urgent,
    .priority-normal,
    .priority-critical {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      min-width: 60px;
      justify-content: center;
    }

    .priority-urgent {
      background: var(--warning);
      color: white;
    }

    .priority-normal {
      background: var(--gray-500);
      color: white;
    }

    .priority-critical {
      background: var(--danger);
      color: white;
    }

    /* Status indicators - compact */
    .status-en-cours,
    .status-en-attente,
    .status-terminee {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      min-width: 60px;
      justify-content: center;
    }

    .status-en-cours {
      background: var(--primary);
      color: white;
    }

    .status-en-attente {
      background: var(--warning);
      color: white;
    }

    .status-terminee {
      background: var(--success);
      color: white;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .app-container {
        padding: var(--space-2);
        max-width: 100%;
        overflow-x: hidden;
      }
      
      .header-content {
        flex-direction: column;
        text-align: center;
        gap: var(--space-3);
      }
      
      .app-title {
        font-size: 1.75rem;
        line-height: 1.2;
      }
      
      .header-actions {
        justify-content: center;
        flex-wrap: wrap;
        gap: var(--space-1);
      }
      
      .header-actions .btn {
        font-size: 0.8rem;
        padding: var(--space-1) var(--space-2);
        min-height: 44px;
      }
      
      /* Form responsive adjustments */
      .form-card {
        max-width: 100%;
        margin-left: 0;
        margin-right: 0;
        padding: var(--space-3);
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: var(--space-2);
        max-width: 100%;
      }
      
      .controls-section {
        max-width: 100%;
        margin-left: 0;
        margin-right: 0;
        padding: var(--space-3);
      }
      
      .controls-grid {
        grid-template-columns: 1fr;
        gap: var(--space-2);
        max-width: 100%;
      }
      
      .tasks-section {
        max-width: 100%;
        margin-left: 0;
        margin-right: 0;
      }
      
      .characteristics-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
        max-width: 100%;
      }
      
      .task-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-1);
      }
      
      .task-actions {
        align-self: flex-end;
        gap: var(--space-1);
        flex-wrap: wrap;
      }
      
      .task-actions .btn {
        min-width: 40px;
        min-height: 40px;
        padding: var(--space-2);
        font-size: 0.8rem;
      }
      
      .submit-container {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }
      
      .submit-container .btn {
        width: 100%;
        justify-content: center;
        min-height: 48px;
      }
      
      .password-container {
        margin: var(--space-3);
        padding: var(--space-4);
        max-width: 90vw;
      }
      
      .password-header h1 {
        font-size: 1.75rem;
      }
      
      .password-input,
      .password-submit {
        min-height: 48px;
        font-size: 1rem;
      }
      
      /* Prevent horizontal scrolling */
      body {
        overflow-x: hidden;
        width: 100%;
        position: relative;
      }
      
      /* Ensure all containers respect viewport width */
      .form-card,
      .controls-section,
      .tasks-section {
        margin-left: 0;
        margin-right: 0;
        width: 100%;
        box-sizing: border-box;
      }
      
      /* Tighter form card spacing on mobile to avoid "too wide" feel */
      .form-card {
        padding: var(--space-3);
      }
      
      .form-section {
        padding: var(--space-2);
      }
      
      /* Improve form inputs on mobile */
      .form-input,
      .form-textarea,
      .control-input,
      .control-select {
        min-height: 44px;
        font-size: 1rem;
        -webkit-appearance: none;
        appearance: none;
        border-radius: var(--radius);
      }
      
      /* Denser input padding on mobile */
      .form-input,
      .form-textarea,
      .control-input,
      .control-select {
        padding: var(--space-2);
      }
      
      /* Better chip layout on mobile */
      .chip-group {
        gap: var(--space-2);
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      
      .chip {
        min-height: 44px;
        padding: var(--space-2) var(--space-3);
        font-size: 0.9rem;
        width: 100%;
        justify-content: center;
      }
      
      .chip-text {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: break-word;
      }
      
      /* Compact characteristics responsive */
      .characteristics-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }
      
      .compact-chip {
        min-height: 40px;
        padding: var(--space-2);
        font-size: 0.8rem;
      }
      
      .compact-chips {
        gap: var(--space-2);
      }
      
      /* Mobile-specific chip improvements */
      .compact-chip .chip-text {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: normal;
        hyphens: none;
        line-height: 1.2;
        display: block;
        width: 100%;
        text-align: center;
      }
      
      /* Ensure priority chips display properly on mobile */
      .compact-chip.chip-priority {
        min-height: 44px;
        padding: var(--space-2) var(--space-3);
      }
      
      .compact-chip.chip-priority .chip-text {
        font-size: 0.8rem;
        font-weight: 500;
      }
      
      /* Fix form labels and inputs for mobile */
      .form-label {
        font-size: 1rem;
        margin-bottom: var(--space-2);
        line-height: 1.3;
      }
      
      .form-input-title {
        font-size: 1rem;
      }
      
      /* Ensure form text wraps properly on mobile */
      .form-input::placeholder,
      .form-textarea::placeholder {
        font-size: 0.9rem;
        line-height: 1.3;
        white-space: normal;
        overflow-wrap: break-word;
        word-break: break-word;
      }
      
      /* Better field hints on mobile */
      .field-hint {
        font-size: 0.75rem;
        line-height: 1.3;
        margin-top: var(--space-2);
      }
      
      /* Improve section titles on mobile */
      .section-title {
        font-size: 1.1rem;
        margin-bottom: var(--space-3);
        padding-bottom: var(--space-2);
      }
      
      /* Better characteristic labels on mobile */
      .characteristic-label {
        font-size: 0.85rem;
        margin-bottom: var(--space-2);
        line-height: 1.3;
      }
    }
    
    /* Extra small mobile devices */
    @media (max-width: 480px) {
      .app-container {
        padding: var(--space-1);
      }
      
      .app-title {
        font-size: 1.75rem;
      }
      
      .form-title {
        font-size: 1.25rem;
      }
      
      .tasks-title {
        font-size: 1.25rem;
      }
      
      .header-actions .btn {
        font-size: 0.75rem;
        padding: var(--space-1);
      }
      
      .task-actions .btn {
        min-width: 32px;
        min-height: 32px;
        padding: var(--space-1);
      }
      
      .password-container {
        padding: var(--space-4);
        margin: var(--space-2);
      }
      
      .password-header h1 {
        font-size: 1.5rem;
      }
      
      /* Single-column chips on very small screens */
      .chip-group {
        grid-template-columns: 1fr;
      }
      
      /* Compact characteristics on very small screens */
      .compact-section {
        padding: var(--space-2);
        margin: var(--space-1) 0;
      }
      
      .compact-title {
        font-size: 1.1rem;
        margin-bottom: var(--space-2);
      }
      
      .characteristic-label {
        font-size: 0.75rem;
      }
      
      .compact-chip {
        min-height: 36px;
        padding: var(--space-1) var(--space-2);
        font-size: 0.7rem;
      }
      
      /* Compact task cards on very small screens */
      .compact-task {
        padding: var(--space-3);
        margin-bottom: var(--space-2);
      }
      
      .compact-task .task-header {
        gap: var(--space-1);
        margin-bottom: var(--space-1);
      }
      
      .compact-task .task-title {
        font-size: 0.9rem;
        line-height: 1.1;
      }
      
      .task-quick-meta {
        gap: var(--space-1);
        font-size: 0.65rem;
      }
      
      .task-assignee,
      .task-priority,
      .task-status,
      .task-date {
        padding: var(--space-1);
        font-size: 0.6rem;
      }
      
      .compact-task .task-actions .btn {
        min-width: 32px;
        min-height: 32px;
        padding: var(--space-1);
        font-size: 0.75rem;
        background: white;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
        opacity: 0.9;
      }
      
      .compact-task .task-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
        opacity: 1;
      }
      
      .compact-task .menu-btn {
        width: 32px;
        height: 32px;
      }
      
      /* Extra small mobile mark as done button adjustments */
      .mark-done-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
      }
      
      /* Fix form elements for very small screens */
      .form-card {
        padding: var(--space-2);
      }
      
      .form-grid {
        gap: var(--space-2);
      }
      
      .form-label {
        font-size: 0.9rem;
        margin-bottom: var(--space-2);
      }
      
      .form-input,
      .form-textarea {
        font-size: 0.9rem;
        padding: var(--space-2);
        min-height: 40px;
      }
      
      .form-textarea {
        min-height: 80px;
      }
      
      /* Ensure priority labels are fully visible */
      .compact-chip .chip-text {
        font-size: 0.75rem;
        line-height: 1.2;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: normal;
        hyphens: none;
      }
      
      /* Better spacing for characteristics section */
      .characteristics-grid {
        gap: var(--space-2);
      }
      
      .characteristic-item {
        margin-bottom: var(--space-2);
      }
      
      /* Ensure section titles fit */
      .section-title {
        font-size: 1rem;
        margin-bottom: var(--space-2);
        padding-bottom: var(--space-1);
      }
      
      /* Better submit button on small screens */
      .submit-btn {
        padding: var(--space-3) var(--space-6);
        font-size: 0.9rem;
        min-width: 180px;
      }
      
      /* Improve field hints */
      .field-hint {
        font-size: 0.7rem;
        margin-top: var(--space-1);
      }
      
      /* Final mobile improvements for very small screens */
      .compact-chip.chip-priority {
        min-height: 52px;
        padding: var(--space-2) var(--space-1);
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      
      .compact-chip.chip-priority .chip-text {
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        line-height: 1.1;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: normal;
        hyphens: none;
        width: 100%;
        max-width: 100%;
      }
      
      /* Ensure form inputs fit on very small screens */
      .form-input,
      .form-textarea {
        font-size: 0.9rem;
        padding: var(--space-2);
        min-height: 44px;
        width: 100%;
        box-sizing: border-box;
      }
      
      /* Better form section spacing */
      .form-section {
        margin: var(--space-2) 0;
        padding: var(--space-2);
      }
      
      /* Ensure submit button fits */
      .submit-container {
        padding: 0 var(--space-2);
      }
      
      .submit-btn {
        width: 100%;
        max-width: 100%;
        min-width: auto;
        padding: var(--space-3) var(--space-4);
        font-size: 0.9rem;
      }
    }
    
    /* Large screen optimizations */
    @media (min-width: 1200px) {
      header {
        max-width: 900px; /* More constrained on very large screens */
      }
      
      .header-content {
        max-width: 800px; /* More constrained header content */
      }
      
      .form-card {
        max-width: 800px; /* Even more constrained on very large screens */
      }
      
      .form-grid {
        max-width: 700px;
      }
      
      .controls-section {
        max-width: 800px;
      }
      
      .controls-grid {
        max-width: 700px;
      }
      
      .tasks-section {
        max-width: 900px;
      }
      
      .tasks-header {
        max-width: 800px; /* Match task list width on large screens */
      }
      
      .task-list {
        max-width: 800px; /* More constrained task list on large screens */
      }
      
      .characteristics-grid {
        max-width: 700px;
      }
    }
    
    /* Extra large screen optimizations */
    @media (min-width: 1600px) {
      header {
        max-width: 800px; /* Maximum constraint for very wide screens */
      }
      
      .header-content {
        max-width: 700px; /* Maximum constraint for header content */
      }
      
      .form-card {
        max-width: 750px;
      }
      
      .form-grid {
        max-width: 650px;
      }
      
      .controls-section {
        max-width: 750px;
      }
      
      .controls-grid {
        max-width: 650px;
      }
      
      .tasks-section {
        max-width: 850px;
      }
      
      .tasks-header {
        max-width: 750px; /* Match task list width on very large screens */
      }
      
      .task-list {
        max-width: 750px; /* Maximum constraint for task list on very large screens */
      }
      
      .characteristics-grid {
        max-width: 650px;
      }
    }

    /* Prevent horizontal scrolling globally */
    html, body {
      overflow-x: hidden;
      max-width: 100%;
    }
    
    /* Ensure all elements respect container width */
    * {
      box-sizing: border-box;
    }
    
    /* Fix potential overflow issues */
    .app-container,
    .form-card,
    .controls-section,
    .tasks-section {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Accessibility improvements */
    .btn:focus,
    .form-input:focus,
    .form-textarea:focus,
    .control-select:focus,
    .password-input:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    .chip input[type="checkbox"]:focus + span,
    .chip input[type="radio"]:focus + span {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Better touch targets for mobile */
    @media (max-width: 768px) {
      .btn {
        min-height: 40px;
        padding: var(--space-2) var(--space-3);
        white-space: normal;
      }
      
      .chip {
        min-height: 40px;
        padding: var(--space-2) var(--space-3);
      }
      
      .task-actions .btn {
        min-width: 40px;
        min-height: 40px;
        justify-content: center;
      }
      
      .menu-btn {
        min-width: 40px;
        min-height: 40px;
      }
    }

    /* Loading and error states */
    .loading {
      text-align: center;
      padding: var(--space-8);
      color: var(--gray-600);
    }

    .loading-container {
      text-align: center;
      background: white;
      padding: var(--space-8);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: var(--space-4);
      border-radius: var(--radius);
      border: 1px solid #fecaca;
      margin: var(--space-4) 0;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--gray-500);
    }

    .empty-state h3 {
      color: var(--gray-600);
      margin-bottom: var(--space-2);
    }

    /* Animation for new tasks */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .task-card.new {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Smooth transitions for all interactive elements */
    .task-card,
    .btn,
    .form-input,
    .form-textarea,
    .control-select,
    .control-input,
    .chip {
      transition: all 0.2s ease-in-out;
    }
    
    /* Hover effects for better interactivity */
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Smooth filter transitions */
    .task-card {
      transition: opacity 0.3s ease, transform 0.3s ease, filter 0.3s ease;
    }
    
    .task-card.filtered-out {
      opacity: 0;
      transform: scale(0.95);
      filter: blur(1px);
    }
    
    /* Loading skeleton animation */
    @keyframes shimmer {
      0% {
        background-position: -200px 0;
      }
      100% {
        background-position: calc(200px + 100%) 0;
      }
    }
    
    .skeleton {
      background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
      background-size: 200px 100%;
      animation: shimmer 1.5s infinite;
    }
    
    .skeleton-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .skeleton-title {
      height: 24px;
      width: 80%;
      margin-bottom: var(--space-3);
      border-radius: var(--radius-sm);
    }
    
    .skeleton-description {
      height: 16px;
      width: 60%;
      margin-bottom: var(--space-3);
      border-radius: var(--radius-sm);
    }
    
    .skeleton-meta {
      height: 14px;
      width: 40%;
      border-radius: var(--radius-sm);
    }
    
    /* Animation for notifications */
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Search results styling */
    .search-info {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .search-results {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--gray-700);
      font-size: 0.875rem;
    }
    
    .search-results .btn {
      margin-left: var(--space-3);
    }
    
    /* Sorting info styling */
    .search-info:has(.search-results:not(:has(.btn))) {
      background: var(--primary-50, #eff6ff);
      border-color: var(--primary-200, #bfdbfe);
    }
    
    .search-info:has(.search-results:not(:has(.btn))) .search-results {
      color: var(--primary-700, #1d4ed8);
      font-weight: 500;
    }

    /* Mobile-specific improvements */
    @media (max-width: 768px) {
      /* Prevent text overflow */
      .task-title {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
      }
      
      /* Better touch targets */
      input[type="checkbox"],
      input[type="radio"] {
        min-width: 24px;
        min-height: 24px;
      }
      
      /* Improve form layout */
      .form-row {
        margin-bottom: var(--space-2);
      }
      
      /* Better button spacing */
      .task-actions {
        margin-top: var(--space-2);
      }
      
      /* Prevent horizontal scroll in forms */
      .form-grid {
        overflow-x: hidden;
        width: 100%;
      }
      
      /* Better chip wrapping */
      .chip-group {
        justify-content: flex-start;
      }
      
      /* Improve password form on mobile */
      .password-container {
        width: calc(100vw - 2rem);
        max-width: 400px;
      }
      
      /* Ensure form inputs don't overflow */
      .form-input,
      .form-textarea {
        width: 100%;
        box-sizing: border-box;
        overflow-wrap: break-word;
        word-break: break-word;
      }
      
      /* Better placeholder text handling */
      .form-input::placeholder,
      .form-textarea::placeholder {
        overflow-wrap: break-word;
        word-break: break-word;
        white-space: normal;
        line-height: 1.3;
      }
      
      /* Ensure characteristics section fits */
      .compact-section {
        margin: var(--space-2) 0;
        padding: var(--space-3);
      }
      
      .characteristics-grid {
        gap: var(--space-3);
      }
      
      .characteristic-item {
        margin-bottom: var(--space-3);
      }
      
      /* Better chip display on mobile */
      .compact-chip {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        min-height: 48px;
        padding: var(--space-2) var(--space-2);
      }
      
      .compact-chip .chip-text {
        text-align: center;
        line-height: 1.2;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        word-break: normal;
        hyphens: none;
        width: 100%;
      }
    }
    
    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
      .form-input,
      .form-textarea,
      .control-input,
      .control-select {
        -webkit-appearance: none;
        appearance: none;
        border-radius: var(--radius);
      }
      
      .btn {
        -webkit-appearance: none;
        appearance: none;
        -webkit-tap-highlight-color: transparent;
      }
    }
    
    /* Android Chrome specific fixes */
    @media screen and (-webkit-min-device-pixel-ratio: 0) {
      .form-input:focus,
      .form-textarea:focus,
      .control-input:focus,
      .control-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
      }
    }

    /* Prevent text overflow */
    .task-title {
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    /* Ensure form text wraps on mobile */
    .form-label,
    .chip-text,
    .btn,
    .form-input::placeholder,
    .control-input::placeholder,
    .form-textarea::placeholder {
      white-space: normal;
      overflow-wrap: anywhere;
    }
    
    /* Compact characteristics section */
    .compact-section {
      padding: var(--space-3);
      margin: var(--space-2) 0;
    }
    
    .compact-title {
      font-size: 1.1rem;
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--gray-200);
    }
    
    .characteristics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      align-items: start;
      max-width: 800px; /* Limit width for better proportions */
      margin: 0 auto;
    }
    
    .characteristic-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .characteristic-label {
      font-weight: 500;
      color: var(--gray-700);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: var(--space-1);
      margin-bottom: var(--space-1);
    }
    
    .compact-chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    
    .compact-chip {
      background: white;
      border: 1px solid var(--gray-200);
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
      font-weight: 500;
      min-height: 32px;
      transition: all 0.2s ease;
    }
    
    .compact-chip:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
      transform: translateY(-1px);
    }
    
    .compact-chip input[type="checkbox"]:checked + .chip-text,
    .compact-chip input[type="radio"]:checked + .chip-text {
      color: var(--primary);
      font-weight: 600;
    }
    
    .compact-chip input[type="checkbox"]:checked,
    .compact-chip input[type="radio"]:checked {
      accent-color: var(--primary);
    }
    
    /* Compact priority chips */
    .compact-chip.chip-priority {
      position: relative;
      overflow: visible;
    }
    
    .compact-chip.chip-priority::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gray-300);
      transition: background-color 0.2s;
    }
    
    .compact-chip.chip-priority input[type="radio"]:checked + .chip-text {
      color: var(--primary);
    }
    
    .compact-chip.chip-priority input[type="radio"][value="Oui"]:checked + .chip-text {
      color: var(--warning);
    }
    
    .compact-chip.chip-priority input[type="radio"][value="Au PC !"]:checked + .chip-text {
      color: var(--danger);
    }
    
    /* File upload styles */
    .status-termine {
      background: var(--success);
      color: white;
    }

    /* Compact task cards */
    .compact-task {
      padding: var(--space-3);
      margin-bottom: var(--space-2);
    }
    
    .compact-task .task-header {
      margin-bottom: var(--space-2);
      gap: var(--space-2);
    }
    
    .task-main-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    
    .compact-task .task-title {
      font-size: 1rem;
      line-height: 1.3;
      margin-bottom: var(--space-1);
    }
    
    .task-quick-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      align-items: center;
      font-size: 0.7rem;
    }
    
    .task-assignee,
    .task-priority,
    .task-status,
    .task-date {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1);
      background: #f8fafc;
      border-radius: var(--radius-sm);
      border: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    
    .task-assignee {
      background: #f1f5f9;
      color: #475569;
      font-weight: 500;
    }
    
    .task-date {
      background: #f8fafc;
      color: #64748b;
      font-size: 0.65rem;
    }
    
    .compact-task .task-content {
      margin-bottom: var(--space-2);
    }
    
    .compact-task .task-description {
      padding: var(--space-2);
      margin-bottom: var(--space-1);
      font-size: 0.85rem;
      line-height: 1.4;
    }
    
    .compact-task .task-location {
      padding: var(--space-2);
      font-size: 0.8rem;
      line-height: 1.3;
    }
    
    .compact-task .task-actions {
      gap: var(--space-1);
    }
    
    .compact-task .task-actions .btn {
      min-width: 36px;
      min-height: 36px;
      padding: var(--space-1);
      font-size: 0.75rem;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .task-actions .btn {
        min-width: 40px;
        min-height: 40px;
        justify-content: center;
      }
      
      /* Compact task cards responsive */
      .compact-task {
        padding: var(--space-2);
        margin-bottom: var(--space-2);
      }
      
      .compact-task .task-header {
        gap: var(--space-1);
        margin-bottom: var(--space-1);
      }
      
      .compact-task .task-title {
        font-size: 0.95rem;
        line-height: 1.2;
      }
      
      .task-quick-meta {
        gap: var(--space-1);
        font-size: 0.7rem;
      }
      
      .task-assignee,
      .task-priority,
      .task-status,
      .task-date {
        padding: var(--space-1);
        font-size: 0.65rem;
      }
      
      .compact-task .task-actions .btn {
        min-width: 32px;
        min-height: 32px;
        padding: var(--space-1);
        font-size: 0.7rem;
      }
      
      .compact-task .menu-btn {
        width: 32px;
        height: 32px;
      }
    }

    /* Task priority styling - very subtle and gentle */
    .task-priority.priority-urgent {
      background: rgba(245, 158, 11, 0.05);
      color: #92400e;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .task-priority.priority-normal {
      background: rgba(100, 116, 139, 0.05);
      color: #475569;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(100, 116, 139, 0.2);
    }
    
    .task-priority.priority-critical {
      background: rgba(239, 68, 68, 0.05);
      color: #991b1b;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    /* Task status styling - very subtle and gentle */
    .task-status.status-en-cours {
      background: rgba(59, 130, 246, 0.05);
      color: #1e40af;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .task-status.status-en-attente {
      background: rgba(245, 158, 11, 0.05);
      color: #92400e;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .task-status.status-terminee {
      background: rgba(16, 185, 129, 0.05);
      color: #065f46;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .text-warning {
      color: var(--warning);
      font-weight: 600;
    }

    /* Task items - Using app's compact-task styling but less compact for reports */
    .task-card.compact-task { 
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }
    
    .task-card.compact-task:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
      border-color: var(--gray-300);
    }
    
    .task-card.compact-task:last-child {
      margin-bottom: 0;
    }
    
    .task-card.compact-task.completed {
      opacity: 0.7;
      background: var(--gray-50);
    }
    
    .task-card.compact-task.completed .task-title {
      text-decoration: line-through;
      color: var(--gray-600);
    }
    
    .task-card.compact-task.unassigned {
      border-left: 3px solid var(--warning);
      background: white;
    }
    
    .task-header { 
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
      gap: var(--space-3);
    }
    
    .task-main-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .task-title { 
      font-size: 1.1rem;
      font-weight: 600; 
      color: var(--gray-800); 
      margin: 0;
      line-height: 1.4;
      margin-bottom: var(--space-2);
    }
    
    .task-quick-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
      align-items: center;
      font-size: 0.7rem;
    }
    
    .task-assignee,
    .task-priority,
    .task-status,
    .task-date {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1);
      background: #f8fafc;
      border-radius: var(--radius-sm);
      border: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    
    .task-assignee {
      background: #f1f5f9;
      color: #475569;
      font-weight: 500;
    }
    
    .task-date {
      background: #f8fafc;
      color: #64748b;
      font-size: 0.65rem;
    }
    
    .task-content {
      margin-bottom: var(--space-3);
    }
    
    .task-description {
      color: var(--gray-600);
      margin-bottom: var(--space-3);
      line-height: 1.5;
      font-size: 0.9rem;
      padding: var(--space-3);
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      border-left: 2px solid var(--primary);
    }
    
    .task-location {
      color: var(--gray-500);
      font-size: 0.85rem;
      margin-bottom: var(--space-2);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3);
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      border-left: 2px solid var(--secondary);
    }
    
    /* Task priority styling - very subtle and gentle like main app */
    .task-priority.priority-urgent {
      background: rgba(245, 158, 11, 0.05);
      color: #92400e;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .task-priority.priority-normal {
      background: rgba(100, 116, 139, 0.05);
      color: #475569;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(100, 116, 139, 0.2);
    }
    
    .task-priority.priority-critical {
      background: rgba(239, 68, 68, 0.05);
      color: #991b1b;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    /* Task status styling - very subtle and gentle like main app */
    .task-status.status-en-cours {
      background: rgba(59, 130, 246, 0.05);
      color: #1e40af;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .task-status.status-en-attente {
      background: rgba(245, 158, 11, 0.05);
      color: #92400e;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .task-status.status-terminee {
      background: rgba(16, 185, 129, 0.05);
      color: #065f46;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0.1px;
      min-width: 45px;
      justify-content: center;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .text-warning {
      color: var(--warning);
      font-weight: 600;
    }

    /* Priority and status indicators - Ultra compact with eye-friendly colors */
    .priority-urgent, .priority-normal, .priority-critical,
    .status-en-cours, .status-en-attente, .status-terminee {
      padding: var(--space-1);
      border-radius: var(--radius-sm);
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1px;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      min-width: 45px;
      justify-content: center;
    }

    .priority-urgent { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .priority-normal { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .priority-critical { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    .status-en-cours { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    .status-en-attente { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
    .status-terminee { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }

    /* Print styles */
    @media print {
      /* Reset print environment */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      body { 
        background: white !important; 
        padding: 0 !important;
        margin: 0 !important;
        max-width: none !important;
        font-size: 12pt !important;
        line-height: 1.4 !important;
        color: black !important;
      }
      
      /* Header optimization for print - More compact */
      .header { 
        background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important; 
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        margin-bottom: 15pt !important; /* Reduced from 20pt */
        padding: 10pt !important; /* Reduced from 15pt */
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
        border-radius: 0 !important;
        box-shadow: none !important;
      }
      
      .header h1 {
        font-size: 16pt !important; /* Reduced from 18pt */
        margin-bottom: 3pt !important; /* Reduced from 5pt */
        color: white !important;
      }
      
      .header p {
        font-size: 10pt !important; /* Reduced from 12pt */
        color: white !important;
      }
      
      /* Summary cards optimization for print - More compact */
      .summary {
        margin-bottom: 15pt !important; /* Reduced from 20pt */
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
        gap: 8pt !important; /* Reduced from 10pt */
      }
      
      .summary-card {
        background: white !important;
        border: 1pt solid #e5e7eb !important;
        box-shadow: none !important;
        padding: 8pt !important; /* Reduced from 10pt */
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      .summary-number {
        font-size: 14pt !important; /* Reduced from 16pt */
        color: #4f46e5 !important;
      }
      
      .summary-label {
        font-size: 9pt !important; /* Reduced from 10pt */
        color: #6b7280 !important;
      }
      
      /* Tasks section optimization for print */
      .tasks-section {
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        background: white !important;
        border: 1pt solid #e5e7eb !important;
        box-shadow: none !important;
        padding: 15pt !important;
        page-break-inside: auto !important;
        break-inside: auto !important;
      }
      
      .tasks-title {
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        font-size: 14pt !important;
        margin-bottom: 15pt !important;
        padding-bottom: 10pt !important;
        border-bottom: 2pt solid #e5e7eb !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
      }
      
      /* Task items optimization for print */
      .task-item {
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        background: white !important;
        border: 1pt solid #e5e7eb !important;
        box-shadow: none !important;
        padding: 12pt !important;
        margin-bottom: 10pt !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        page-break-before: auto !important;
        break-before: auto !important;
      }
      
      .task-item:last-child {
        margin-bottom: 0 !important;
      }
      
      .task-header {
        margin-bottom: 10pt !important;
        gap: 10pt !important;
      }
      
      .task-title {
        font-size: 12pt !important;
        line-height: 1.3 !important;
        color: black !important;
        margin-bottom: 8pt !important;
      }
      
      /* Task meta optimization for print */
      .task-quick-meta {
        gap: 8pt !important;
        font-size: 10pt !important;
        margin-top: 8pt !important;
        flex-wrap: wrap !important;
      }
      
      .task-assignee,
      .task-priority,
      .task-status,
      .task-date {
        padding: 6pt !important;
        background: #f8fafc !important;
        border: 1pt solid #e2e8f0 !important;
        font-size: 9pt !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      /* Task content optimization for print */
      .task-content {
        margin-bottom: 10pt !important;
      }
      
      .task-description {
        padding: 10pt !important;
        margin-bottom: 8pt !important;
        font-size: 11pt !important;
        line-height: 1.4 !important;
        background: #f8fafc !important;
        border-left: 3pt solid #4f46e5 !important;
        color: #374151 !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      .task-location {
        padding: 10pt !important;
        font-size: 10pt !important;
        line-height: 1.3 !important;
        background: #f8fafc !important;
        border-left: 3pt solid #6b7280 !important;
        color: #6b7280 !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      /* Priority and status indicators for print */
      .priority-urgent, .priority-normal, .priority-critical,
      .status-en-cours, .status-en-attente, .status-terminee {
        padding: 4pt !important;
        font-size: 8pt !important;
        font-weight: 600 !important;
        border: 1pt solid !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      .priority-urgent { 
        background: #fef3c7 !important; 
        color: #92400e !important; 
        border-color: #fde68a !important; 
      }
      .priority-normal { 
        background: #f3f4f6 !important; 
        color: #374151 !important; 
        border-color: #d1d5db !important; 
      }
      .priority-critical { 
        background: #fee2e2 !important; 
        color: #991b1b !important; 
        border-color: #fecaca !important; 
      }
      .status-en-cours { 
        background: #dbeafe !important; 
        color: #1e40af !important; 
        border-color: #93c5fd !important; 
      }
      .status-en-attente { 
        background: #fef3c7 !important; 
        color: #92400e !important; 
        border-color: #fde68a !important; 
      }
      .status-terminee { 
        background: #d1fae5 !important; 
        color: #065f46 !important; 
        border-color: #a7f3d0 !important; 
      }
      
      /* Footer optimization for print */
      .footer {
        max-width: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        margin-top: 20pt !important;
        padding: 15pt !important;
        background: white !important;
        border: 1pt solid #e5e7eb !important;
        box-shadow: none !important;
        page-break-before: avoid !important;
        break-before: avoid !important;
        font-size: 10pt !important;
        color: #6b7280 !important;
      }
      
      /* Compact task optimization for print */
      .compact-task {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }
      
      /* Hide hover effects and animations for print */
      .task-item:hover,
      .summary-card:hover {
        transform: none !important;
        box-shadow: none !important;
      }
      
      /* Ensure proper page margins */
      @page {
        margin: 1in !important;
        size: A4 !important;
      }
      
      /* Force background colors and images for print */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Optimize text for print */
      h1, h2, h3, h4, h5, h6 {
        page-break-after: avoid !important;
        break-after: avoid !important;
      }
      
      /* Prevent orphaned elements */
      p, .task-item {
        orphans: 3 !important;
        widows: 3 !important;
      }
    }

    /* Header responsive improvements */
    @media (min-width: 1200px) {
      header {
        padding: var(--space-2); /* Keep consistent padding */
      }
      
      .header-content {
        gap: var(--space-3); /* Keep consistent spacing */
      }
      
      .app-title {
        font-size: 1.75rem; /* Keep consistent size */
      }
      
      /* Task card improvements for large screens */
      .task-card {
        padding: var(--space-5); /* More padding on large screens */
        margin-bottom: var(--space-4); /* More spacing between cards */
      }
      
      .task-header {
        gap: var(--space-4); /* More spacing in task headers */
        margin-bottom: var(--space-4);
      }
      
      .task-title {
        font-size: 1.2rem; /* Slightly larger task titles */
      }
      
      .task-actions .btn {
        min-width: 40px; /* Larger action buttons */
        min-height: 40px;
        padding: var(--space-3);
      }
      
      .menu-btn {
        width: 40px;
        height: 40px;
      }
    }
    
    @media (min-width: 1600px) {
      header {
        padding: var(--space-4); /* Keep consistent padding */
      }
      
      .header-content {
        gap: var(--space-3); /* Keep consistent spacing */
      }
      
      .app-title {
        font-size: 1.75rem; /* Keep consistent size */
      }
      
      /* Task card improvements for very large screens */
      .task-card {
        padding: var(--space-6); /* Maximum padding for very large screens */
        margin-bottom: var(--space-5); /* Maximum spacing between cards */
      }
      
      .task-header {
        gap: var(--space-5); /* Maximum spacing in task headers */
        margin-bottom: var(--space-5);
      }
      
      .task-title {
        font-size: 1.3rem; /* Maximum task title size */
      }
      
      .task-actions .btn {
        min-width: 44px; /* Maximum action button size */
        min-height: 44px;
        padding: var(--space-4);
      }
      
      .menu-btn {
        width: 44px;
        height: 44px;
      }
    }

    /* Prevent text overflow */
    .task-title {
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    /* Ensure form text wraps on mobile */
    .form-label,
    .chip-text,
    .btn,
    .form-input::placeholder,
    .control-input::placeholder,
    .form-textarea::placeholder {
      white-space: normal;
      overflow-wrap: anywhere;
    }
    
    /* Specific fixes for priority labels to prevent truncation */
    .compact-chip.chip-priority .chip-text {
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: normal;
      hyphens: none;
      line-height: 1.2;
      min-height: 1.2em;
    }
    
    /* Ensure location placeholder text is fully visible */
    .form-input[name="location"]::placeholder {
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
      line-height: 1.3;
    }
    
    /* Better chip text handling */
    .compact-chip .chip-text {
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: normal;
      hyphens: none;
      line-height: 1.2;
      display: block;
      width: 100%;
    }
    
    /* Ensure characteristics section fits properly */
    .compact-section {
      overflow: visible;
    }
    
    .characteristics-grid {
      overflow: visible;
    }
    
    .characteristic-item {
      overflow: visible;
    }

    /* Task location - Ultra compact with eye-friendly colors */
    .task-location {
      color: var(--gray-500);
      font-size: 0.7rem;
      margin-bottom: var(--space-2);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2);
      background: #f8fafc;
      border-radius: var(--radius-sm);
      border-left: 2px solid var(--secondary);
    }
    
    /* Clickable link styling for reports */
    .clickable-link {
      color: var(--primary);
      text-decoration: underline;
      cursor: pointer;
      transition: all 0.2s ease;
      word-break: break-all;
    }
    
    .clickable-link:hover {
      color: var(--primary-dark);
      text-decoration: none;
    }
    
    .clickable-link:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
      border-radius: var(--radius-sm);
    }
    
    /* Subtle attachment styling - More delicate and refined */
    .task-attachments {
      margin-top: var(--space-3);
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      align-items: center;
      padding: var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border: 1px solid #e8eaed;
      font-size: 0.7rem;
      color: var(--gray-600);
      position: relative;
      overflow: hidden;
    }
    
    .task-attachments::before {
      content: "📎";
      margin-right: var(--space-2);
      font-size: 0.75rem;
      opacity: 0.6;
      filter: grayscale(0.3);
    }
    
    .task-attachments::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }
    
    .attachment-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      font-size: 0.65rem;
      color: var(--gray-500);
      text-decoration: none;
      background: white;
      border: 1px solid #e8eaed;
      border-radius: var(--radius-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .attachment-link:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-color: #d1d5db;
      color: var(--gray-700);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .attachment-link:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }
    
    .attachment-link:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
      border-radius: var(--radius-md);
    }
    
    .attachment-icon {
      font-size: 0.7rem;
      opacity: 0.7;
      flex-shrink: 0;
      transition: opacity 0.2s ease;
    }
    
    .attachment-link:hover .attachment-icon {
      opacity: 0.9;
    }
    
    /* Better attachment display on mobile */
    @media (max-width: 768px) {
      .task-attachments {
        margin-top: var(--space-2);
        padding: var(--space-2);
        gap: var(--space-1);
      }
      
      .attachment-link {
        padding: var(--space-1) var(--space-2);
        font-size: 0.7rem;
        max-width: 150px;
      }
      
      .attachment-icon {
        font-size: 0.75rem;
      }
    }
    
    /* Task attachments for print */
    @media print {
      .task-attachments {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
        margin-top: 8pt !important;
        padding: 8pt !important;
        background: #f8fafc !important;
        border: 1pt solid #e2e8f0 !important;
        border-radius: 4pt !important;
      }
      
      .task-attachments::before {
        content: "📎" !important;
        margin-right: 8pt !important;
        font-size: 8pt !important;
        opacity: 0.7 !important;
      }
      
      .attachment-link {
        padding: 4pt 6pt !important;
        font-size: 8pt !important;
        background: white !important;
        border: 1pt solid #d1d5db !important;
        border-radius: 3pt !important;
        color: #374151 !important;
        text-decoration: none !important;
        margin-right: 4pt !important;
        margin-bottom: 4pt !important;
        display: inline-block !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
    }

    /* Task attachments - Refined and delicate styling for reports */
    .task-attachments {
      margin-top: var(--space-2);
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
      align-items: center;
      padding: var(--space-2);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-sm);
      border: 1px solid #e8eaed;
      font-size: 0.65rem;
      color: var(--gray-600);
      position: relative;
      overflow: hidden;
    }
    
    .task-attachments::before {
      content: "📎";
      margin-right: var(--space-2);
      font-size: 0.7rem;
      opacity: 0.6;
      filter: grayscale(0.3);
    }
    
    .task-attachments::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }
    
    .attachment-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      font-size: 0.6rem;
      color: var(--gray-500);
      text-decoration: none;
      background: white;
      border: 1px solid #e8eaed;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
      position: relative;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .attachment-link:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-color: #d1d5db;
      color: var(--gray-700);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    .attachment-icon {
      font-size: 0.65rem;
      opacity: 0.7;
      flex-shrink: 0;
      transition: opacity 0.2s ease;
    }
    
    .attachment-link:hover .attachment-icon {
      opacity: 0.9;
    }

    /* Footer - Ultra compact */
    .footer {
      text-align: center;
      margin-top: var(--space-3);
      padding: var(--space-2);
      color: var(--gray-500);
      font-size: 0.7rem;
      background: white;
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-200);
      max-width: 900px; /* Match header width */
      margin-left: auto;
      margin-right: auto;
    }

    .task-content {
      margin-bottom: var(--space-3);
      position: relative;
    }
    
    .task-description {
      color: var(--gray-600);
      margin-bottom: var(--space-2);
      line-height: 1.5;
      font-size: 0.75rem;
      padding: var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--primary);
      position: relative;
      overflow: hidden;
    }
    
    .task-description::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }
    
    .task-location {
      color: var(--gray-500);
      font-size: 0.7rem;
      margin-bottom: var(--space-2);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--secondary);
      position: relative;
      overflow: hidden;
    }
    
    .task-location::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }

    .task-quick-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      align-items: center;
      font-size: 0.7rem;
      margin-top: var(--space-2);
    }
    
    .task-assignee,
    .task-priority,
    .task-status,
    .task-date {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border: 1px solid #e8eaed;
      white-space: nowrap;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .task-assignee::before,
    .task-priority::before,
    .task-status::before,
    .task-date::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }
    
    .task-assignee:hover,
    .task-priority:hover,
    .task-status:hover,
    .task-date:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border-color: #d1d5db;
    }
    
    .task-assignee {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #475569;
      font-weight: 500;
    }
    
    .task-date {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #64748b;
      font-size: 0.65rem;
    }

    /* Task items - Ultra compact with refined styling */
    .task-item { 
      padding: var(--space-3);
      border: 1px solid #e8eaed; 
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
      background: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      max-width: 900px; /* Match task list width */
      margin-left: auto;
      margin-right: auto;
      position: relative;
      overflow: hidden;
    }
    
    .task-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      border-color: #d1d5db;
    }
    
    .task-item:hover::before {
      opacity: 1;
    }
    
    .task-item:last-child {
      margin-bottom: 0;
    }
    
    .task-header { 
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-3);
      gap: var(--space-3);
    }
    
    .task-title { 
      font-size: 0.9rem;
      font-weight: 600; 
      color: var(--gray-800); 
      margin: 0;
      flex: 1;
      line-height: 1.3;
    }

    /* Task quick meta - Ultra compact with refined styling */
    .task-quick-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      align-items: center;
      font-size: 0.7rem;
      margin-top: var(--space-2);
    }
    
    .task-assignee,
    .task-priority,
    .task-status,
    .task-date {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border: 1px solid #e8eaed;
      white-space: nowrap;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .task-assignee::before,
    .task-priority::before,
    .task-status::before,
    .task-date::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }
    
    .task-assignee:hover,
    .task-priority:hover,
    .task-status:hover,
    .task-date:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border-color: #d1d5db;
    }
    
    .task-assignee {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #475569;
      font-weight: 500;
    }
    
    .task-date {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #64748b;
      font-size: 0.65rem;
    }

    /* Task description - Ultra compact with refined styling */
    .task-description {
      color: var(--gray-600);
      margin-bottom: var(--space-3);
      line-height: 1.4;
      font-size: 0.8rem;
      padding: var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--primary);
      position: relative;
      overflow: hidden;
    }
    
    .task-description::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }

    /* Task location - Ultra compact with refined styling */
    .task-location {
      color: var(--gray-500);
      font-size: 0.75rem;
      margin-bottom: var(--space-3);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3);
      background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--secondary);
      position: relative;
      overflow: hidden;
    }
    
    .task-location::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
    }

    /* Summary cards - Ultra compact grid with refined styling */
    .summary {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Reduced from 100px */
      gap: var(--space-2); /* Reduced from var(--space-2) */
      margin-bottom: var(--space-3); /* Reduced from var(--space-3) */
      max-width: 800px; /* Match main app form width */
      margin-left: auto;
      margin-right: auto;
    }
    
    .summary-card {
      background: white;
      padding: var(--space-2); /* Reduced from var(--space-2) */
      border-radius: var(--radius-md);
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e8eaed;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      border-color: #d1d5db;
    }
    
    .summary-card:hover::before {
      opacity: 1;
    }
    
    .summary-number {
      font-size: 1.1rem; /* Reduced from 1.25rem */
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--space-1);
      line-height: 1;
    }
    
    .summary-label {
      color: var(--gray-600);
      font-size: 0.65rem; /* Reduced from 0.65rem */
      text-transform: uppercase;
      letter-spacing: 0.2px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Password Protection Overlay -->
  <div id="passwordOverlay" class="password-overlay">
    <div class="password-container">
      <div class="password-header">
        <h1>🔐 GlenTasks</h1>
        <p>Entrez le mot de passe pour accéder à l'application</p>
      </div>
      <form class="password-form" id="passwordForm">
        <input 
          type="password" 
          id="passwordInput" 
          class="password-input" 
          placeholder="Mot de passe" 
          required
          autocomplete="current-password"
        >
        <button type="submit" class="password-submit">Accéder</button>
      </form>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="appContainer" class="app-container">
    <!-- Header -->
    <header>
      <div class="header-content">
        <h1 class="app-title">GlenTasks</h1>
        <div class="header-actions">
          <button id="exportCSV" class="btn btn-secondary">
            📊 Exporter CSV
          </button>
        </div>
      </div>
    </header>

    <!-- Task Form -->
    <div class="form-card">
      <h2 class="form-title">Nouvelle Tâche</h2>
      <form id="cmvForm" novalidate>
        <input type="hidden" id="editId" value="">
        
        <div class="form-grid">
          <!-- Title Section -->
          <div class="form-row full-width">
            <label for="title" class="form-label required">
              <span class="field-icon">📝</span>
              Titre de la tâche
            </label>
            <input 
              id="title" 
              name="title" 
              type="text" 
              class="form-input form-input-title" 
              required 
              placeholder="Que faut-il faire ?"
              maxlength="200"
            >
          </div>
          
          <!-- Location Section - Moved up for better flow -->
          <div class="form-row full-width">
            <label for="location" class="form-label">
              <span class="field-icon">📍</span>
              Localisation
            </label>
            <input 
              id="location" 
              name="location" 
              type="text" 
              class="form-input" 
              placeholder="Où se trouve la tâche ? (peut coller un ou des liens Google Maps)"
            >
          </div>
          
          <!-- Description Section - Enhanced -->
          <div class="form-row full-width">
            <label for="description" class="form-label">
              <span class="field-icon">📋</span>
              Description
            </label>
            <textarea 
              id="description" 
              name="description" 
              class="form-input form-textarea form-textarea-enhanced" 
              placeholder="Détails, instructions, contexte..."
              maxlength="1000"
            ></textarea>
          </div>
          
          <!-- Task Characteristics Section -->
          <div class="form-section compact-section">
            <h3 class="section-title compact-title">Caractéristiques de la tâche</h3>
            
            <div class="characteristics-grid">
              <!-- Assignee Section -->
              <div class="characteristic-item">
                <label class="characteristic-label">
                  <span class="field-icon">👥</span>
                  Assignation
                </label>
                <div class="chip-group compact-chips">
                  <label class="chip compact-chip">
                    <input type="checkbox" name="who" value="Éric">
                    <span class="chip-text">Éric</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="checkbox" name="who" value="Fred">
                    <span class="chip-text">Fred</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="checkbox" name="who" value="Audrey">
                    <span class="chip-text">Audrey</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="checkbox" name="who" value="Lucas">
                    <span class="chip-text">Lucas</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="checkbox" name="who" value="Miguel">
                    <span class="chip-text">Miguel</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="checkbox" name="who" value="Autre">
                    <span class="chip-text">Autre</span>
                  </label>
                </div>
              </div>
              
              <!-- Priority Section -->
              <div class="characteristic-item">
                <label class="characteristic-label">
                  <span class="field-icon">🚨</span>
                  Priorité
                </label>
                <div class="chip-group compact-chips">
                  <label class="chip compact-chip chip-priority">
                    <input type="radio" name="urgent" value="Non" checked>
                    <span class="chip-text">Normal</span>
                  </label>
                  <label class="chip compact-chip chip-priority">
                    <input type="radio" name="urgent" value="Oui">
                    <span class="chip-text">Urgent</span>
                  </label>
                  <label class="chip compact-chip chip-priority">
                    <input type="radio" name="urgent" value="Au PC !">
                    <span class="chip-text">Critique</span>
                  </label>
                </div>
              </div>
              
              <!-- Status Section -->
              <div class="characteristic-item">
                <label class="characteristic-label">
                  <span class="field-icon">📊</span>
                  Statut
                </label>
                <div class="chip-group compact-chips">
                  <label class="chip compact-chip">
                    <input type="radio" name="status" value="En cours" checked>
                    <span class="chip-text">En cours</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="radio" name="status" value="En Attente">
                    <span class="chip-text">En Attente</span>
                  </label>
                  <label class="chip compact-chip">
                    <input type="radio" name="status" value="Terminée">
                    <span class="chip-text">Terminée</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Files Section -->
          <div class="form-row full-width">
            <label for="files" class="form-label">
              <span class="field-icon">📎</span>
              Fichiers joints
            </label>
            <div class="file-upload-container">
              <input 
                id="files" 
                name="files" 
                type="file" 
                multiple 
                class="form-input file-input"
                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
              >
            </div>
            <div class="file-hint">Formats acceptés: PDF, images, videos, voice messages</div>
          </div>
        </div>
        
        <div class="submit-container">
          <button type="submit" class="submit-btn" id="submitBtn">
            <span class="btn-icon">💾</span>
            Enregistrer la tâche
          </button>
          <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none; margin-left: var(--space-3);">
            <span class="btn-icon">❌</span>
            Annuler
          </button>
        </div>
      </form>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <div class="controls-grid">
        <div class="control-group">
          <label for="searchInput" class="control-label">🔍 Rechercher</label>
          <input 
            type="text" 
            id="searchInput" 
            class="control-input" 
            placeholder="Rechercher dans les tâches..."
          >
        </div>
        
        <div class="control-group">
          <label for="employeeSelect" class="control-label">Filtrer par employé</label>
          <select id="employeeSelect" class="control-select">
            <option value="">Tous les employés</option>
            <option value="Éric">Éric</option>
            <option value="Fred">Fred</option>
            <option value="Audrey">Audrey</option>
            <option value="Lucas">Lucas</option>
            <option value="Miguel">Miguel</option>
            <option value="Autre">Autre</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="filterSelect" class="control-label">Filtrer par statut</label>
          <select id="filterSelect" class="control-select">
            <option value="all">Toutes les tâches</option>
            <option value="en-cours">En cours</option>
            <option value="en-attente">En Attente</option>
            <option value="terminee">Terminées</option>
            <option value="unassigned">Non assignées</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="sortSelect" class="control-label">Trier par</label>
          <select id="sortSelect" class="control-select">
            <option value="created" selected>Date de création</option>
            <option value="status">Statut</option>
            <option value="urgency">Priorité</option>
          </select>
        </div>
        
        <div class="control-group">
          <button id="generateReport" class="btn btn-primary" style="padding: var(--space-2) var(--space-4); font-size: 0.75rem;">
            📋 Générer Rapport de cette vue
          </button>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="tasks-section">
      <div class="tasks-header">
        <h2 class="tasks-title">Liste des Tâches</h2>
        <div class="tasks-count" id="tasksCount">0 tâches</div>
      </div>
      
      <div id="taskList" class="task-list">
        <!-- Tasks will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <!-- JavaScript Section -->
  <script>
    // ============================================================================
    // GLOBAL VARIABLES AND CONSTANTS
    // ============================================================================
    
    // Password for app access (change this to your desired password)
    const APP_PASSWORD = "g";
    
    // DOM elements - will be initialized after DOM loads
    let $passwordOverlay, $passwordForm, $passwordInput, $appContainer, $cmvForm, $taskList, $tasksCount;
    let $filterSelect, $sortSelect, $employeeSelect, $exportCSV, $generateReport;
    
    // App state
    let currentFilter = 'all';
    let currentSort = 'created';
    let selectedEmployee = '';
    let isEditing = false;
    let editId = null;
    
    // Status weights for sorting
    const STATUS_WEIGHT = {
      "En cours": 1,
      "En Attente": 2,
      "Terminée": 3
    };
    
    // ============================================================================
    // PASSWORD PROTECTION SYSTEM
    // ============================================================================
    
    // Check if user is already authenticated
    function checkAuthentication() {
      const isAuthenticated = sessionStorage.getItem('glentasks_authenticated');
      if (isAuthenticated === 'true') {
        showApp();
      }
    }
    
    // Handle password form submission
    function setupPasswordForm() {
      $passwordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const password = $passwordInput.value.trim();
        
        if (password === APP_PASSWORD) {
          sessionStorage.setItem('glentasks_authenticated', 'true');
          showApp();
          $passwordInput.value = '';
        } else {
          alert('Mot de passe incorrect. Veuillez réessayer.');
          $passwordInput.focus();
        }
      });
    }
    
    // Show the main app
    function showApp() {
      $passwordOverlay.style.display = 'none';
      $appContainer.style.display = 'block';
      initializeApp();
    }
    
    // ============================================================================
    // APP INITIALIZATION
    // ============================================================================
    
    // Initialize the app
    async function initializeApp() {
      try {
        console.log('Initializing GlenTasks app...');
        
        // Initialize database
        await initializeDatabase();
        
        // Set up event listeners
        setupEventListeners();
        
        // Load and display tasks
        await loadTasks();
        
        console.log('App initialization completed successfully');
        
      } catch (error) {
        console.error('App initialization failed:', error);
        alert('Failed to initialize app: ' + error.message);
        
        // Try to show some content even if database fails
        $taskList.innerHTML = '<div class="error">Erreur d\'initialisation: ' + error.message + '</div>';
      }
    }
    
    // ============================================================================
    // DATABASE INITIALIZATION
    // ============================================================================
    
    // Initialize the database
    async function initializeDatabase() {
      try {
        // Check if database exists, if not create it
        const existingData = localStorage.getItem('cmvDB');
        if (!existingData) {
          console.log('No existing database found, creating new one...');
          localStorage.setItem('cmvDB', JSON.stringify([]));
        }
        
        console.log('Database initialized successfully');
      } catch (error) {
        console.error('Database initialization failed:', error);
        throw new Error('Failed to initialize database: ' + error.message);
      }
    }
    
    // ============================================================================
    // DATA NORMALIZATION AND VALIDATION
    // ============================================================================
    
    // Normalize task data structure for consistency
    function normalizeTaskData(item) {
      return {
        id: item.id || Date.now() + Math.random(),
        title: item.title || item.task || 'Tâche sans titre',
        description: item.description || '',
        location: item.location || '',
        who: Array.isArray(item.who) ? item.who : (item.who ? [item.who] : []),
        urgent: item.urgent || 'Non',
        status: item.status || 'En cours',
        createdAt: item.createdAt || new Date().toISOString(),
        files: item.files || [] // Preserve files data
      };
    }
    
    // Validate task data before saving
    function validateTaskData(taskData) {
      const errors = [];
      
      if (!taskData.title || taskData.title.trim().length === 0) {
        errors.push('Le titre de la tâche est requis');
      }
      
      if (taskData.title && taskData.title.trim().length > 200) {
        errors.push('Le titre ne peut pas dépasser 200 caractères');
      }
      
      if (taskData.description && taskData.description.length > 1000) {
        errors.push('La description ne peut pas dépasser 1000 caractères');
      }
      
      return errors;
    }
    
    // ============================================================================
    // EVENT LISTENERS SETUP
    // ============================================================================
    
    // Set up all event listeners
    function setupEventListeners() {
      // Form submission
      $cmvForm.addEventListener('submit', handleFormSubmit);
      
      // Cancel edit button
      document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
      
      // Filter and sort changes
      $filterSelect.addEventListener('change', handleFilterChange);
      $sortSelect.addEventListener('change', handleSortChange);
      $employeeSelect.addEventListener('change', handleEmployeeChange);
      
      // Search input with debouncing
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          debouncedSearch(e.target.value);
        });
      }
      
      // Action buttons
      $exportCSV.addEventListener('click', exportToCSV);
      $generateReport.addEventListener('click', generateReport);
      
      // File input validation
      const filesInput = document.getElementById('files');
      if (filesInput) {
        filesInput.addEventListener('change', () => {
          if (filesInput.files.length > 5) {
            alert('Vous pouvez ajouter jusqu\'à 5 fichiers.');
            filesInput.value = '';
          }
        });
      }
      
      console.log('Event listeners set up successfully');
    }
    
    // ============================================================================
    // FORM HANDLING
    // ============================================================================
    
    // Reset form to initial state
    function resetForm() {
      $cmvForm.reset();
      document.getElementById('editId').value = '';
      isEditing = false;
      editId = null;
      document.getElementById('submitBtn').textContent = '💾 Enregistrer la tâche';
      document.getElementById('cancelEditBtn').style.display = 'none';
      
      // Clear existing files note
      const existingFilesNote = document.getElementById('existingFilesNote');
      if (existingFilesNote) {
        existingFilesNote.remove();
      }
    }
    
    // Handle form submission
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      try {
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '⏳ Enregistrement...';
        submitBtn.disabled = true;
        
        const formData = new FormData($cmvForm);
        const taskData = {
          title: formData.get('title').trim(),
          description: formData.get('description').trim(),
          location: formData.get('location').trim(),
          who: Array.from(formData.getAll('who')),
          urgent: formData.get('urgent'),
          status: formData.get('status'),
          createdAt: new Date().toISOString()
        };
        
        // Process file uploads
        const filesInput = document.getElementById('files');
        
        if (filesInput && filesInput.files.length > 0) {
          const fileEntries = [];
          for (const file of filesInput.files) {
            // Convert File to base64 data URL for localStorage storage
            const fileEntry = {
              name: file.name,
              type: file.type,
              size: file.size,
              data: null
            };
            
            // Read file as data URL synchronously using a Promise
            const fileDataPromise = new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = function(e) {
                resolve(e.target.result);
              };
              reader.onerror = function(e) {
                console.error('Error reading file:', file.name, e);
                resolve(null);
              };
              reader.readAsDataURL(file);
            });
            
            // Wait for file data to be read
            fileEntry.data = await fileDataPromise;
            if (fileEntry.data) {
              fileEntries.push(fileEntry);
            } else {
              console.error('Failed to read file:', file.name);
            }
          }
          taskData.files = fileEntries;
        }
        
        // Validation is now handled in addTask/updateTask functions
        
        // Save task using safe execution
        if (isEditing && editId) {
          await safeExecute(async () => {
            await updateTask(editId, taskData);
            return 'modifiée';
          }, 'task update');
          
          const action = 'modifiée';
          isEditing = false;
          editId = null;
          
          // Reset form and reload tasks
          resetForm();
          await safeExecute(loadTasks, 'task reload after update');
          
          // Show success message
          showSuccess(`Tâche ${action} avec succès !`);
        } else {
          await safeExecute(async () => {
            await addTask(taskData);
            return 'ajoutée';
          }, 'task creation');
          
          // Reset form and reload tasks
          resetForm();
          await safeExecute(loadTasks, 'task reload after creation');
          
          // Show success message
          const action = 'ajoutée';
          showSuccess(`Tâche ${action} avec succès !`);
        }
        
      } catch (error) {
        console.error('Form submission failed:', error);
        // Error is already handled by safeExecute
      } finally {
        // Restore button state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.textContent = isEditing ? '💾 Modifier la tâche' : '💾 Enregistrer la tâche';
        submitBtn.disabled = false;
      }
    }
    
    // ============================================================================
    // TASK MANAGEMENT FUNCTIONS
    // ============================================================================
    
    // Add a new task
    async function addTask(taskData) {
      try {
        // Sanitize input data
        const sanitizedData = sanitizeTaskData(taskData);
        
        // Validate data before saving
        const validationErrors = validateTaskData(sanitizedData);
        if (validationErrors.length > 0) {
          throw new Error('Données invalides: ' + validationErrors.join(', '));
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const normalizedTask = normalizeTaskData(sanitizedData);
        
        items.push(normalizedTask);
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        console.log('Task added successfully:', normalizedTask);
        return normalizedTask;
      } catch (error) {
        console.error('Failed to add task:', error);
        throw new Error('Failed to add task: ' + error.message);
      }
    }
    
    // Update an existing task
    async function updateTask(taskId, taskData) {
      try {
        // Sanitize input data
        const sanitizedData = sanitizeTaskData(taskData);
        
        // Validate data before saving
        const validationErrors = validateTaskData(sanitizedData);
        if (validationErrors.length > 0) {
          throw new Error('Données invalides: ' + validationErrors.join(', '));
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const taskIndex = items.findIndex(item => item.id == taskId);
        
        if (taskIndex === -1) {
          throw new Error('Task not found');
        }
        
        const updatedTask = {
          ...items[taskIndex],
          ...normalizeTaskData(sanitizedData),
          id: parseInt(taskId) // Preserve original ID
        };
        
        items[taskIndex] = updatedTask;
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        console.log('Task updated successfully:', updatedTask);
        return updatedTask;
      } catch (error) {
        console.error('Failed to update task:', error);
        throw new Error('Failed to update task: ' + error.message);
      }
    }
    
    // Delete a task
    async function deleteTask(taskId) {
      try {
        if (!confirm('Êtes-vous sûr de vouloir supprimer cette tâche ?')) {
          return;
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const filteredItems = items.filter(item => item.id != taskId);
        
        localStorage.setItem('cmvDB', JSON.stringify(filteredItems));
        
        console.log('Task deleted successfully');
        await loadTasks();
        showSuccess('Tâche supprimée avec succès !');
      } catch (error) {
        console.error('Failed to delete task:', error);
        showError('Erreur lors de la suppression: ' + error.message);
      }
    }
    
    // Edit a task
    function editTask(taskId) {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const task = items.find(item => item.id == taskId);
        
        if (!task) {
          throw new Error('Task not found');
        }
        
        // Populate form with task data
        document.getElementById('editId').value = task.id;
        document.getElementById('title').value = task.title || '';
        document.getElementById('description').value = task.description || '';
        document.getElementById('location').value = task.location || '';
        
        // Set assignees
        const whoInputs = document.querySelectorAll('input[name="who"]');
        whoInputs.forEach(input => {
          input.checked = task.who && task.who.includes(input.value);
        });
        
        // Set priority
        const urgentInputs = document.querySelectorAll('input[name="urgent"]');
        urgentInputs.forEach(input => {
          input.checked = input.value === task.urgent;
        });
        
        // Set status
        const statusInputs = document.querySelectorAll('input[name="status"]');
        statusInputs.forEach(input => {
          input.checked = input.value === task.status;
        });
        
        // Handle existing files (show info about current files)
        const filesInput = document.getElementById('files');
        if (filesInput && task.files && task.files.length > 0) {
          // Create a note about existing files
          let existingFilesNote = document.getElementById('existingFilesNote');
          if (!existingFilesNote) {
            existingFilesNote = document.createElement('div');
            existingFilesNote.id = 'existingFilesNote';
            existingFilesNote.className = 'file-hint';
            existingFilesNote.style.marginTop = 'var(--space-2)';
            existingFilesNote.style.color = 'var(--gray-600)';
            existingFilesNote.style.fontStyle = 'italic';
            filesInput.parentNode.appendChild(existingFilesNote);
          }
          existingFilesNote.textContent = `📎 Fichiers actuels: ${task.files.map(f => f.name).join(', ')} (sélectionner de nouveaux fichiers pour les remplacer)`;
        } else {
          // Remove existing files note if no files
          const existingFilesNote = document.getElementById('existingFilesNote');
          if (existingFilesNote) {
            existingFilesNote.remove();
          }
        }
        
        // Update form state
        isEditing = true;
        editId = task.id;
        document.getElementById('submitBtn').textContent = '💾 Modifier la tâche';
        document.getElementById('cancelEditBtn').style.display = 'inline-block'; // Show cancel button
        
        // Scroll to form
        document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
        
        console.log('Task loaded for editing:', task);
      } catch (error) {
        console.error('Failed to load task for editing:', error);
        alert('Erreur lors du chargement de la tâche: ' + error.message);
      }
    }
    
    // Mark a task as done
    async function markTaskAsDone(taskId) {
      try {
        if (!confirm('Marquer cette tâche comme terminée ?')) {
          return;
        }
        
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        const taskIndex = items.findIndex(item => item.id == taskId);
        
        if (taskIndex === -1) {
          throw new Error('Task not found');
        }
        
        // Update task status to completed
        items[taskIndex].status = 'Terminée';
        localStorage.setItem('cmvDB', JSON.stringify(items));
        
        console.log('Task marked as done successfully');
        await loadTasks();
        showSuccess('Tâche marquée comme terminée !');
      } catch (error) {
        console.error('Failed to mark task as done:', error);
        showError('Erreur lors de la modification: ' + error.message);
      }
    }
    
    // ============================================================================
    // TASK DISPLAY AND RENDERING
    // ============================================================================
    
    // Load and display tasks
    async function loadTasks() {
      try {
        // Show skeleton loading for better perceived performance
        showSkeletonLoading();
        
        // Small delay to show skeleton (improves UX)
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const items = await listSubmissions();
        console.log('Loaded tasks:', items.map(item => ({ title: item.title, urgent: item.urgent, status: item.status })));
        renderList(items);
        updateTasksCount(items.length);
      } catch (error) {
        console.error('Failed to load tasks:', error);
        $taskList.innerHTML = '<div class="error">Erreur lors du chargement des tâches: ' + error.message + '</div>';
      }
    }
    
    // Get all submissions from database
    async function listSubmissions() {
      try {
        const items = JSON.parse(localStorage.getItem('cmvDB') || '[]');
        
        // Normalize all items for consistency
        const normalizedItems = items.map(item => normalizeTaskData(item));
        
        return normalizedItems;
      } catch (error) {
        console.error('Failed to list submissions:', error);
        throw new Error('Failed to list submissions: ' + error.message);
      }
    }
    
    // Render the task list
    function renderList(items) {
      try {
        if (!items || items.length === 0) {
          $taskList.innerHTML = `
            <div class="empty-state">
              <h3>📝 Aucune tâche trouvée</h3>
              <p>Commencez par ajouter votre première tâche ci-dessus !</p>
            </div>
          `;
          return;
        }
        
        // Apply optimized filtering and sorting
        const filteredItems = filterTasks(items);
        const sortedItems = sortTasks(filteredItems);
        
        console.log('After filtering:', filteredItems.length, 'items');
        console.log('After sorting:', sortedItems.length, 'items');
        console.log('Final sort order:');
        sortedItems.forEach((item, index) => {
          console.log(`${index + 1}. [${item.urgent}] [${item.status}] ${item.title}`);
        });
        
        // Show search results info if searching
        if (searchQuery.trim()) {
          const searchInfo = document.createElement('div');
          searchInfo.className = 'search-info';
          searchInfo.innerHTML = `
            <div class="search-results">
              🔍 Recherche: "${escapeHtml(searchQuery)}" - ${filteredItems.length} résultat${filteredItems.length !== 1 ? 's' : ''}
              <button class="btn btn-sm btn-secondary" onclick="clearSearch()">Effacer</button>
            </div>
          `;
          
          // Insert search info before task list
          if ($taskList.previousElementSibling && $taskList.previousElementSibling.className === 'search-info') {
            $taskList.previousElementSibling.remove();
          }
          $taskList.parentNode.insertBefore(searchInfo, $taskList);
        } else {
          // Remove search info if no search
          const existingSearchInfo = $taskList.previousElementSibling;
          if (existingSearchInfo && existingSearchInfo.className === 'search-info') {
            existingSearchInfo.remove();
          }
        }
        
        // Render tasks
        const tasksHTML = sortedItems.map(item => renderTaskCard(item)).join('');
        $taskList.innerHTML = tasksHTML;
        
        // Add event listeners to action buttons
        addTaskActionListeners();
        
        console.log(`Rendered ${sortedItems.length} tasks`);
      } catch (error) {
        console.error('Failed to render list:', error);
        $taskList.innerHTML = '<div class="error">Erreur lors de l\'affichage des tâches: ' + error.message + '</div>';
      }
    }
    
    // Render a single task card
    function renderTaskCard(item) {
      const priorityClass = getPriorityClass(item.urgent);
      const statusClass = getStatusClass(item.status);
      const isUnassigned = !item.who || item.who.length === 0;
      const assignees = isUnassigned ? 'Non assignée' : item.who.join(', ');
      const isCompleted = item.status === 'Terminée';
      
      return `
        <div class="task-card compact-task ${isCompleted ? 'completed' : ''} ${isUnassigned ? 'unassigned' : ''}" data-id="${item.id}">
          <div class="task-header">
            <div class="task-main-info">
              <h3 class="task-title">${escapeHtml(item.title)}</h3>
              <div class="task-quick-meta">
                <span class="task-assignee ${isUnassigned ? 'text-warning' : ''}">👥 ${escapeHtml(assignees)}</span>
                <span class="task-priority ${priorityClass}">${getPriorityText(item.urgent)}</span>
                <span class="task-status ${statusClass}">${item.status}</span>
                <span class="task-date">📅 ${formatDate(item.createdAt)}</span>
              </div>
            </div>
            <div class="task-actions">
              ${!isCompleted ? `
                <button class="btn btn-success btn-sm mark-done-btn" onclick="markTaskAsDone(${item.id})" title="Marquer comme terminée">
                  ✓
                </button>
              ` : ''}
              <div class="menu-btn" onclick="toggleDropdown(${item.id})" title="Menu">
                ⋯
              </div>
              <div class="dropdown-menu" id="dropdown-${item.id}">
                <button class="dropdown-item" onclick="editTask(${item.id})">
                  <span class="dropdown-icon">✏️</span>
                  Modifier
                </button>
                <button class="dropdown-item danger" onclick="deleteTask(${item.id})">
                  <span class="dropdown-icon">🗑️</span>
                  Supprimer
                </button>
              </div>
            </div>
          </div>
          
          ${(item.description || item.location) ? `
            <div class="task-content">
              ${item.description ? `<div class="task-description">${makeLinksClickable(escapeHtml(item.description))}</div>` : ''}
              ${item.location ? `<div class="task-location">📍 ${makeLinksClickable(escapeHtml(item.location))}</div>` : ''}
            </div>
          ` : ''}
          
          ${(item.files && item.files.length > 0) ? `
            <div class="task-attachments">
              ${item.files.map(file => `
                <a href="${file.data}" 
                   download="${file.name}" 
                   class="attachment-link" 
                   title="Télécharger ${file.name}">
                  <span class="attachment-icon">📄</span>
                  ${escapeHtml(file.name)}
                </a>
          `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }
    
    // Add event listeners to task action buttons
    function addTaskActionListeners() {
      // Event listeners are added via onclick attributes in the HTML
      // This function can be used for more complex event handling if needed
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    // Show success notification
    function showSuccess(message) {
      // Create a temporary success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: var(--space-4);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        max-width: 300px;
        animation: slideInRight 0.3s ease-out;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
    
    // Show error message
    function showError(message) {
      alert(message); // Keep simple for now, can be enhanced later
    }
    
    // Get priority CSS class
    function getPriorityClass(priority) {
      switch (priority) {
        case 'Oui': return 'priority-urgent';
        case 'Au PC !': return 'priority-critical';
        default: return 'priority-normal';
      }
    }
    
    // Get priority display text
    function getPriorityText(priority) {
      switch (priority) {
        case 'Oui': return 'Urgent';
        case 'Au PC !': return 'Critique';
        default: return 'Normal';
      }
    }
    
    // Get status CSS class
    function getStatusClass(status) {
      switch (status) {
        case 'Terminée': return 'status-terminee';
        case 'En Attente': return 'status-en-attente';
        default: return 'status-en-cours';
      }
    }
    
    // Check if task is overdue
    function isTaskOverdue(item) {
      if (!item.deadline || item.status === 'Terminée') return false;
      const deadline = new Date(item.deadline);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return deadline < today;
    }
    
    // Format date for display
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        return 'Date invalide';
      }
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (typeof text !== 'string') return text;
      
      const div = document.createElement('div');
      div.textContent = text;
      return div.textContent;
    }
    
    // Convert URLs in text to clickable links
    function makeLinksClickable(text) {
      if (typeof text !== 'string') return text;
      
      // Enhanced URL regex pattern to detect various types of links
      const urlRegex = /(https?:\/\/[^\s]+|maps\.google\.com\/[^\s]+|goo\.gl\/[^\s]+|bit\.ly\/[^\s]+|tinyurl\.com\/[^\s]+|maps\.apple\.com\/[^\s]+|openstreetmap\.org\/[^\s]+|bing\.com\/maps\/[^\s]+|waze\.com\/[^\s]+)/gi;
      
      return text.replace(urlRegex, (url) => {
        // Ensure URL has protocol
        const fullUrl = url.startsWith('http') ? url : `https://${url}`;
        return `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer" class="clickable-link">${url}</a>`;
      });
    }
    
    // Update tasks count display
    function updateTasksCount(count) {
      $tasksCount.textContent = `${count} tâche${count !== 1 ? 's' : ''}`;
    }
    
    // Update unassigned count display
    function updateUnassignedCount(count) {
      document.getElementById('unassignedCount').textContent = `${count} tâche${count !== 1 ? 's' : ''} non assignée`;
      document.getElementById('unassignedCount').style.display = count > 0 ? 'block' : 'none';
    }
    
    // ============================================================================
    // FILTER AND SORT HANDLERS
    // ============================================================================
    
    // Handle filter change
    async function handleFilterChange(e) {
      currentFilter = e.target.value;
      await loadTasks();
    }
    
    // Handle sort change
    async function handleSortChange(e) {
      currentSort = e.target.value;
      await loadTasks();
    }
    
    // Handle employee filter change
    async function handleEmployeeChange(e) {
      selectedEmployee = e.target.value;
      await loadTasks();
    }
    
    // ============================================================================
    // EXPORT AND SHARING FUNCTIONS
    // ============================================================================
    
    // Export tasks to CSV
    async function exportToCSV() {
      try {
        const items = await listSubmissions();
        
        if (items.length === 0) {
          alert('Aucune tâche à exporter.');
          return;
        }
        
        // Create CSV content
        const headers = ['Titre', 'Description', 'Localisation', 'Assigné à', 'Priorité', 'Statut', 'Date de création'];
        const csvContent = [
          headers.join(','),
          ...items.map(item => [
            `"${(item.title || '').replace(/"/g, '""')}"`,
            `"${(item.description || '').replace(/"/g, '""')}"`,
            `"${(item.location || '').replace(/"/g, '""')}"`,
            `"${(item.who ? item.who.join('; ') : '').replace(/"/g, '""')}"`,
            `"${item.urgent || ''}"`,
            `"${item.status || ''}"`,
            `"${item.createdAt ? formatDate(item.createdAt) : ''}"`
          ].join(','))
        ].join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
        link.setAttribute('download', `glentasks_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
        
        console.log('CSV exported successfully');
        alert('Export CSV réussi !');
      } catch (error) {
        console.error('CSV export failed:', error);
        alert('Erreur lors de l\'export CSV: ' + error.message);
      }
    }
    
    // Share app URL
    function shareApp() {
      // Function removed - no longer needed
    }
    
    // ============================================================================
    // MOCK DATA FUNCTIONS
    // ============================================================================
    
    // Add mock data for testing - REMOVED
    // async function addMockData() { ... }
    
    // Clear mock data - REMOVED
    // async function clearMockData() { ... }
    
    // ============================================================================
    // REPORT GENERATION
    // ============================================================================
    
    // Generate and download report
    async function generateReport() {
      try {
        console.log('Report generation started...');
            
        // Get current filtered and sorted items
        let items = await listSubmissions();
        
        // Apply the same filtering logic as renderList
        items.forEach(it => {
          if (!it.status) it.status = "En cours";
          if (!it.title && it.task) it.title = it.task;
          if (!it.description) it.description = "";
        });
        
        // Apply current filters
        items = items.filter(it => {
          if (selectedEmployee && (!it.who || !it.who.includes(selectedEmployee))) {
            return false;
          }
          
          switch (currentFilter) {
            case 'terminee':
              return it.status === "Terminée";
            case 'en-cours':
              return it.status === "En cours";
            case 'en-attente':
              return it.status === "En Attente";
            case 'unassigned':
              return !it.who || it.who.length === 0;
            default:
              return true;
          }
        });
        
        // Apply current sorting
        items.sort((a, b) => {
          const wa = STATUS_WEIGHT[a.status] ?? 0;
          const wb = STATUS_WEIGHT[b.status] ?? 0;
          if (wa !== wb) return wa - wb;
          
          let sortResult = 0;
          switch (currentSort) {
            case 'urgency':
              // Define priority order: Critical (Au PC !) > Urgent (Oui) > Normal (Non)
              const urgencyOrder = { 
                "Au PC !": 3, 
                "Oui": 2, 
                "Non": 1 
              };
              const urgencyA = urgencyOrder[a.urgent] || 0;
              const urgencyB = urgencyOrder[b.urgent] || 0;
              sortResult = urgencyB - urgencyA; // Higher priority first
              
              // If same priority, sort by creation date (newer first)
              if (sortResult === 0) {
                sortResult = new Date(b.createdAt) - new Date(a.createdAt);
              }
              
              console.log(`Comparing ${a.title} (${a.urgent}=${urgencyA}, ${a.status}) vs ${b.title} (${b.urgent}=${urgencyB}, ${b.status}) => ${sortResult}`);
              break;
            case 'created':
              sortResult = new Date(b.createdAt) - new Date(a.createdAt);
              break;
            case 'deadline':
              const today = new Date().setHours(0,0,0,0);
              const deadlineA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
              const deadlineB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
              
              // Overdue tasks first (but only among non-done tasks)
              const overdueA = deadlineA < today && a.status !== "Terminée";
              const overdueB = deadlineB < today && b.status !== "Terminée";
              if (overdueA !== overdueB) {
                sortResult = overdueB - overdueA;
              } else {
                sortResult = deadlineA - deadlineB;
              }
              break;
            default: // status
              sortResult = STATUS_WEIGHT[a.status] - STATUS_WEIGHT[b.status];
          }
          
          return sortResult;
        });
        
        console.log('Items after filtering:', items.length);
        
        // Generate report HTML
        const reportHTML = generateReportHTML(items);
        
        // Generate report using web APIs
        fallbackReportGeneration(reportHTML);
        
      } catch (error) {
        console.error('Report generation failed:', error);
        alert('Erreur lors de la génération du rapport: ' + error.message);
      }
    }
    
    // Fallback report generation for browser (blob method)
    function fallbackReportGeneration(htmlContent) {
      const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `rapport_glentasks_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      console.log('Report generated using fallback method');
      alert('Rapport généré avec succès !');
    }
    
    // Generate report HTML content
    function generateReportHTML(items) {
      const now = new Date();
      const totalTasks = items.length;
      const completedTasks = items.filter(item => item.status === 'Terminée').length;
      const pendingTasks = items.filter(item => item.status === 'En cours').length;
      const waitingTasks = items.filter(item => item.status === 'En Attente').length;
      const criticalTasks = items.filter(item => item.urgent === 'Au PC !').length;
      
      return `
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>Rapport GlenTasks - ${now.toLocaleDateString('fr-FR')}</title>
          <style>
            /* CSS Variables for consistent theming - Eye-friendly colors */
            :root {
              --primary: #4f46e5;
              --primary-dark: #3730a3;
              --secondary: #6b7280;
              --success: #059669;
              --warning: #d97706;
              --danger: #dc2626;
              --gray-50: #f9fafb;
              --gray-100: #f3f4f6;
              --gray-200: #e5e7eb;
              --gray-300: #d1d5db;
              --gray-400: #9ca3af;
              --gray-500: #6b7280;
              --gray-600: #4b5563;
              --gray-700: #374151;
              --gray-800: #1f2937;
              --gray-900: #111827;
              
              --space-1: 0.25rem;
              --space-2: 0.5rem;
              --space-3: 0.75rem;
              --space-4: 1rem;
              --space-5: 1.25rem;
              --space-6: 1.5rem;
              --space-8: 2rem;
              --space-10: 2.5rem;
              --space-12: 3rem;
              
              --radius-sm: 0.25rem;
              --radius: 0.375rem;
              --radius-md: 0.5rem;
              --radius-lg: 0.75rem;
              --radius-xl: 1rem;
              
              --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
              --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
              --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
              --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            }

            /* Reset and base styles */
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }

            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
              line-height: 1.3; 
              color: var(--gray-800);
              max-width: 1200px;
              margin: 0 auto;
              padding: var(--space-2);
              background: var(--gray-50);
              font-size: 0.75rem;
            }

            /* Header - Ultra compact with eye-friendly colors */
            .header { 
              text-align: center; 
              margin-bottom: var(--space-2); /* Reduced from var(--space-3) */
              padding: var(--space-2); /* Reduced from var(--space-3) */
              background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
              color: white;
              border-radius: var(--radius-md);
              box-shadow: var(--shadow);
              max-width: 900px; /* Match main app header width */
              margin-left: auto;
              margin-right: auto;
            }
            
            .header h1 { 
              margin: 0; 
              font-size: 1.1rem; /* Reduced from 1.25rem */
              font-weight: 700;
              margin-bottom: var(--space-1); /* Reduced spacing */
            }
            
            .header p {
              margin: 0;
              font-size: 0.7rem; /* Reduced from 0.8rem */
              opacity: 0.9;
              font-weight: 500;
            }

            /* Summary cards - Ultra compact grid with muted colors */
            .summary {
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Reduced from 100px */
              gap: var(--space-1); /* Reduced from var(--space-2) */
              margin-bottom: var(--space-2); /* Reduced from var(--space-3) */
              max-width: 800px; /* Match main app form width */
              margin-left: auto;
              margin-right: auto;
            }
            
            .summary-card {
              background: white;
              padding: var(--space-1); /* Reduced from var(--space-2) */
              border-radius: var(--radius);
              text-align: center;
              box-shadow: var(--shadow-sm);
              border: 1px solid var(--gray-200);
              transition: transform 0.2s ease;
            }
            
            .summary-card:hover {
              transform: translateY(-1px);
              box-shadow: var(--shadow);
            }
            
            .summary-number {
              font-size: 1rem; /* Reduced from 1.25rem */
              font-weight: 700;
              color: var(--primary);
              margin-bottom: var(--space-1);
              line-height: 1;
            }
            
            .summary-label {
              color: var(--gray-600);
              font-size: 0.6rem; /* Reduced from 0.65rem */
              text-transform: uppercase;
              letter-spacing: 0.2px;
              font-weight: 600;
            }

            /* Tasks section - Ultra compact */
            .tasks-section {
              background: white;
              border-radius: var(--radius-md);
              padding: var(--space-3);
              box-shadow: var(--shadow);
              border: 1px solid var(--gray-200);
              max-width: 1000px; /* Match main app tasks section width */
              margin-left: auto;
              margin-right: auto;
            }
            
            .tasks-title {
              font-size: 1rem;
              font-weight: 600;
              color: var(--gray-800);
              margin-bottom: var(--space-2);
              padding-bottom: var(--space-2);
              border-bottom: 1px solid var(--gray-200);
              max-width: 900px; /* Match task list width */
              margin-left: auto;
              margin-right: auto;
            }

            /* Task items - Ultra compact */
            .task-item { 
              padding: var(--space-2);
              border: 1px solid var(--gray-200); 
              border-radius: var(--radius-sm);
              margin-bottom: var(--space-2);
              background: white;
              transition: all 0.2s ease;
              box-shadow: var(--shadow-sm);
              max-width: 900px; /* Match task list width */
              margin-left: auto;
              margin-right: auto;
            }
            
            .task-item:hover {
              transform: translateY(-1px);
              box-shadow: var(--shadow);
              border-color: var(--gray-300);
            }
            
            .task-item:last-child {
              margin-bottom: 0;
            }
            
            .task-header { 
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: var(--space-2);
              gap: var(--space-2);
            }
            
            .task-title { 
              font-size: 0.85rem;
              font-weight: 600; 
              color: var(--gray-800); 
              margin: 0;
              flex: 1;
              line-height: 1.2;
            }

            /* Task quick meta - Ultra compact */
            .task-quick-meta {
              display: flex;
              flex-wrap: wrap;
              gap: var(--space-1);
              align-items: center;
              font-size: 0.7rem;
              margin-top: var(--space-1);
            }
            
            .task-assignee,
            .task-priority,
            .task-status,
            .task-date {
              display: inline-flex;
              align-items: center;
              gap: var(--space-1);
              padding: var(--space-2) var(--space-3);
              background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
              border-radius: var(--radius-md);
              border: 1px solid #e8eaed;
              white-space: nowrap;
              transition: all 0.2s ease;
              position: relative;
              overflow: hidden;
            }
            
            .task-assignee::before,
            .task-priority::before,
            .task-status::before,
            .task-date::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 1px;
              background: linear-gradient(90deg, transparent 0%, #e8eaed 20%, #e8eaed 80%, transparent 100%);
            }
            
            .task-assignee:hover,
            .task-priority:hover,
            .task-status:hover,
            .task-date:hover {
              transform: translateY(-1px);
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              border-color: #d1d5db;
            }
            
            .task-assignee {
              background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
              color: #475569;
              font-weight: 500;
            }
            
            .task-date {
              background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
              color: #64748b;
              font-size: 0.65rem;
            }

            /* Task description - Ultra compact with eye-friendly colors */
            .task-description {
              color: var(--gray-600);
              margin-bottom: var(--space-2);
              line-height: 1.2;
              font-size: 0.75rem;
              padding: var(--space-2);
              background: #f8fafc;
              border-radius: var(--radius-sm);
              border-left: 2px solid var(--primary);
            }

            /* Task location - Ultra compact with eye-friendly colors */
            .task-location {
              color: var(--gray-500);
              font-size: 0.7rem;
              margin-bottom: var(--space-2);
              font-style: italic;
              display: flex;
              align-items: center;
              gap: var(--space-1);
              padding: var(--space-2);
              background: #f8fafc;
              border-radius: var(--radius-sm);
              border-left: 2px solid var(--secondary);
            }

            /* Task meta - Ultra compact grid layout */
            .task-meta { 
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
              gap: var(--space-1);
              padding: var(--space-2);
              background: var(--gray-50);
              border-radius: var(--radius-sm);
              border: 1px solid var(--gray-200);
              font-size: 0.7rem;
            }
            
            .task-meta-item {
              display: flex; 
              align-items: center; 
              gap: var(--space-1);
              color: var(--gray-600);
              padding: var(--space-1);
              background: white;
              border-radius: var(--radius-sm);
              border: 1px solid var(--gray-200);
            }
            
            .task-meta-item strong {
              color: var(--gray-700);
              font-weight: 600;
              min-width: 40px;
              font-size: 0.65rem;
            }

            /* Priority and status indicators - Ultra compact */
            .priority-urgent, .priority-normal, .priority-critical,
            .status-en-cours, .status-en-attente, .status-terminee {
              padding: var(--space-1);
              border-radius: var(--radius-sm);
              font-size: 0.6rem;
              font-weight: 600;
              text-transform: uppercase;
              letter-spacing: 0.1px;
              display: inline-flex;
              align-items: center;
              gap: var(--space-1);
              min-width: 45px;
              justify-content: center;
            }

            .priority-urgent { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
            .priority-normal { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
            .priority-critical { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
            .status-en-cours { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
            .status-en-attente { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
            .status-terminee { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }

            /* Footer - Ultra compact */
            .footer { 
              text-align: center; 
              margin-top: var(--space-3);
              padding: var(--space-2);
              color: var(--gray-500);
              font-size: 0.7rem;
              background: white;
              border-radius: var(--radius-md);
              border: 1px solid var(--gray-200);
              max-width: 900px; /* Match header width */
              margin-left: auto;
              margin-right: auto;
            }

            /* Responsive design */
            @media (max-width: 768px) {
              body {
                padding: var(--space-2);
                font-size: 0.7rem;
              }
              
              .header {
                padding: var(--space-2);
                margin-bottom: var(--space-2);
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
              }
              
              .header h1 {
                font-size: 1.1rem;
              }
              
              .summary {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-2);
                margin-bottom: var(--space-2);
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
              }
              
              .summary-card {
                padding: var(--space-2);
              }
              
              .summary-number {
                font-size: 1.1rem;
              }
              
              .tasks-section {
                padding: var(--space-2);
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
              }
              
              .tasks-title {
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
              }
              
              .task-item {
                padding: var(--space-2);
                margin-bottom: var(--space-2);
                max-width: 100%;
                margin-left: 0;
                margin-right: 0;
              }
              
              .compact-task {
                padding: var(--space-3);
              }
              
              .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-2);
              }
              
              .task-quick-meta {
                gap: var(--space-2);
                font-size: 0.8rem;
              }
              
              .task-assignee,
              .task-priority,
              .task-status,
              .task-date {
                padding: var(--space-2);
                font-size: 0.75rem;
              }
              
              .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-1);
              }
              
              .task-meta {
                grid-template-columns: 1fr;
                gap: var(--space-1);
                padding: var(--space-2);
              }
              
              .task-meta-item {
                padding: var(--space-1);
                font-size: 0.65rem;
              }
              
              .task-meta-item strong {
                min-width: 35px;
                font-size: 0.6rem;
              }
            }

            @media (max-width: 480px) {
              body {
                padding: var(--space-1);
              }
              
              .header {
                padding: var(--space-2);
              }
              
              .header h1 {
                font-size: 1rem;
              }
              
              .summary {
                grid-template-columns: 1fr;
              }
              
              .tasks-section {
                padding: var(--space-2);
              }
              
              .compact-task {
                padding: var(--space-3);
              }
              
              .task-item {
                padding: var(--space-2);
              }
            }
            
            /* Large screen optimizations for reports */
            @media (min-width: 1200px) {
              .header {
                max-width: 800px;
              }
              
              .summary {
                max-width: 700px;
              }
              
              .tasks-section {
                max-width: 900px;
              }
              
              .tasks-title {
                max-width: 800px;
              }
              
              .task-item {
                max-width: 800px;
              }
              
              .footer {
                max-width: 800px;
              }
            }
            
            /* Extra large screen optimizations for reports */
            @media (min-width: 1600px) {
              .header {
                max-width: 750px;
              }
              
              .summary {
                max-width: 650px;
              }
              
              .tasks-section {
                max-width: 850px;
              }
              
              .tasks-title {
                max-width: 750px;
              }
              
              .task-item {
                max-width: 750px;
              }
              
              .footer {
                max-width: 750px;
              }
            }
            
            /* Print styles */
            @media print {
              body { 
                background: white; 
                padding: 0;
                max-width: none;
              }
              
              .header { 
                background: var(--primary) !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin-bottom: var(--space-3);
                padding: var(--space-3);
                max-width: none;
                margin-left: 0;
                margin-right: 0;
              }
              
              .summary {
                margin-bottom: var(--space-3);
                max-width: none;
                margin-left: 0;
                margin-right: 0;
              }
              
              .tasks-section {
                max-width: none;
                margin-left: 0;
                margin-right: 0;
              }
              
              .tasks-title {
                max-width: none;
                margin-left: 0;
                margin-right: 0;
              }
              
              .task-item {
                max-width: none;
                margin-left: 0;
                margin-right: 0;
              }
              
              .footer {
                max-width: none;
                margin-left: 0;
                margin-right: 0;
              }
              
              .compact-task {
                break-inside: avoid;
                page-break-inside: avoid;
              }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>📋 GlenTasks</h1>
            <p>${now.toLocaleDateString('fr-FR', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</p>
          </div>
          
          <div class="summary">
            <div class="summary-card">
              <div class="summary-number">${totalTasks}</div>
              <div class="summary-label">Total</div>
            </div>
            <div class="summary-card">
              <div class="summary-number">${pendingTasks}</div>
              <div class="summary-label">En cours</div>
            </div>
            <div class="summary-card">
              <div class="summary-number">${waitingTasks}</div>
              <div class="summary-label">En Attente</div>
            </div>
            <div class="summary-card">
              <div class="summary-number">${completedTasks}</div>
              <div class="summary-label">Terminées</div>
            </div>
            <div class="summary-card">
              <div class="summary-number">${criticalTasks}</div>
              <div class="summary-label">Critiques</div>
            </div>
          </div>
          
          <div class="tasks-section">
            <h2 class="tasks-title">Tâches</h2>
            ${items.map(item => {
              const priorityClass = getPriorityClass(item.urgent);
              const statusClass = getStatusClass(item.status);
              const isUnassigned = !item.who || item.who.length === 0;
              const assignees = isUnassigned ? 'Non assignée' : item.who.join(', ');
              
              return `
                <div class="task-card compact-task ${item.status === 'Terminée' ? 'completed' : ''} ${isUnassigned ? 'unassigned' : ''}" data-id="${item.id}">
                  <div class="task-header">
                    <div class="task-main-info">
                      <h3 class="task-title">${escapeHtml(item.title)}</h3>
                      <div class="task-quick-meta">
                        <span class="task-assignee ${isUnassigned ? 'text-warning' : ''}">👥 ${escapeHtml(assignees)}</span>
                        <span class="task-priority ${priorityClass}">${getPriorityText(item.urgent)}</span>
                        <span class="task-status ${statusClass}">${item.status}</span>
                        <span class="task-date">📅 ${formatDate(item.createdAt)}</span>
                      </div>
                    </div>
                  </div>
                  
                  ${(item.description || item.location) ? `
                    <div class="task-content">
                      ${item.description ? `<div class="task-description">${makeLinksClickable(escapeHtml(item.description))}</div>` : ''}
                      ${item.location ? `<div class="task-location">📍 ${makeLinksClickable(escapeHtml(item.location))}</div>` : ''}
                    </div>
                  ` : ''}
                  
                  ${(item.files && item.files.length > 0) ? `
                    <div class="task-attachments">
                      ${item.files.map(file => `
                        <a href="${file.data}" 
                           download="${file.name}" 
                           class="attachment-link" 
                           title="Télécharger ${file.name}">
                          <span class="attachment-icon">📄</span>
                          ${escapeHtml(file.name)}
                        </a>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
          
          <div class="footer">
            <p>📋 GlenTasks - ${now.getFullYear()}</p>
          </div>
        </body>
        </html>
      `;
    }
    
    // ============================================================================
    // APP STARTUP
    // ============================================================================
    
    // Initialize DOM elements
    function initializeDOMElements() {
      $passwordOverlay = document.getElementById('passwordOverlay');
      $passwordForm = document.getElementById('passwordForm');
      $passwordInput = document.getElementById('passwordInput');
      $appContainer = document.getElementById('appContainer');
      $cmvForm = document.getElementById('cmvForm');
      $taskList = document.getElementById('taskList');
      $tasksCount = document.getElementById('tasksCount');
      $filterSelect = document.getElementById('filterSelect');
      $sortSelect = document.getElementById('sortSelect');
      $employeeSelect = document.getElementById('employeeSelect');
      $exportCSV = document.getElementById('exportCSV');
      $generateReport = document.getElementById('generateReport');
      
      // Setup password form after DOM elements are available
      setupPasswordForm();
    }
    
    // Check authentication when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('GlenTasks app loaded');
      initializeDOMElements();
      checkAuthentication();
    });
    
    // Handle page visibility changes (for web applications)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        console.log('App became visible, refreshing data...');
        if (sessionStorage.getItem('glentasks_authenticated') === 'true') {
          loadTasks();
        }
      }
    });
    
    console.log('GlenTasks JavaScript loaded successfully');

    // ============================================================================
    // ERROR HANDLING AND BOUNDARIES
    // ============================================================================
    
    // Global error handler with user-friendly messages
    function handleGlobalError(error, context = '') {
      console.error(`Error in ${context}:`, error);
      
      // Don't show technical errors to users, show friendly messages
      let userMessage = 'Une erreur inattendue s\'est produite.';
      
      if (error.message.includes('localStorage')) {
        userMessage = 'Erreur de stockage. Vérifiez que votre navigateur supporte le stockage local.';
      } else if (error.message.includes('validation')) {
        userMessage = 'Données invalides. Vérifiez les informations saisies.';
      } else if (error.message.includes('network')) {
        userMessage = 'Erreur de connexion. Vérifiez votre connexion internet.';
      }
      
      showError(userMessage);
    }
    
    // Safe execution wrapper for async operations
    async function safeExecute(operation, context = '') {
      try {
        return await operation();
      } catch (error) {
        handleGlobalError(error, context);
        throw error;
      }
    }
    
    // Safe DOM manipulation
    function safeDOMUpdate(element, updateFunction) {
      try {
        if (element && element.parentNode) {
          updateFunction();
        } else {
          console.warn('Element not found for DOM update');
        }
      } catch (error) {
        handleGlobalError(error, 'DOM update');
      }
    }

    // ============================================================================
    // SECURITY AND INPUT SANITIZATION
    // ============================================================================
    
    // Note: sanitizeInput function removed to prevent double encoding
    // escapeHtml function provides sufficient XSS protection
    
    // Sanitize task data before processing
    function sanitizeTaskData(taskData) {
      return {
        ...taskData,
        title: taskData.title,
        description: taskData.description,
        location: taskData.location,
        who: Array.isArray(taskData.who) ? taskData.who : [],
        files: taskData.files || [] // Preserve files data
      };
    }

    // ============================================================================
    // LOADING STATES AND USER FEEDBACK
    // ============================================================================
    
    // Show loading state
    function showLoading(message = 'Chargement...') {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loadingOverlay';
      loadingDiv.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>${message}</p>
        </div>
      `;
      loadingDiv.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      document.body.appendChild(loadingDiv);
    }
    
    // Hide loading state
    function hideLoading() {
      const loadingDiv = document.getElementById('loadingOverlay');
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }
    
    // Show loading for specific operations
    async function withLoading(operation, loadingMessage = 'Chargement...') {
      showLoading(loadingMessage);
      try {
        const result = await operation();
        return result;
      } finally {
        hideLoading();
      }
    }

    // ============================================================================
    // PERFORMANCE OPTIMIZATIONS AND SEARCH
    // ============================================================================
    
    // Debounce function for search input
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Search functionality
    let searchQuery = '';
    let debouncedSearch = debounce(async (query) => {
      searchQuery = query;
      await loadTasks();
    }, 300);
    
    // Optimized task filtering with search
    function filterTasks(items) {
      if (!items || items.length === 0) return [];
      
      let filteredItems = items;
      
      // Apply search filter first (most restrictive)
      if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase().trim();
        filteredItems = items.filter(item => {
          return (
            (item.title && item.title.toLowerCase().includes(query)) ||
            (item.description && item.description.toLowerCase().includes(query)) ||
            (item.location && item.location.toLowerCase().includes(query)) ||
            (item.who && item.who.some(w => w.toLowerCase().includes(query)))
          );
        });
      }
      
      // Apply employee filter
      if (selectedEmployee) {
        filteredItems = filteredItems.filter(item => 
          item.who && item.who.includes(selectedEmployee)
        );
      }
      
      // Apply status filter
      switch (currentFilter) {
        case 'terminee':
          filteredItems = filteredItems.filter(item => item.status === "Terminée");
          break;
        case 'en-cours':
          filteredItems = filteredItems.filter(item => item.status === "En cours");
          break;
        case 'en-attente':
          filteredItems = filteredItems.filter(item => item.status === "En Attente");
          break;
        case 'unassigned':
          filteredItems = filteredItems.filter(item => !item.who || item.who.length === 0);
          break;
        default:
          // 'all' case - no additional filtering
          break;
      }
      
      return filteredItems;
    }
    
    // Optimized task sorting
    function sortTasks(items) {
      if (!items || items.length === 0) return items;
      
      console.log('Sorting tasks with currentSort:', currentSort);
      console.log('Items before sorting:', items.length);
      
      const sortedItems = items.sort((a, b) => {
        // First priority: Completed tasks always go to bottom
        if (a.status === "Terminée" && b.status !== "Terminée") return 1;
        if (b.status === "Terminée" && a.status !== "Terminée") return -1;
        
        // Second priority: Apply the selected sorting method
        let sortResult = 0;
        
        switch (currentSort) {
          case 'urgency':
            // Define priority order: Critical (Au PC !) > Urgent (Oui) > Normal (Non)
            const urgencyOrder = { 
              "Au PC !": 3, 
              "Oui": 2, 
              "Non": 1 
            };
            const urgencyA = urgencyOrder[a.urgent] || 0;
            const urgencyB = urgencyOrder[b.urgent] || 0;
            sortResult = urgencyB - urgencyA; // Higher priority first
            
            // If same priority, sort by creation date (newer first)
            if (sortResult === 0) {
              sortResult = new Date(b.createdAt) - new Date(a.createdAt);
            }
            
            console.log(`Comparing ${a.title} (${a.urgent}=${urgencyA}, ${a.status}) vs ${b.title} (${b.urgent}=${urgencyB}, ${b.status}) => ${sortResult}`);
            break;
            
          case 'created':
            sortResult = new Date(b.createdAt) - new Date(a.createdAt);
            break;
            
          case 'deadline':
            const today = new Date().setHours(0,0,0,0);
            const deadlineA = a.deadline ? new Date(a.deadline) : new Date('9999-12-31');
            const deadlineB = b.deadline ? new Date(b.deadline) : new Date('9999-12-31');
            
            // Overdue tasks first (but only among non-done tasks)
            const overdueA = deadlineA < today && a.status !== "Terminée";
            const overdueB = deadlineB < today && b.status !== "Terminée";
            if (overdueA !== overdueB) {
              sortResult = overdueB - overdueA;
            } else {
              sortResult = deadlineA - deadlineB;
            }
            break;
            
          default: // status
            const wa = STATUS_WEIGHT[a.status] ?? 0;
            const wb = STATUS_WEIGHT[b.status] ?? 0;
            sortResult = wa - wb;
        }
        
        return sortResult;
      });
      
      // Log the final sort order for debugging
      if (currentSort === 'urgency') {
        console.log('Final urgency sort order:');
        sortedItems.forEach((item, index) => {
          const priorityText = item.urgent === 'Au PC !' ? 'CRITICAL' : 
                              item.urgent === 'Oui' ? 'URGENT' : 'NORMAL';
          console.log(`${index + 1}. [${priorityText}] [${item.status}] ${item.title}`);
        });
      }
      
      return sortedItems;
    }

    // ============================================================================
    // SEARCH UTILITIES
    // ============================================================================
    
    // Clear search and reset to show all tasks
    function clearSearch() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.value = '';
        searchQuery = '';
        loadTasks();
      }
    }

    // ============================================================================
    // SKELETON LOADING STATES
    // ============================================================================
    
    // Show skeleton loading state
    function showSkeletonLoading() {
      const skeletonHTML = Array(3).fill(0).map(() => `
        <div class="task-card skeleton-card">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-description"></div>
          <div class="skeleton skeleton-meta"></div>
        </div>
      `).join('');
      
      $taskList.innerHTML = skeletonHTML;
    }
    
    // Hide skeleton loading
    function hideSkeletonLoading() {
      // Skeleton will be replaced when actual content loads
    }

    // ============================================================================
    // STATE MANAGEMENT SYSTEM
    // ============================================================================
    
    // Centralized app state
    const AppState = {
      // UI State
      ui: {
        isEditing: false,
        editId: null,
        isLoading: false,
        searchQuery: '',
        currentFilter: 'all',
        currentSort: 'status',
        selectedEmployee: '',
        showPasswordOverlay: true
      },
      
      // Data State
      data: {
        tasks: [],
        filteredTasks: [],
        sortedTasks: [],
        taskCount: 0,
        unassignedCount: 0
      },
      
      // Configuration
      config: {
        debounceDelay: 300,
        maxTitleLength: 200,
        maxDescriptionLength: 1000,
        itemsPerPage: 50
      },
      
      // Methods
      updateUI(updates) {
        Object.assign(this.ui, updates);
        this.notifyStateChange('ui', updates);
      },
      
      updateData(updates) {
        Object.assign(this.data, updates);
        this.notifyStateChange('data', updates);
      },
      
      // State change notifications
      listeners: new Map(),
      
      subscribe(event, callback) {
        if (!this.listeners.has(event)) {
          this.listeners.set(event, []);
        }
        this.listeners.get(event).push(callback);
      },
      
      notifyStateChange(type, changes) {
        const event = `${type}Changed`;
        if (this.listeners.has(event)) {
          this.listeners.get(event).forEach(callback => callback(changes));
        }
      }
    };
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    // Deep clone objects for immutable updates
    function deepClone(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (obj instanceof Date) return new Date(obj.getTime());
      if (obj instanceof Array) return obj.map(item => deepClone(item));
      if (typeof obj === 'object') {
        const clonedObj = {};
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            clonedObj[key] = deepClone(obj[key]);
          }
        }
        return clonedObj;
      }
    }
    
    // Safe JSON operations with error handling
    const SafeJSON = {
      parse: (str, fallback = []) => {
        try {
          return JSON.parse(str);
        } catch (error) {
          console.warn('JSON parse failed, using fallback:', error);
          return fallback;
        }
      },
      
      stringify: (obj, fallback = '[]') => {
        try {
          return JSON.stringify(obj);
        } catch (error) {
          console.warn('JSON stringify failed, using fallback:', error);
          return fallback;
        }
      }
    };

    // ============================================================================
    // ERROR LOGGING AND MONITORING
    // ============================================================================
    
    // Enhanced error logging system
    const ErrorLogger = {
      logs: [],
      maxLogs: 100,
      
      // Log levels
      levels: {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3,
        CRITICAL: 4
      },
      
      // Current log level
      currentLevel: 1, // INFO and above
      
      log(level, message, context = {}, error = null) {
        if (level < this.currentLevel) return;
        
        const logEntry = {
          timestamp: new Date().toISOString(),
          level: Object.keys(this.levels)[level],
          message,
          context,
          error: error ? {
            name: error.name,
            message: error.message,
            stack: error.stack
          } : null,
          userAgent: navigator.userAgent,
          url: window.location.href
        };
        
        this.logs.push(logEntry);
        
        // Keep only the last maxLogs entries
        if (this.logs.length > this.maxLogs) {
          this.logs.shift();
        }
        
        // Console output
        const consoleMethod = level === 0 ? 'debug' : 
                             level === 1 ? 'info' : 
                             level === 2 ? 'warn' : 
                             level === 3 ? 'error' : 'error';
        
        console[consoleMethod](`[${logEntry.level}] ${message}`, context, error);
        
        // Store in localStorage for persistence
        this.persistLogs();
      },
      
      debug(message, context = {}) {
        this.log(this.levels.DEBUG, message, context);
      },
      
      info(message, context = {}) {
        this.log(this.levels.INFO, message, context);
      },
      
      warn(message, context = {}, error = null) {
        this.log(this.levels.WARN, message, context, error);
      },
      
      error(message, context = {}, error = null) {
        this.log(this.levels.ERROR, message, context, error);
      },
      
      critical(message, context = {}, error = null) {
        this.log(this.levels.CRITICAL, message, context, error);
      },
      
      // Get logs for debugging
      getLogs(level = null) {
        if (level !== null) {
          return this.logs.filter(log => log.level === Object.keys(this.levels)[level]);
        }
        return this.logs;
      },
      
      // Clear logs
      clearLogs() {
        this.logs = [];
        this.persistLogs();
      },
      
      // Export logs
      exportLogs() {
        return JSON.stringify(this.logs, null, 2);
      },
      
      // Persist logs to localStorage
      persistLogs() {
        try {
          localStorage.setItem('glentasks_error_logs', this.exportLogs());
        } catch (error) {
          console.warn('Failed to persist error logs:', error);
        }
      },
      
      // Load logs from localStorage
      loadLogs() {
        try {
          const savedLogs = localStorage.getItem('glentasks_error_logs');
          if (savedLogs) {
            this.logs = SafeJSON.parse(savedLogs, []);
          }
        } catch (error) {
          console.warn('Failed to load error logs:', error);
        }
      }
    };
    
    // Initialize error logger
    ErrorLogger.loadLogs();
    
    // ============================================================================
    // PERFORMANCE MONITORING
    // ============================================================================
    
    // Performance monitoring system
    const PerformanceMonitor = {
      metrics: {
        renderTimes: [],
        filterTimes: [],
        sortTimes: [],
        storageTimes: [],
        apiCalls: []
      },
      
      maxMetrics: 50,
      
      // Start timing an operation
      startTimer(operation) {
        return {
          operation,
          startTime: performance.now()
        };
      },
      
      // End timing and record metric
      endTimer(timer) {
        const duration = performance.now() - timer.startTime;
        this.recordMetric(timer.operation, duration);
        return duration;
      },
      
      // Record a performance metric
      recordMetric(operation, duration) {
        if (!this.metrics[operation]) {
          this.metrics[operation] = [];
        }
        
        this.metrics[operation].push({
          timestamp: Date.now(),
          duration,
          operation
        });
        
        // Keep only the last maxMetrics entries
        if (this.metrics[operation].length > this.maxMetrics) {
          this.metrics[operation].shift();
        }
        
        // Log slow operations
        if (duration > 100) { // 100ms threshold
          ErrorLogger.warn(`Slow operation detected: ${operation} took ${duration.toFixed(2)}ms`);
        }
      },
      
      // Get performance statistics
      getStats(operation = null) {
        if (operation) {
          const times = this.metrics[operation];
          if (!times || times.length === 0) return null;
          
          const durations = times.map(t => t.duration);
          return {
            count: times.length,
            average: durations.reduce((a, b) => a + b, 0) / durations.length,
            min: Math.min(...durations),
            max: Math.max(...durations),
            recent: times.slice(-10).map(t => ({ timestamp: t.timestamp, duration: t.duration }))
          };
        }
        
        // Return all stats
        const allStats = {};
        for (const [key, times] of Object.entries(this.metrics)) {
          if (times.length > 0) {
            const durations = times.map(t => t.duration);
            allStats[key] = {
              count: times.length,
              average: durations.reduce((a, b) => a + b, 0) / durations.length,
              min: Math.min(...durations),
              max: Math.max(...durations),
              recent: times.slice(-10).map(t => ({ timestamp: t.timestamp, duration: t.duration }))
            };
          }
        }
        return allStats;
      },
      
      // Clear performance metrics
      clearMetrics() {
        for (const key in this.metrics) {
          this.metrics[key] = [];
        }
      },
      
      // Export performance data
      exportMetrics() {
        return JSON.stringify(this.metrics, null, 2);
      }
    };
    
    // Performance wrapper for functions
    function withPerformanceMonitoring(fn, operationName) {
      return async function(...args) {
        const timer = PerformanceMonitor.startTimer(operationName);
        try {
          const result = await fn.apply(this, args);
          return result;
        } finally {
          PerformanceMonitor.endTimer(timer);
        }
      };
    }
    
    // ============================================================================
    // DEBUGGING AND DEVELOPMENT TOOLS
    // ============================================================================
    
    // Debug panel for developers
    const DebugPanel = {
      isVisible: false,
      
      // Initialize debug panel
      init() {
        this.createDebugButton();
        this.createDebugPanel();
        this.bindEvents();
      },
      
      // Create debug button
      createDebugButton() {
        const debugBtn = document.createElement('button');
        debugBtn.id = 'debugBtn';
        debugBtn.innerHTML = '🐛 Debug';
        debugBtn.className = 'btn btn-secondary';
        debugBtn.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 10001;
          opacity: 0.7;
        `;
        
        document.body.appendChild(debugBtn);
      },
      
      // Create debug panel
      createDebugPanel() {
        const panel = document.createElement('div');
        panel.id = 'debugPanel';
        panel.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80%;
          max-width: 800px;
          max-height: 80vh;
          background: white;
          border: 2px solid var(--primary);
          border-radius: var(--radius-lg);
          padding: var(--space-6);
          z-index: 10002;
          display: none;
          overflow-y: auto;
          box-shadow: var(--shadow-xl);
        `;
        
        panel.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
            <h3>🐛 Debug Panel</h3>
            <button id="closeDebugPanel" class="btn btn-danger btn-sm">❌ Fermer</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
            <div>
              <h4>📊 Performance</h4>
              <div id="performanceStats"></div>
              <button id="clearMetrics" class="btn btn-secondary btn-sm" style="margin-top: var(--space-2);">
                Effacer métriques
              </button>
            </div>
            
            <div>
              <h4>🚨 Erreurs</h4>
              <div id="errorLogs"></div>
              <button id="clearLogs" class="btn btn-secondary btn-sm" style="margin-top: var(--space-2);">
                Effacer logs
              </button>
            </div>
          </div>
          
          <div style="margin-top: var(--space-4);">
            <h4>🔧 Actions</h4>
            <div style="display: flex; gap: var(--space-2); flex-wrap;">
              <button id="exportLogs" class="btn btn-primary btn-sm">📥 Exporter Logs</button>
              <button id="exportMetrics" class="btn btn-primary btn-sm">📊 Exporter Métriques</button>
              <button id="testError" class="btn btn-warning btn-sm">🧪 Tester Erreur</button>
              <button id="clearStorage" class="btn btn-danger btn-sm">🗑️ Effacer Stockage</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(panel);
      },
      
      // Bind debug panel events
      bindEvents() {
        const debugBtn = document.getElementById('debugBtn');
        const debugPanel = document.getElementById('debugPanel');
        const closeBtn = document.getElementById('closeDebugPanel');
        
        debugBtn.addEventListener('click', () => this.toggle());
        closeBtn.addEventListener('click', () => this.hide());
        
        // Performance metrics
        document.getElementById('clearMetrics').addEventListener('click', () => {
          PerformanceMonitor.clearMetrics();
          this.updatePerformanceStats();
        });
        
        // Error logs
        document.getElementById('clearLogs').addEventListener('click', () => {
          ErrorLogger.clearLogs();
          this.updateErrorLogs();
        });
        
        // Export functions
        document.getElementById('exportLogs').addEventListener('click', () => {
          this.exportData('logs', ErrorLogger.exportLogs());
        });
        
        document.getElementById('exportMetrics').addEventListener('click', () => {
          this.exportData('metrics', PerformanceMonitor.exportMetrics());
        });
        
        // Test functions
        document.getElementById('testError').addEventListener('click', () => {
          ErrorLogger.warn('Test warning message', { test: true });
          this.updateErrorLogs();
        });
        
        document.getElementById('clearStorage').addEventListener('click', () => {
          if (confirm('Êtes-vous sûr de vouloir effacer tout le stockage ?')) {
            localStorage.clear();
            location.reload();
          }
        });
      },
      
      // Toggle debug panel
      toggle() {
        if (this.isVisible) {
          this.hide();
        } else {
          this.show();
        }
      },
      
      // Show debug panel
      show() {
        const panel = document.getElementById('debugPanel');
        panel.style.display = 'block';
        this.isVisible = true;
        this.updatePerformanceStats();
        this.updateErrorLogs();
      },
      
      // Hide debug panel
      hide() {
        const panel = document.getElementById('debugPanel');
        panel.style.display = 'none';
        this.isVisible = false;
      },
      
      // Update performance statistics
      updatePerformanceStats() {
        const stats = PerformanceMonitor.getStats();
        const container = document.getElementById('performanceStats');
        
        if (!stats || Object.keys(stats).length === 0) {
          container.innerHTML = '<p>Aucune métrique disponible</p>';
          return;
        }
        
        const html = Object.entries(stats).map(([operation, data]) => `
          <div style="margin-bottom: var(--space-2); padding: var(--space-2); background: var(--gray-100); border-radius: var(--radius);">
            <strong>${operation}:</strong><br>
            Moyenne: ${data.average.toFixed(2)}ms<br>
            Min: ${data.min.toFixed(2)}ms, Max: ${data.max.toFixed(2)}ms<br>
            Total: ${data.count} opérations
          </div>
        `).join('');
        
        container.innerHTML = html;
      },
      
      // Update error logs
      updateErrorLogs() {
        const logs = ErrorLogger.getLogs();
        const container = document.getElementById('errorLogs');
        
        if (!logs || logs.length === 0) {
          container.innerHTML = '<p>Aucune erreur enregistrée</p>';
          return;
        }
        
        const html = logs.slice(-10).reverse().map(log => `
          <div style="margin-bottom: var(--space-2); padding: var(--space-2); background: var(--gray-100); border-radius: var(--radius); font-size: 0.8rem;">
            <strong>[${log.level}]</strong> ${log.message}<br>
            <small>${new Date(log.timestamp).toLocaleString()}</small>
          </div>
        `).join('');
        
        container.innerHTML = html;
      },
      
      // Export data
      exportData(type, data) {
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `glentasks_${type}_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
      }
    };
    
    // Initialize debug panel in development mode
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      document.addEventListener('DOMContentLoaded', () => {
        DebugPanel.init();
      });
    }

    // ============================================================================
    // UNIT TESTING FRAMEWORK
    // ============================================================================
    
    // Simple unit testing framework
    const TestRunner = {
      tests: [],
      passed: 0,
      failed: 0,
      
      // Add a test
      test(name, testFunction) {
        this.tests.push({ name, testFunction });
      },
      
      // Assertion functions
      assert(condition, message) {
        if (!condition) {
          throw new Error(`Assertion failed: ${message}`);
        }
      },
      
      assertEquals(expected, actual, message = '') {
        if (expected !== actual) {
          throw new Error(`Expected ${expected}, but got ${actual}. ${message}`);
        }
      },
      
      assertArrayEquals(expected, actual, message = '') {
        if (expected.length !== actual.length) {
          throw new Error(`Expected array length ${expected.length}, but got ${actual.length}. ${message}`);
        }
        for (let i = 0; i < expected.length; i++) {
          if (expected[i] !== actual[i]) {
            throw new Error(`Expected ${expected[i]} at index ${i}, but got ${actual[i]}. ${message}`);
          }
        }
      },
      
      // Run all tests
      async runAll() {
        console.log('🧪 Running unit tests...');
        this.passed = 0;
        this.failed = 0;
        
        for (const test of this.tests) {
          try {
            await test.testFunction();
            console.log(`✅ PASS: ${test.name}`);
            this.passed++;
          } catch (error) {
            console.error(`❌ FAIL: ${test.name} - ${error.message}`);
            this.failed++;
          }
        }
        
        console.log(`\n📊 Test Results: ${this.passed} passed, ${this.failed} failed`);
        return { passed: this.passed, failed: this.failed };
      },
      
      // Run specific test
      async runTest(testName) {
        const test = this.tests.find(t => t.name === testName);
        if (!test) {
          throw new Error(`Test "${testName}" not found`);
        }
        
        try {
          await test.testFunction();
          console.log(`✅ PASS: ${test.name}`);
          return true;
        } catch (error) {
          console.error(`❌ FAIL: ${test.name} - ${error.message}`);
          return false;
        }
      }
    };
    
    // Add tests for critical functions
    TestRunner.test('Data Validation', async () => {
      // Test title validation
      const validTitle = 'Valid task title';
      const invalidTitle = '';
      
      TestRunner.assertEquals(0, validateTaskData({ title: validTitle }).length, 'Valid title should pass validation');
      TestRunner.assert(validateTaskData({ title: invalidTitle }).length > 0, 'Invalid title should fail validation');
      
      // Test description length validation
      const longDescription = 'a'.repeat(1001);
      TestRunner.assert(validateTaskData({ title: 'Test', description: longDescription }).length > 0, 'Long description should fail validation');
    });
    
    TestRunner.test('Data Normalization', async () => {
      const rawData = {
        title: 'Test Task',
        description: 'Test Description'
      };
      
      const normalized = normalizeTaskData(rawData);
      
      TestRunner.assert(normalized.id, 'Normalized data should have an ID');
      TestRunner.assertEquals('Test Task', normalized.title, 'Title should be preserved');
      TestRunner.assertEquals('Test Description', normalized.description, 'Description should be preserved');
      TestRunner.assertEquals('En cours', normalized.status, 'Default status should be set');
      TestRunner.assertEquals('Non', normalized.urgent, 'Default priority should be set');
      TestRunner.assert(Array.isArray(normalized.who), 'Who should be an array');
    });
    
    TestRunner.test('Task Filtering', async () => {
      const testTasks = [
        { title: 'Task 1', status: 'En cours', who: ['Éric'] },
        { title: 'Task 2', status: 'Terminée', who: ['Fred'] },
        { title: 'Task 3', status: 'En cours', who: [] }
      ];
      
      // Test status filtering
      const pendingTasks = filterTasks(testTasks);
      TestRunner.assertEquals(2, pendingTasks.length, 'Should filter to pending tasks only');
      
      // Test employee filtering
      const ericTasks = filterTasks(testTasks.filter(t => t.who.includes('Éric')));
      TestRunner.assertEquals(1, ericTasks.length, 'Should filter to Éric tasks only');
    });
    
    TestRunner.test('Task Sorting', async () => {
      const testTasks = [
        { title: 'Task 1', status: 'Terminée', urgent: 'Non' },
        { title: 'Task 2', status: 'En cours', urgent: 'Oui' },
        { title: 'Task 3', status: 'En cours', urgent: 'Non' }
      ];
      
      const sorted = sortTasks(testTasks);
      
      // Completed tasks should be at the bottom
      TestRunner.assertEquals('En cours', sorted[0].status, 'First task should be pending');
      TestRunner.assertEquals('Terminée', sorted[sorted.length - 1].status, 'Last task should be completed');
    });
    
    TestRunner.test('Input Sanitization', async () => {
      // Test that escapeHtml function properly handles text without double encoding
      const testInput = 'test "quotes" and <tags>';
      const escaped = escapeHtml(testInput);
      
      TestRunner.assert(escaped === testInput, 'Text should be preserved without double encoding');
      TestRunner.assert(!escaped.includes('&amp;'), 'No double encoding should occur');
    });
    
    // Run tests automatically in development mode
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      document.addEventListener('DOMContentLoaded', async () => {
        // Wait a bit for app to initialize
        setTimeout(async () => {
          console.log('🧪 Running automated tests...');
          await TestRunner.runAll();
        }, 2000);
      });
    }

    // ============================================================================
    // DROPDOWN MENAGEMENT
    // ============================================================================
    
    // Toggle dropdown menu
    function toggleDropdown(taskId) {
      const dropdown = document.getElementById(`dropdown-${taskId}`);
      const allDropdowns = document.querySelectorAll('.dropdown-menu');
      
      // Close all other dropdowns
      allDropdowns.forEach(dd => {
        if (dd.id !== `dropdown-${taskId}`) {
          dd.classList.remove('show');
        }
      });
      
      // Toggle current dropdown
      dropdown.classList.toggle('show');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.task-actions')) {
        const allDropdowns = document.querySelectorAll('.dropdown-menu');
        allDropdowns.forEach(dd => dd.classList.remove('show'));
      }
    });
    
    // Close dropdown when pressing Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const allDropdowns = document.querySelectorAll('.dropdown-menu');
        allDropdowns.forEach(dd => dd.classList.remove('show'));
      }
    });
  </script>
</body>
</html>